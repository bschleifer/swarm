{% extends "base.html" %}
{% block title %}Swarm's Bee Hive — Dashboard{% endblock %}

{% block body %}
<header>
    <h1><img src="/bee-icon.svg" alt="" style="height:1.4em;vertical-align:middle;margin-right:0.3rem;"><span class="ws-indicator" id="ws-dot"></span> Swarm's Bee Hive <span id="header-clock" style="color:var(--muted);font-size:0.8rem;font-weight:normal;margin-left:0.75rem;"></span></h1>
    <div style="display: flex; align-items: center; gap: 0.75rem;">
        <div class="status" id="status-bar">
            {{ worker_count }} workers
        </div>
        <button class="btn {{ 'btn-active' if drones_enabled else 'btn-secondary' }}" id="drones-btn"
                onclick="toggleDrones()">
            Drones: {{ 'ON' if drones_enabled else 'OFF' }}
        </button>
        <button class="btn btn-secondary" onclick="showLaunch()">Launch</button>
        <a href="/config" class="btn btn-secondary" style="text-decoration:none;">Config</a>
        <button class="btn btn-secondary" onclick="attachTerminal()" title="Attach to tmux session in browser">Attach</button>
        <button class="btn" onclick="askQueen()" id="queen-btn" title="Ask Queen to analyze the hive" style="background:var(--lavender);color:var(--hive-bg);">Ask Queen</button>
        <button class="btn btn-secondary" id="notif-perm-btn" onclick="requestNotifPermission()" title="Enable browser notifications" style="font-size:0.9rem;padding:0.4rem 0.6rem;">&#x1f514;</button>
        <button class="btn btn-danger" onclick="killSession()" title="Shutdown — kill tmux session and all workers">Shutdown</button>
    </div>
</header>

<div class="dashboard">
    <!-- Worker sidebar -->
    <div class="panel worker-list">
        <div class="panel-header">Workers</div>
        <div class="panel-body" id="worker-list">
            {% include "partials/worker_list.html" %}
        </div>
        <div class="action-bar">
            <button class="btn btn-secondary" onclick="continueAll()">Continue All</button>
            <button class="btn btn-secondary" onclick="showBroadcast()">Broadcast</button>
        </div>
    </div>

    <!-- Detail area -->
    <div class="detail-area">
        <div class="panel">
            <div class="panel-header" id="detail-title">Select a worker</div>
            <div class="panel-body" id="detail-body">
                <p style="color: var(--muted); padding: 1rem;">Click a worker to see details</p>
            </div>
            <!-- Action bar (shown when a worker is selected) -->
            <div class="action-bar" id="terminal-actions" style="display: none;">
                <button type="button" class="btn btn-secondary" onclick="reviveWorker()">Revive</button>
                <button type="button" class="btn btn-secondary" onclick="refreshInlineTerminal()">Refresh</button>
                <button type="button" class="btn" onclick="askQueenWorker()" style="background:var(--lavender);color:var(--hive-bg);">Ask Queen</button>
                <button type="button" class="btn btn-danger" onclick="killWorker()">Kill</button>
            </div>
        </div>

        <!-- Drag handle -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- Bottom tabbed panel -->
        <div class="panel bottom-tabbed">
            <div class="panel-header" style="gap:0;">
                <div style="display:flex;gap:0;">
                    <button class="tab-btn active" id="tab-tasks-btn" onclick="switchTab('tasks')">
                        Tasks <span id="task-summary" style="font-weight:normal;font-size:0.7rem;color:var(--muted);margin-left:0.4rem;">{{ task_summary }}</span>
                    </button>
                    <button class="tab-btn" id="tab-drones-btn" onclick="switchTab('drones')">Drone Log</button>
                    <button class="tab-btn" id="tab-notifications-btn" onclick="switchTab('notifications')">
                        Notifications <span id="notif-badge" class="notification-badge" style="display:none;">0</span>
                    </button>
                </div>
                <span style="display:flex;align-items:center;gap:0.5rem;">
                    <button class="btn btn-sm" onclick="showCreateTask()">+ New Task</button>
                </span>
            </div>
            <!-- Tasks tab -->
            <div class="tab-content active" id="tab-tasks">
                <div class="filter-bar" id="task-filters">
                    <button class="filter-chip active" data-filter="all" onclick="switchTaskFilter('all')">All</button>
                    <button class="filter-chip" data-filter="pending" onclick="switchTaskFilter('pending')">Pending</button>
                    <button class="filter-chip" data-filter="assigned" onclick="switchTaskFilter('assigned')">Active</button>
                    <button class="filter-chip" data-filter="completed" onclick="switchTaskFilter('completed')">Done</button>
                    <button class="filter-chip" data-filter="failed" onclick="switchTaskFilter('failed')">Failed</button>
                </div>
                <div class="panel-body" id="task-list">
                    {% include "partials/task_list.html" %}
                </div>
            </div>
            <!-- Drone Log tab -->
            <div class="tab-content" id="tab-drones">
                <div class="panel-body" id="drone-log">
                    {% include "partials/drone_log.html" %}
                </div>
            </div>
            <!-- Notifications tab -->
            <div class="tab-content" id="tab-notifications">
                <div class="panel-body" id="notification-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Shortcut bar — matches TUI keys.py visible bindings -->
<div class="shortcut-bar">
    <span><span class="sc-key">Alt+B</span> <span class="sc-label">Drones</span></span>
    <span><span class="sc-key">Alt+A</span> <span class="sc-label">Continue All</span></span>
    <span><span class="sc-key">Alt+K</span> <span class="sc-label">Kill</span></span>
    <span><span class="sc-key">Alt+R</span> <span class="sc-label">Revive</span></span>
    <span><span class="sc-key">Alt+T</span> <span class="sc-label">Attach</span></span>
    <span><span class="sc-key">Alt+Q</span> <span class="sc-label">Queen</span></span>
    <span><span class="sc-key">Alt+N</span> <span class="sc-label">New Task</span></span>
    <span><span class="sc-key">Alt+X</span> <span class="sc-label">Quit</span></span>
</div>

<!-- Broadcast modal (hidden) -->
<div id="broadcast-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)hideBroadcast()">
    <div class="modal-box">
        <div class="panel-header">Broadcast Message</div>
        <div style="padding:1rem;">
            <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Target</label>
            <select id="broadcast-target"
                    style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem;font-family:inherit;font-size:0.85rem;margin-bottom:0.75rem;">
                <option value="__all__">All Workers</option>
                {% for g in groups %}
                <option value="group:{{ g.name }}">Group: {{ g.name }}</option>
                {% endfor %}
            </select>
            <textarea id="broadcast-input" placeholder="Message to send..." rows="4"
                      style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.5rem;font-family:inherit;font-size:0.85rem;resize:vertical;"></textarea>
            <div style="display:flex;gap:0.5rem;margin-top:0.75rem;justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="hideBroadcast()">Cancel</button>
                <button class="btn" onclick="sendBroadcast()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Queen control modal (hidden) -->
<div id="queen-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)hideQueen()">
    <div class="modal-box" style="max-width:650px;">
        <div class="panel-header" style="background:var(--lavender);color:var(--hive-bg);">
            <span>Queen — Hive Conductor</span>
            <button class="btn btn-sm" style="background:var(--hive-bg);color:var(--lavender);" onclick="hideQueen()">Close</button>
        </div>
        <div id="queen-result" style="padding:1rem;max-height:60vh;overflow-y:auto;">
            <p style="color:var(--muted);">Analyzing hive...</p>
        </div>
        <div style="padding:0.75rem;border-top:1px solid var(--border);display:flex;gap:0.5rem;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="askQueen()" id="queen-refresh-btn">Re-analyze</button>
            <button class="btn" id="queen-apply-btn" style="display:none;" onclick="applyDirectives()">Apply All Directives</button>
        </div>
    </div>
</div>
<!-- Launch modal (hidden) -->
<div id="launch-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)hideLaunch()">
    <div class="modal-box" style="max-width:550px;">
        <div class="panel-header">
            <span>Launch Brood</span>
            <button class="btn btn-sm btn-secondary" onclick="hideLaunch()">Close</button>
        </div>
        <div id="launch-body" style="padding:1rem;">
            <p style="color:var(--muted);">Loading config...</p>
        </div>
        <div style="padding:0.75rem;border-top:1px solid var(--border);display:flex;gap:0.5rem;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="launchSelected()">Launch Selected</button>
            <button class="btn" onclick="launchAll()">Launch All</button>
        </div>
    </div>
</div>
<!-- Spawn worker modal (hidden) -->
<div id="spawn-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)hideSpawn()">
    <div class="modal-box" style="max-width:450px;">
        <div class="panel-header">
            <span>Spawn Worker</span>
            <button class="btn btn-sm btn-secondary" onclick="hideSpawn()">Close</button>
        </div>
        <div style="padding:1rem;">
            <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Worker Name</label>
            <input id="spawn-name" type="text" placeholder="e.g. worker-4"
                   style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem 0.5rem;font-family:inherit;font-size:0.85rem;margin-bottom:0.75rem;">
            <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Project Path</label>
            <input id="spawn-path" type="text" placeholder="/home/user/project"
                   style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem 0.5rem;font-family:inherit;font-size:0.85rem;margin-bottom:0.5rem;">
            <div id="spawn-presets" style="margin-bottom:0.75rem;"></div>
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="hideSpawn()">Cancel</button>
                <button class="btn" onclick="doSpawn()">Spawn</button>
            </div>
        </div>
    </div>
</div>
<!-- Unified Task modal — used for both Create and Edit -->
<div id="task-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeTaskModal()">
    <div class="modal-box" style="max-width:550px;">
        <div class="panel-header" id="task-modal-header" style="background:var(--lavender);color:var(--hive-bg);">
            <span id="task-modal-title">New Task</span>
            <button class="btn btn-sm" style="background:var(--hive-bg);color:var(--lavender);" onclick="closeTaskModal()">Close</button>
        </div>
        <div style="padding:1rem;">
            <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Title</label>
            <input id="tm-title" type="text" placeholder="Task title..."
                   style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem 0.5rem;font-family:inherit;font-size:0.85rem;margin-bottom:0.75rem;">
            <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Description</label>
            <textarea id="tm-desc" placeholder="Description (optional)..." rows="3"
                      style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem 0.5rem;font-family:inherit;font-size:0.85rem;resize:vertical;margin-bottom:0.75rem;"></textarea>
            <div style="display:flex;gap:0.75rem;margin-bottom:0.75rem;">
                <div>
                    <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Priority</label>
                    <select id="tm-priority"
                            style="background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem;font-family:inherit;font-size:0.85rem;">
                        <option value="normal">Normal</option>
                        <option value="low">Low</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div id="tm-tags-row" style="flex:1;">
                    <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Tags (comma-separated)</label>
                    <input id="tm-tags" type="text"
                           style="width:100%;background:var(--hive-bg);color:var(--beeswax);border:1px solid var(--border);border-radius:4px;padding:0.4rem 0.5rem;font-family:inherit;font-size:0.85rem;">
                </div>
            </div>
            <label style="color:var(--muted);font-size:0.8rem;display:block;margin-bottom:0.4rem;">Attachments</label>
            <div id="tm-dropzone"
                 style="border:2px dashed var(--border);border-radius:6px;padding:1rem;text-align:center;color:var(--muted);font-size:0.85rem;margin-bottom:0.75rem;cursor:pointer;transition:border-color 0.2s;">
                Drop image here or click to browse
                <input type="file" id="tm-file" style="display:none;" accept="image/*">
            </div>
            <div id="tm-attachments" style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.75rem;"></div>
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="btn" id="tm-submit-btn" onclick="submitTaskModal()">Create</button>
            </div>
        </div>
    </div>
</div>
<!-- Shutdown dialog modal (hidden) -->
<div id="shutdown-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)hideShutdown()">
    <div class="modal-box" style="max-width:400px;">
        <div class="panel-header" style="background:var(--poppy);color:var(--hive-bg);">
            <span>Shutdown</span>
            <button class="btn btn-sm" style="background:var(--hive-bg);color:var(--poppy);" onclick="hideShutdown()">Close</button>
        </div>
        <div style="padding:1.5rem;text-align:center;">
            <p style="color:var(--beeswax);margin-bottom:1.5rem;">What would you like to do?</p>
            <div style="display:flex;flex-direction:column;gap:0.75rem;">
                <button class="btn btn-secondary" onclick="doStopServer()" style="padding:0.75rem;">Stop Web App</button>
                <button class="btn btn-danger" onclick="doKillEverything()" style="padding:0.75rem;">Kill Everything</button>
            </div>
        </div>
    </div>
</div>
<!-- Terminal modal (hidden) -->
<div id="terminal-modal" class="modal-overlay" style="display:none;z-index:950;">
    <div style="width:95vw;height:92vh;background:var(--hive-bg);border:2px solid var(--honey);border-radius:6px;display:flex;flex-direction:column;overflow:hidden;">
        <div class="panel-header" style="flex-shrink:0;">
            <span id="terminal-title">Terminal</span>
            <span style="display:flex;align-items:center;gap:0.75rem;">
                <span id="terminal-status" style="font-size:0.75rem;color:var(--muted);">connecting...</span>
                <button class="btn btn-sm btn-secondary" onclick="closeTerminal()">Close</button>
            </span>
        </div>
        <div id="terminal-container" style="flex:1;padding:4px;overflow:hidden;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js" defer></script>
<script>
(function() {
    let selectedWorker = null;
    let selectedWorkerPaneId = null;
    let ws = null;
    let reconnectTimer = null;
    let prevWorkerStates = {}; // track states for STUNG detection

    // Inline terminal state (worker detail pane)
    let inlineTerm = null;
    let inlineTermWs = null;
    let inlineFitAddon = null;
    let inlineTermPaneId = null;

    function wsToken() {
        return sessionStorage.getItem('swarm_api_password') || '';
    }

    function wsUrl(path) {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        let url = proto + '//' + location.host + path;
        const tok = wsToken();
        if (tok) url += (url.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(tok);
        return url;
    }

    // --- WebSocket ---
    function connect() {
        ws = new WebSocket(wsUrl('/ws'));

        ws.onopen = function() {
            document.getElementById('ws-dot').classList.add('connected');
            if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
        };

        ws.onclose = function() {
            document.getElementById('ws-dot').classList.remove('connected');
            reconnectTimer = setTimeout(connect, 3000);
        };

        ws.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                handleEvent(data);
            } catch(err) {}
        };
    }

    function handleEvent(data) {
        switch(data.type) {
            case 'init':
            case 'state':
            case 'workers_changed':
                // Detect workers that just went STUNG
                if (data.workers) {
                    data.workers.forEach(function(w) {
                        if (w.state === 'STUNG' && prevWorkerStates[w.name] && prevWorkerStates[w.name] !== 'STUNG') {
                            notifyBrowser('Worker Down', w.name + ' exited (STUNG)');
                        }
                        prevWorkerStates[w.name] = w.state;
                    });
                }
                refreshWorkers();
                refreshStatus();
                if (selectedWorker) refreshDetail();
                break;
            case 'drones':
                refreshDroneLog();
                refreshWorkers();
                break;
            case 'drones_toggled':
                updateDronesButton(data.enabled);
                refreshStatus();
                break;
            case 'escalation':
                showToast(data.worker + ' escalated: ' + data.reason, true);
                notifyBrowser('Escalation', data.worker + ': ' + data.reason);
                refreshWorkers();
                refreshDroneLog();
                break;
            case 'task_assigned':
            case 'task_created':
            case 'task_completed':
                if (data.task) showToast('Task "' + data.task.title + '" ' + data.type.replace('task_', ''));
                refreshTasks();
                break;
            case 'task_removed':
                showToast('Task removed');
                refreshTasks();
                break;
            case 'task_failed':
                showToast('Task marked as failed', true);
                notifyBrowser('Task Failed', data.task ? data.task.title : 'A task was marked as failed');
                refreshTasks();
                break;
            case 'tasks_changed':
                refreshTasks();
                break;
            case 'config_changed':
            case 'config_file_changed':
                showToast('Config reloaded');
                refreshWorkers();
                refreshStatus();
                break;
        }
    }

    // --- HTMX partial fetchers ---
    function refreshWorkers() {
        htmx.ajax('GET', '/partials/workers' + (selectedWorker ? '?worker=' + selectedWorker : ''), '#worker-list');
    }

    function refreshStatus() {
        htmx.ajax('GET', '/partials/status', '#status-bar');
    }

    let activeTaskFilter = 'all';

    function refreshTasks() {
        let url = '/partials/tasks';
        const params = [];
        if (activeTaskFilter !== 'all') params.push('status=' + activeTaskFilter);
        if (selectedWorker) params.push('worker=' + encodeURIComponent(selectedWorker));
        if (params.length) url += '?' + params.join('&');
        htmx.ajax('GET', url, '#task-list');
    }

    function refreshDroneLog() {
        htmx.ajax('GET', '/partials/drones', '#drone-log');
    }

    function refreshDetailStatic() {
        if (!selectedWorker) return;
        htmx.ajax('GET', '/partials/detail/' + selectedWorker, '#detail-body');
    }

    window.refreshDetail = function() {
        if (!selectedWorker) return;
        // When inline terminal is live, skip static refresh — it's already live
        if (inlineTerm) return;
        refreshDetailStatic();
    }

    // --- Inline terminal (embedded in detail panel) ---
    function attachInlineTerminal(paneId) {
        // Skip if already attached to the same pane
        if (inlineTerm && inlineTermPaneId === paneId) return;
        // Tear down any existing inline terminal first
        detachInlineTerminal();

        // Fall back to static if xterm CDN hasn't loaded yet
        if (typeof Terminal === 'undefined') {
            refreshDetailStatic();
            return;
        }

        inlineTermPaneId = paneId;
        var body = document.getElementById('detail-body');
        body.innerHTML = '<div id="inline-terminal"></div>';
        body.style.padding = '0';
        body.style.overflow = 'hidden';

        inlineTerm = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
            theme: {
                background: '#2A1B0E',
                foreground: '#E6D2B5',
                cursor: '#D8A03D',
                selectionBackground: 'rgba(216,160,61,0.3)',
                black: '#2A1B0E',
                red: '#D15D4C',
                green: '#8CB369',
                yellow: '#D8A03D',
                blue: '#A88FD9',
                magenta: '#A88FD9',
                cyan: '#7EC8C8',
                white: '#E6D2B5',
            }
        });

        inlineFitAddon = new FitAddon.FitAddon();
        inlineTerm.loadAddon(inlineFitAddon);
        inlineTerm.open(document.getElementById('inline-terminal'));

        // Enable drag-and-drop on the terminal (upload file, paste path)
        var termEl = document.getElementById('inline-terminal');
        termEl.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            termEl.style.outline = '2px solid var(--honey)';
        });
        termEl.addEventListener('dragleave', function() {
            termEl.style.outline = '';
        });
        termEl.addEventListener('drop', function(e) {
            e.preventDefault();
            termEl.style.outline = '';
            if (e.dataTransfer.files.length > 0) {
                uploadAndPaste(e.dataTransfer.files[0]);
            }
        });

        setTimeout(function() {
            inlineFitAddon.fit();
            connectInlineTerminalWs(paneId);
            inlineTerm.focus();
        }, 50);
    }

    function uploadAndPaste(file) {
        if (!inlineTermWs || inlineTermWs.readyState !== WebSocket.OPEN) {
            showToast('Terminal not connected', true);
            return;
        }
        showToast('Uploading ' + file.name + '...');
        var fd = new FormData();
        fd.append('file', file);
        fetch('/action/upload', { method: 'POST', body: fd })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.path) {
                    // Use bracketed paste mode so Claude Code
                    // recognizes the path as a pasted image attachment
                    var encoder = new TextEncoder();
                    var bp = '\x1b[200~' + data.path + '\x1b[201~';
                    inlineTermWs.send(encoder.encode(bp));
                    showToast('Dropped: ' + file.name);
                } else {
                    showToast('Upload failed: ' + (data.error || 'unknown'), true);
                }
            })
            .catch(function() { showToast('Upload failed', true); });
    }

    function connectInlineTerminalWs(paneId) {
        var path = '/ws/terminal?pane=' + encodeURIComponent(paneId) + '&zoom=1';
        inlineTermWs = new WebSocket(wsUrl(path));
        inlineTermWs.binaryType = 'arraybuffer';

        inlineTermWs.onopen = function() {
            // Send initial resize
            if (inlineFitAddon && inlineTerm) {
                var dims = inlineFitAddon.proposeDimensions();
                if (dims) {
                    inlineTermWs.send(JSON.stringify({ cols: dims.cols, rows: dims.rows }));
                }
                inlineTerm.focus();
            }
        };

        inlineTermWs.onmessage = function(e) {
            if (e.data instanceof ArrayBuffer && inlineTerm) {
                inlineTerm.write(new Uint8Array(e.data));
            }
        };

        inlineTermWs.onclose = function() {
            // Connection lost — fall back to static capture + toast
            if (inlineTerm) {
                detachInlineTerminal();
                refreshDetailStatic();
                showToast('Terminal disconnected — showing static capture', true);
            }
        };

        inlineTermWs.onerror = function() {
            if (inlineTerm) {
                detachInlineTerminal();
                refreshDetailStatic();
                showToast('Terminal error — showing static capture', true);
            }
        };

        // Terminal input → WS
        inlineTerm.onData(function(data) {
            if (inlineTermWs && inlineTermWs.readyState === WebSocket.OPEN) {
                var encoder = new TextEncoder();
                inlineTermWs.send(encoder.encode(data));
            }
        });
    }

    function detachInlineTerminal() {
        if (inlineTermWs) { try { inlineTermWs.close(); } catch(e) {} inlineTermWs = null; }
        if (inlineTerm) { try { inlineTerm.dispose(); } catch(e) {} inlineTerm = null; }
        inlineFitAddon = null;
        inlineTermPaneId = null;
        // Restore detail-body styling
        var body = document.getElementById('detail-body');
        if (body) {
            body.style.padding = '';
            body.style.overflow = '';
        }
    }

    window.refreshInlineTerminal = function() {
        if (inlineTerm && inlineTermPaneId) {
            var paneId = inlineTermPaneId;
            detachInlineTerminal();
            attachInlineTerminal(paneId);
        } else {
            refreshDetailStatic();
        }
    }

    // --- Worker selection (client-side, no page reload) ---
    window.selectWorker = function(name, paneId) {
        selectedWorker = name;
        selectedWorkerPaneId = paneId || null;
        document.querySelectorAll('.worker-item').forEach(function(el) {
            el.classList.toggle('selected', el.dataset.worker === name);
        });
        document.getElementById('detail-title').textContent = name + ' — Detail';
        document.getElementById('terminal-actions').style.display = 'flex';
        if (paneId) {
            attachInlineTerminal(paneId);
        } else {
            detachInlineTerminal();
            refreshDetailStatic();
        }
    }

    // --- Tab switcher ---
    window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        document.getElementById('tab-' + tab + '-btn').classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
        // Auto-scroll to bottom when switching tabs
        if (tab === 'drones') {
            var log = document.getElementById('drone-log');
            if (log) setTimeout(function() { log.scrollTop = log.scrollHeight; }, 0);
        } else if (tab === 'tasks') {
            var tl = document.getElementById('task-list');
            if (tl) setTimeout(function() { tl.scrollTop = tl.scrollHeight; }, 0);
        } else if (tab === 'notifications') {
            unreadNotifications = 0;
            var badge = document.getElementById('notif-badge');
            if (badge) badge.style.display = 'none';
            renderNotifications();
        }
    }

    // --- Actions ---
    window.toggleDrones = function() {
        fetch('/action/toggle-drones', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                updateDronesButton(data.enabled);
                refreshStatus();
            });
    }

    function updateDronesButton(enabled) {
        const btn = document.getElementById('drones-btn');
        btn.textContent = 'Drones: ' + (enabled ? 'ON' : 'OFF');
        btn.className = 'btn ' + (enabled ? 'btn-active' : 'btn-secondary');
    }

    window.continueAll = function() {
        fetch('/action/continue-all', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                showToast('Continued ' + data.count + ' worker(s)');
                setTimeout(refreshWorkers, 1000);
            });
    }

    window.reviveWorker = function() {
        if (!selectedWorker) return;
        fetch('/action/revive/' + selectedWorker, { method: 'POST' })
            .then(r => r.json())
            .then(function() {
                showToast('Reviving ' + selectedWorker);
                setTimeout(refreshDetail, 2000);
            });
    }

    window.killWorker = function() {
        if (!selectedWorker) return;
        if (!confirm('Kill worker "' + selectedWorker + '"? This will close the pane.')) return;
        detachInlineTerminal();
        fetch('/action/kill/' + selectedWorker, { method: 'POST' })
            .then(r => r.json())
            .then(function() {
                showToast('Killed ' + selectedWorker, true);
                selectedWorker = null;
                document.getElementById('detail-title').textContent = 'Select a worker';
                document.getElementById('detail-body').innerHTML = '<p style="color:var(--muted);padding:1rem;">Click a worker to see details</p>';
                document.getElementById('terminal-actions').style.display = 'none';
                refreshWorkers();
            });
    }

    // --- Unified Task Modal (create + edit) ---
    let taskModalMode = null; // 'create' or 'edit'
    let taskModalId = null;   // task ID when editing
    let taskModalPendingFiles = []; // files queued during create mode

    window.showCreateTask = function() {
        openTaskModal('create');
    };

    window.showEditTask = function(taskId, title, desc, priority, tags) {
        openTaskModal('edit', { id: taskId, title: title, desc: desc, priority: priority, tags: tags });
    };

    function openTaskModal(mode, data) {
        taskModalMode = mode;
        taskModalId = (data && data.id) || null;
        taskModalPendingFiles = [];

        document.getElementById('tm-title').value = (data && data.title) || '';
        document.getElementById('tm-desc').value = (data && data.desc) || '';
        document.getElementById('tm-priority').value = (data && data.priority) || 'normal';
        document.getElementById('tm-tags').value = (data && data.tags) || '';
        document.getElementById('tm-attachments').innerHTML = '';

        var header = document.getElementById('task-modal-header');
        var titleEl = document.getElementById('task-modal-title');
        var submitBtn = document.getElementById('tm-submit-btn');

        // Tags row only visible in edit mode
        document.getElementById('tm-tags-row').style.display = (mode === 'edit') ? '' : 'none';

        if (mode === 'create') {
            titleEl.textContent = 'New Task';
            submitBtn.textContent = 'Create';
            header.style.background = 'var(--lavender)';
        } else {
            titleEl.textContent = 'Edit Task';
            submitBtn.textContent = 'Save';
            header.style.background = 'var(--panel)';
        }

        document.getElementById('task-modal').style.display = 'flex';
        document.getElementById('tm-title').focus();
    }

    window.closeTaskModal = function() {
        document.getElementById('task-modal').style.display = 'none';
        taskModalMode = null;
        taskModalId = null;
        taskModalPendingFiles = [];
    };

    window.submitTaskModal = function() {
        var title = document.getElementById('tm-title').value.trim();
        if (!title) { showToast('Title required', true); return; }
        var desc = document.getElementById('tm-desc').value;
        var priority = document.getElementById('tm-priority').value;
        var tags = document.getElementById('tm-tags').value;

        if (taskModalMode === 'edit') {
            // Edit existing task
            fetch('/action/task/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'task_id=' + encodeURIComponent(taskModalId)
                    + '&title=' + encodeURIComponent(title)
                    + '&description=' + encodeURIComponent(desc)
                    + '&priority=' + priority
                    + '&tags=' + encodeURIComponent(tags)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'updated') {
                    showToast('Task updated');
                    closeTaskModal();
                    refreshTasks();
                } else {
                    showToast('Error: ' + (data.error || 'unknown'), true);
                }
            });
        } else {
            // Create new task, then upload any pending files
            fetch('/action/task/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'title=' + encodeURIComponent(title)
                    + '&description=' + encodeURIComponent(desc)
                    + '&priority=' + priority
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.id) {
                    showToast('Task created: ' + data.title);
                    // Upload any pending files
                    var uploads = taskModalPendingFiles.map(function(file) {
                        var fd = new FormData();
                        fd.append('task_id', data.id);
                        fd.append('file', file);
                        return fetch('/action/task/upload', { method: 'POST', body: fd });
                    });
                    Promise.all(uploads).then(function() {
                        if (uploads.length > 0) showToast(uploads.length + ' attachment(s) uploaded');
                        refreshTasks();
                    });
                    closeTaskModal();
                } else {
                    showToast('Error: ' + (data.error || 'unknown'), true);
                }
            });
        }
    };

    window.assignTask = function(taskId, taskTitle) {
        if (!selectedWorker) {
            showToast('Select a worker first', true);
            return;
        }
        fetch('/action/task/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'task_id=' + encodeURIComponent(taskId) + '&worker=' + encodeURIComponent(selectedWorker)
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'assigned') {
                showToast('Assigned "' + taskTitle + '" to ' + selectedWorker);
                refreshTasks();
            } else {
                showToast('Error: ' + (data.error || 'unknown'), true);
            }
        });
    }

    window.completeTask = function(taskId) {
        fetch('/action/task/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'task_id=' + encodeURIComponent(taskId)
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'completed') {
                showToast('Task completed');
                refreshTasks();
            }
        });
    }

    window.removeTask = function(taskId) {
        if (!confirm('Remove this task?')) return;
        fetch('/action/task/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'task_id=' + encodeURIComponent(taskId)
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'removed') {
                showToast('Task removed');
                refreshTasks();
            }
        });
    }

    window.failTask = function(taskId) {
        fetch('/action/task/fail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'task_id=' + encodeURIComponent(taskId)
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'failed') {
                showToast('Task failed');
                refreshTasks();
            }
        });
    }

    // --- Broadcast ---
    window.showBroadcast = function() {
        document.getElementById('broadcast-modal').style.display = 'flex';
        document.getElementById('broadcast-input').focus();
    }

    window.hideBroadcast = function() {
        document.getElementById('broadcast-modal').style.display = 'none';
        document.getElementById('broadcast-input').value = '';
    }

    window.sendBroadcast = function() {
        const msg = document.getElementById('broadcast-input').value.trim();
        if (!msg) return;
        const target = document.getElementById('broadcast-target').value;

        if (target.startsWith('group:')) {
            const group = target.substring(6);
            fetch('/action/send-group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'message=' + encodeURIComponent(msg) + '&group=' + encodeURIComponent(group)
            })
            .then(r => r.json())
            .then(data => {
                showToast('Sent to ' + data.count + ' worker(s) in ' + group);
                hideBroadcast();
            });
        } else {
            fetch('/action/send-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'message=' + encodeURIComponent(msg)
            })
            .then(r => r.json())
            .then(data => {
                showToast('Sent to ' + data.count + ' worker(s)');
                hideBroadcast();
            });
        }
    }

    // --- Queen ---
    let lastDirectives = [];

    window.askQueen = function() {
        const modal = document.getElementById('queen-modal');
        const result = document.getElementById('queen-result');
        modal.style.display = 'flex';
        result.innerHTML = '<p style="color:var(--muted);"><span class="spinner"></span>Analyzing hive... (this may take a moment)</p>';
        document.getElementById('queen-btn').disabled = true;
        document.getElementById('queen-refresh-btn').disabled = true;
        document.getElementById('queen-apply-btn').style.display = 'none';
        lastDirectives = [];

        fetch('/action/ask-queen', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('queen-btn').disabled = false;
                document.getElementById('queen-refresh-btn').disabled = false;
                startQueenCooldown(data.cooldown || 0);
                if (data.error) {
                    result.innerHTML = '<p style="color:var(--poppy);">' + escapeHtml(data.error) + '</p>';
                    return;
                }
                lastDirectives = data.directives || [];
                result.innerHTML = renderQueenResult(data);
                if (lastDirectives.length > 0) {
                    document.getElementById('queen-apply-btn').style.display = 'inline-block';
                }
            })
            .catch(err => {
                document.getElementById('queen-btn').disabled = false;
                document.getElementById('queen-refresh-btn').disabled = false;
                result.innerHTML = '<p style="color:var(--poppy);">Request failed</p>';
            });
    }

    window.hideQueen = function() {
        document.getElementById('queen-modal').style.display = 'none';
    }

    window.askQueenWorker = function() {
        if (!selectedWorker) { showToast('Select a worker first', true); return; }
        const modal = document.getElementById('queen-modal');
        const result = document.getElementById('queen-result');
        modal.style.display = 'flex';
        result.innerHTML = '<p style="color:var(--muted);"><span class="spinner"></span>Analyzing ' + escapeHtml(selectedWorker) + '... (this may take a moment)</p>';
        document.getElementById('queen-btn').disabled = true;
        document.getElementById('queen-refresh-btn').disabled = true;
        document.getElementById('queen-apply-btn').style.display = 'none';
        lastDirectives = [];

        fetch('/action/ask-queen/' + encodeURIComponent(selectedWorker), { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('queen-btn').disabled = false;
                document.getElementById('queen-refresh-btn').disabled = false;
                startQueenCooldown(data.cooldown || 0);
                if (data.error) {
                    result.innerHTML = '<p style="color:var(--poppy);">' + escapeHtml(data.error) + '</p>';
                    return;
                }
                // Per-worker analysis has assessment/reasoning/action, wrap as directives
                if (data.action && !data.directives) {
                    lastDirectives = [{ worker: selectedWorker, action: data.action, message: data.message || '', reason: data.reasoning || '' }];
                } else {
                    lastDirectives = data.directives || [];
                }
                result.innerHTML = renderQueenResult(data);
                if (lastDirectives.length > 0) {
                    document.getElementById('queen-apply-btn').style.display = 'inline-block';
                }
            })
            .catch(err => {
                document.getElementById('queen-btn').disabled = false;
                document.getElementById('queen-refresh-btn').disabled = false;
                result.innerHTML = '<p style="color:var(--poppy);">Request failed</p>';
            });
    }

    window.applyDirectives = function() {
        if (!lastDirectives.length) return;
        let applied = 0;
        for (const d of lastDirectives) {
            if (!d.worker || !d.action) continue;
            if (d.action === 'send_message' && d.message) {
                fetch('/action/send/' + encodeURIComponent(d.worker), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'message=' + encodeURIComponent(d.message)
                });
                applied++;
            } else if (d.action === 'continue') {
                fetch('/action/continue/' + encodeURIComponent(d.worker), { method: 'POST' });
                applied++;
            } else if (d.action === 'restart') {
                fetch('/action/revive/' + encodeURIComponent(d.worker), { method: 'POST' });
                applied++;
            }
        }
        showToast('Applied ' + applied + ' directive(s)');
        document.getElementById('queen-apply-btn').style.display = 'none';
        setTimeout(function() { refreshWorkers(); refreshDetail(); }, 1500);
    }

    window.applyDirective = function(idx) {
        const d = lastDirectives[idx];
        if (!d || !d.worker || !d.action) return;
        if (d.action === 'send_message' && d.message) {
            fetch('/action/send/' + encodeURIComponent(d.worker), {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'message=' + encodeURIComponent(d.message)
            }).then(() => showToast('Sent message to ' + d.worker));
        } else if (d.action === 'continue') {
            fetch('/action/continue/' + encodeURIComponent(d.worker), { method: 'POST' })
                .then(() => showToast('Continued ' + d.worker));
        } else if (d.action === 'restart') {
            fetch('/action/revive/' + encodeURIComponent(d.worker), { method: 'POST' })
                .then(() => showToast('Reviving ' + d.worker));
        }
        // Mark as applied visually
        const btn = document.getElementById('directive-btn-' + idx);
        if (btn) { btn.textContent = 'Done'; btn.disabled = true; }
    }

    function renderQueenResult(data) {
        let html = '';
        // Top-level analysis
        if (data.assessment) {
            html += '<div style="margin-bottom:1rem;padding:0.75rem;background:var(--panel);border-radius:4px;">';
            html += '<strong style="color:var(--honey);">Assessment</strong><br>';
            html += '<span>' + escapeHtml(data.assessment) + '</span></div>';
        }
        if (data.reasoning) {
            html += '<div style="margin-bottom:1rem;padding:0.75rem;background:var(--panel);border-radius:4px;">';
            html += '<strong style="color:var(--honey);">Reasoning</strong><br>';
            html += '<span>' + escapeHtml(data.reasoning) + '</span></div>';
        }
        // Directives with per-directive apply buttons
        const directives = data.directives || [];
        if (directives.length > 0) {
            html += '<div style="margin-bottom:0.5rem;"><strong style="color:var(--lavender);">Directives (' + directives.length + ')</strong></div>';
            for (let i = 0; i < directives.length; i++) {
                const d = directives[i];
                html += '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.5rem;border-bottom:1px solid var(--panel);">';
                html += '<span style="color:var(--lavender);font-weight:bold;min-width:80px;">' + escapeHtml(d.worker || '?') + '</span>';
                html += '<span style="color:var(--honey);min-width:90px;">' + escapeHtml(d.action || '?') + '</span>';
                html += '<span style="flex:1;font-size:0.8rem;color:var(--muted);">' + escapeHtml(d.reason || d.message || '') + '</span>';
                html += '<button class="btn btn-sm btn-secondary" id="directive-btn-' + i + '" onclick="applyDirective(' + i + ')">Apply</button>';
                html += '</div>';
            }
        }
        // Conflicts
        const conflicts = data.conflicts || [];
        if (conflicts.length > 0) {
            html += '<div style="margin-top:1rem;padding:0.75rem;background:rgba(209,93,76,0.15);border:1px solid var(--poppy);border-radius:4px;">';
            html += '<strong style="color:var(--poppy);">Conflicts Detected</strong>';
            for (const c of conflicts) {
                html += '<div style="padding:0.2rem 0;font-size:0.85rem;">' + escapeHtml(typeof c === 'string' ? c : JSON.stringify(c)) + '</div>';
            }
            html += '</div>';
        }
        // Raw/unknown format fallback
        if (!html) {
            html = '<pre style="white-space:pre-wrap;font-size:0.8rem;">' + escapeHtml(JSON.stringify(data, null, 2)) + '</pre>';
        }
        return html;
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // --- Queen cooldown timer ---
    let queenCooldownTimer = null;

    function startQueenCooldown(seconds) {
        if (queenCooldownTimer) clearInterval(queenCooldownTimer);
        if (!seconds || seconds <= 0) return;
        let remaining = Math.ceil(seconds);
        const queenBtn = document.getElementById('queen-btn');
        const refreshBtn = document.getElementById('queen-refresh-btn');
        function updateBtns() {
            if (remaining > 0) {
                queenBtn.textContent = 'Ask Queen (' + remaining + 's)';
                queenBtn.disabled = true;
                refreshBtn.textContent = 'Re-analyze (' + remaining + 's)';
                refreshBtn.disabled = true;
                remaining--;
            } else {
                queenBtn.textContent = 'Ask Queen';
                queenBtn.disabled = false;
                refreshBtn.textContent = 'Re-analyze';
                refreshBtn.disabled = false;
                clearInterval(queenCooldownTimer);
                queenCooldownTimer = null;
            }
        }
        updateBtns();
        queenCooldownTimer = setInterval(updateBtns, 1000);
    }

    // --- Notification history ---
    let notificationHistory = [];
    let unreadNotifications = 0;
    const MAX_NOTIFICATIONS = 200;

    function addNotification(msg, warning) {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        notificationHistory.unshift({ time: time, msg: msg, warning: !!warning });
        if (notificationHistory.length > MAX_NOTIFICATIONS) notificationHistory.pop();

        // Increment badge unless notifications tab is active
        var activeTab = document.querySelector('.tab-content.active');
        if (!activeTab || activeTab.id !== 'tab-notifications') {
            unreadNotifications++;
            var badge = document.getElementById('notif-badge');
            if (badge) {
                badge.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
                badge.style.display = 'inline-flex';
            }
        } else {
            renderNotifications();
        }
    }

    function renderNotifications() {
        var container = document.getElementById('notification-list');
        if (!container) return;
        if (!notificationHistory.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">-</div>No notifications yet</div>';
            return;
        }
        var html = '';
        for (var i = 0; i < notificationHistory.length; i++) {
            var n = notificationHistory[i];
            html += '<div class="notification-entry' + (n.warning ? ' notif-warning' : '') + '">';
            html += '<span class="notif-time">' + escapeHtml(n.time) + '</span>';
            html += '<span>' + escapeHtml(n.msg) + '</span>';
            html += '</div>';
        }
        container.innerHTML = html;
    }

    // --- Browser notifications ---
    function updateNotifButton() {
        var btn = document.getElementById('notif-perm-btn');
        if (!btn) return;
        if (!('Notification' in window)) {
            btn.style.display = 'none';
            return;
        }
        if (Notification.permission === 'granted') {
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-active');
            btn.title = 'Browser notifications enabled';
        } else if (Notification.permission === 'denied') {
            btn.style.opacity = '0.4';
            btn.title = 'Browser notifications blocked — update in browser settings';
        }
    }

    window.requestNotifPermission = function() {
        if (!('Notification' in window)) {
            showToast('Browser does not support notifications', true);
            return;
        }
        if (Notification.permission === 'granted') {
            showToast('Notifications already enabled');
            return;
        }
        if (Notification.permission === 'denied') {
            showToast('Notifications blocked — allow in browser settings', true);
            return;
        }
        Notification.requestPermission().then(function(perm) {
            if (perm === 'granted') {
                showToast('Browser notifications enabled');
                // Show a test notification
                new Notification("Swarm's Bee Hive", {
                    body: 'Notifications are now active.',
                    icon: '/bee-icon.svg'
                });
            } else {
                showToast('Notification permission denied', true);
            }
            updateNotifButton();
        });
    };

    function notifyBrowser(title, body) {
        // Only notify when tab is hidden and permission granted
        if (!document.hidden) return;
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'granted') return;
        try {
            var n = new Notification(title, {
                body: body,
                icon: '/bee-icon.svg',
                tag: 'swarm-' + Date.now()
            });
            // Click notification → focus the tab
            n.onclick = function() {
                window.focus();
                n.close();
            };
            // Auto-close after 8 seconds
            setTimeout(function() { n.close(); }, 8000);
        } catch(e) {}
    }

    // --- Task filter switcher ---
    window.switchTaskFilter = function(filter) {
        activeTaskFilter = filter;
        document.querySelectorAll('.filter-chip').forEach(function(c) {
            c.classList.toggle('active', c.dataset.filter === filter);
        });
        refreshTasks();
    };

    // --- Worker group toggle ---
    window.toggleGroup = function(groupName) {
        var header = document.querySelector('.group-header[data-group="' + groupName + '"]');
        if (!header) return;
        var section = header.parentElement;
        if (!section) return;
        section.classList.toggle('group-collapsed');
        // Persist in localStorage
        var collapsed = JSON.parse(localStorage.getItem('swarm-groups-collapsed') || '{}');
        collapsed[groupName] = section.classList.contains('group-collapsed');
        localStorage.setItem('swarm-groups-collapsed', JSON.stringify(collapsed));
    };

    // --- Toast notifications ---
    function showToast(msg, warning) {
        const container = document.getElementById('toasts');
        const toast = document.createElement('div');
        toast.className = 'toast' + (warning ? ' toast-warning' : '');
        toast.textContent = msg;
        container.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3500);
        addNotification(msg, warning);
    }

    // --- Launch ---
    let launchConfig = null;

    window.showLaunch = function() {
        const modal = document.getElementById('launch-modal');
        const body = document.getElementById('launch-body');
        modal.style.display = 'flex';
        body.innerHTML = '<p style="color:var(--muted);">Loading config...</p>';

        fetch('/partials/launch-config')
            .then(r => r.json())
            .then(data => {
                launchConfig = data;
                let html = '';
                // Group preset buttons
                if (data.groups && data.groups.length > 0) {
                    html += '<div style="margin-bottom:0.75rem;">';
                    html += '<label style="color:var(--muted);font-size:0.8rem;">Quick select group:</label><br>';
                    for (const g of data.groups) {
                        html += '<button class="btn btn-sm btn-secondary launch-group-btn" style="margin:0.25rem 0.25rem 0 0;" data-group="' + escapeHtml(g.name) + '">' + escapeHtml(g.name) + '</button>';
                    }
                    html += '</div>';
                }
                // Worker checkboxes — disable already-running workers
                html += '<div style="max-height:300px;overflow-y:auto;">';
                for (const w of data.workers) {
                    const running = w.running;
                    html += '<label style="display:block;padding:0.2rem 0;cursor:' + (running ? 'default' : 'pointer') + ';color:' + (running ? 'var(--muted)' : 'var(--beeswax)') + ';">';
                    html += '<input type="checkbox" class="launch-worker-cb" value="' + escapeHtml(w.name) + '"' + (running ? ' disabled' : ' checked') + ' style="margin-right:0.5rem;">';
                    html += escapeHtml(w.name);
                    if (running) {
                        html += ' <span style="color:var(--leaf);font-size:0.75rem;">(running)</span>';
                    }
                    html += ' <span style="color:var(--muted);font-size:0.8rem;">(' + escapeHtml(w.path) + ')</span>';
                    html += '</label>';
                }
                html += '</div>';
                body.innerHTML = html;
            })
            .catch(() => {
                body.innerHTML = '<p style="color:var(--poppy);">Failed to load config</p>';
            });
    }

    window.hideLaunch = function() {
        document.getElementById('launch-modal').style.display = 'none';
    }

    function selectLaunchGroup(groupName) {
        if (!launchConfig) return;
        const group = launchConfig.groups.find(g => g.name === groupName);
        if (!group) return;
        const members = new Set(group.workers.map(n => n.toLowerCase()));
        document.querySelectorAll('.launch-worker-cb').forEach(cb => {
            cb.checked = members.has(cb.value.toLowerCase());
        });
    }

    window.launchSelected = function() {
        const checked = [];
        document.querySelectorAll('.launch-worker-cb:checked').forEach(cb => checked.push(cb.value));
        if (!checked.length) { showToast('No workers selected', true); return; }
        doLaunch(checked.join(','));
    }

    window.launchAll = function() {
        doLaunch('');
    }

    function doLaunch(workers) {
        fetch('/action/launch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: workers ? 'workers=' + encodeURIComponent(workers) : ''
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showToast('Launch failed: ' + data.error, true);
            } else {
                showToast('Launched ' + data.count + ' worker(s)');
                hideLaunch();
                refreshWorkers();
                refreshStatus();
            }
        })
        .catch(() => showToast('Launch request failed', true));
    }

    // --- Spawn Worker ---
    window.showSpawn = function() {
        const modal = document.getElementById('spawn-modal');
        modal.style.display = 'flex';
        document.getElementById('spawn-name').value = '';
        document.getElementById('spawn-path').value = '';
        document.getElementById('spawn-name').focus();

        // Load config paths as presets
        fetch('/partials/launch-config')
            .then(r => r.json())
            .then(data => {
                const presets = document.getElementById('spawn-presets');
                if (!data.workers || !data.workers.length) { presets.innerHTML = ''; return; }
                const paths = [...new Set(data.workers.map(w => w.path))];
                let html = '<label style="color:var(--muted);font-size:0.75rem;">Quick fill from config:</label><br>';
                for (const w of data.workers) {
                    if (!w.running) {
                        html += '<button type="button" class="btn btn-sm btn-secondary spawn-preset-btn" style="margin:0.2rem 0.2rem 0 0;" data-name="' + escapeHtml(w.name) + '" data-path="' + escapeHtml(w.path) + '">' + escapeHtml(w.name) + '</button>';
                    }
                }
                presets.innerHTML = html;
            });
    }

    window.hideSpawn = function() {
        document.getElementById('spawn-modal').style.display = 'none';
    }

    window.doSpawn = function() {
        const name = document.getElementById('spawn-name').value.trim();
        const path = document.getElementById('spawn-path').value.trim();
        if (!name || !path) { showToast('Name and path are required', true); return; }

        fetch('/action/spawn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'name=' + encodeURIComponent(name) + '&path=' + encodeURIComponent(path)
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showToast('Spawn failed: ' + data.error, true);
            } else {
                showToast('Spawned ' + data.worker);
                hideSpawn();
                refreshWorkers();
                refreshStatus();
            }
        })
        .catch(() => showToast('Spawn request failed', true));
    }

    // --- Shutdown dialog ---
    window.killSession = function() {
        document.getElementById('shutdown-modal').style.display = 'flex';
    }

    window.hideShutdown = function() {
        document.getElementById('shutdown-modal').style.display = 'none';
    }

    window.doStopServer = function() {
        fetch('/action/stop-server', { method: 'POST' })
            .then(r => r.json())
            .then(function() {
                showToast('Web server stopping...');
                hideShutdown();
            });
    }

    window.doKillEverything = function() {
        detachInlineTerminal();
        fetch('/action/kill-session', { method: 'POST' })
            .then(r => r.json())
            .then(function() {
                showToast('Session killed — all workers terminated', true);
                selectedWorker = null;
                document.getElementById('detail-title').textContent = 'Select a worker';
                document.getElementById('detail-body').innerHTML = '<p style="color:var(--muted);padding:1rem;">Click a worker to see details</p>';
                document.getElementById('terminal-actions').style.display = 'none';
                refreshWorkers();
                refreshStatus();
                refreshTasks();
                // Also stop the web server
                fetch('/action/stop-server', { method: 'POST' });
                hideShutdown();
            });
    }

    // --- Drag-and-drop attachments (unified modal) ---
    ;(function() {
        var dropzone = document.getElementById('tm-dropzone');
        var fileInput = document.getElementById('tm-file');

        if (!dropzone || !fileInput) return;

        dropzone.addEventListener('click', function() { fileInput.click(); });

        dropzone.addEventListener('dragenter', function(e) { e.preventDefault(); dropzone.style.borderColor = 'var(--honey)'; });
        dropzone.addEventListener('dragover', function(e) { e.preventDefault(); });
        dropzone.addEventListener('dragleave', function() { dropzone.style.borderColor = 'var(--border)'; });
        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--border)';
            if (e.dataTransfer.files.length > 0) handleTaskFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) handleTaskFile(fileInput.files[0]);
            fileInput.value = '';
        });
    })();

    function handleTaskFile(file) {
        if (taskModalMode === 'edit' && taskModalId) {
            // Upload immediately for existing tasks
            var fd = new FormData();
            fd.append('task_id', taskModalId);
            fd.append('file', file);
            fetch('/action/task/upload', { method: 'POST', body: fd })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'uploaded') {
                        showToast('Attachment uploaded');
                        addThumbnail(data.path);
                        refreshTasks();
                    } else {
                        showToast('Upload failed: ' + (data.error || 'unknown'), true);
                    }
                })
                .catch(function() { showToast('Upload failed', true); });
        } else {
            // Queue file for upload after task creation
            taskModalPendingFiles.push(file);
            addLocalThumbnail(file);
            showToast('File queued — will upload on create');
        }
    }

    function addThumbnail(path) {
        var container = document.getElementById('tm-attachments');
        var basename = path.split('/').pop();
        var img = document.createElement('img');
        img.src = '/uploads/' + encodeURIComponent(basename);
        img.style.cssText = 'max-height:48px;max-width:80px;border:1px solid var(--border);border-radius:3px;';
        container.appendChild(img);
    }

    function addLocalThumbnail(file) {
        var container = document.getElementById('tm-attachments');
        var img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.cssText = 'max-height:48px;max-width:80px;border:1px solid var(--border);border-radius:3px;';
        img.onload = function() { URL.revokeObjectURL(img.src); };
        container.appendChild(img);
    }

    // --- Periodic refresh (fallback if WS drops) ---
    setInterval(function() {
        refreshWorkers();
        refreshStatus();
        refreshTasks();
        refreshDroneLog();
        if (selectedWorker) refreshDetail();
    }, 10000);

    // --- Event delegation (avoids inline onclick + template escaping issues) ---
    document.addEventListener('click', function(e) {
        // Worker item click
        var item = e.target.closest('.worker-item');
        if (item && item.dataset.worker) {
            selectWorker(item.dataset.worker, item.dataset.paneId);
            return;
        }
        // Task assign button
        var assignBtn = e.target.closest('.assign-task-btn');
        if (assignBtn) {
            assignTask(assignBtn.dataset.taskId, assignBtn.dataset.taskTitle);
            return;
        }
        // Task complete button
        var completeBtn = e.target.closest('.complete-task-btn');
        if (completeBtn) {
            completeTask(completeBtn.dataset.taskId);
            return;
        }
        // Task remove button
        var removeBtn = e.target.closest('.remove-task-btn');
        if (removeBtn) {
            removeTask(removeBtn.dataset.taskId);
            return;
        }
        // Task fail button
        var failBtn = e.target.closest('.fail-task-btn');
        if (failBtn) {
            failTask(failBtn.dataset.taskId);
            return;
        }
        // Task edit button
        var editBtn = e.target.closest('.edit-task-btn');
        if (editBtn) {
            showEditTask(editBtn.dataset.taskId, editBtn.dataset.taskTitle, editBtn.dataset.taskDesc, editBtn.dataset.taskPriority, editBtn.dataset.taskTags);
            return;
        }
        // Launch group preset button
        var groupBtn = e.target.closest('.launch-group-btn');
        if (groupBtn) {
            selectLaunchGroup(groupBtn.dataset.group);
            return;
        }
        // Spawn preset button
        var spawnBtn = e.target.closest('.spawn-preset-btn');
        if (spawnBtn) {
            document.getElementById('spawn-name').value = spawnBtn.dataset.name;
            document.getElementById('spawn-path').value = spawnBtn.dataset.path;
            return;
        }
        // Group header click (collapse/expand)
        var groupHeader = e.target.closest('.group-header');
        if (groupHeader && groupHeader.dataset.group) {
            toggleGroup(groupHeader.dataset.group);
            return;
        }
    });

    // --- Keyboard shortcuts (Alt+letter, matching TUI keys.py) ---
    document.addEventListener('keydown', function(e) {
        if (!e.altKey) return;
        // When modal terminal is attached, let everything through to xterm/tmux
        if (document.getElementById('terminal-modal').style.display !== 'none') return;
        // When inline terminal is focused, let everything through
        if (inlineTerm && inlineTerm.textarea && document.activeElement === inlineTerm.textarea) return;

        switch (e.key.toLowerCase()) {
            case 'b': toggleDrones(); break;
            case 'a': continueAll(); break;
            case 'k': killWorker(); break;
            case 'r': reviveWorker(); break;
            case 'x': window.location.href = '/'; break;
            case 'q': askQueen(); break;
            case 't': attachTerminal(); break;
            case 'n': showCreateTask(); break;
            case 'h': killSession(); break;
            default: return;
        }
        e.preventDefault();
    });

    // --- Header clock (local time) ---
    function updateClock() {
        var el = document.getElementById('header-clock');
        if (el) {
            var now = new Date();
            el.textContent = now.toLocaleTimeString('en-US', { hour12: true });
        }
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Boot — prompt for API password if needed for WebSocket auth
    {% if ws_auth_required %}
    if (!wsToken()) {
        const pw = prompt('API password required for live updates:');
        if (pw) sessionStorage.setItem('swarm_api_password', pw);
    }
    {% endif %}
    updateNotifButton();
    connect();

    // Re-select worker after HTMX swaps the worker list
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target.id === 'worker-list') {
            if (selectedWorker) {
                document.querySelectorAll('.worker-item').forEach(function(el) {
                    el.classList.toggle('selected', el.dataset.worker === selectedWorker);
                });
            }
            // Restore group collapse state from localStorage
            var collapsed = JSON.parse(localStorage.getItem('swarm-groups-collapsed') || '{}');
            Object.keys(collapsed).forEach(function(gName) {
                if (collapsed[gName]) {
                    var header = document.querySelector('.group-header[data-group="' + gName + '"]');
                    if (header && header.parentElement) header.parentElement.classList.add('group-collapsed');
                }
            });
        }
        // Update task summary after task list swap
        if (e.detail.target.id === 'task-list') {
            const summary = e.detail.target.querySelector('[data-summary]');
            if (summary) {
                document.getElementById('task-summary').textContent = summary.dataset.summary;
            }
            // Highlight tasks assigned to selected worker
            if (selectedWorker) {
                document.querySelectorAll('.task-item').forEach(function(el) {
                    el.classList.toggle('assigned-to-selected', el.dataset.worker === selectedWorker);
                });
            }
        }
        // Auto-scroll panels to bottom so latest content is visible
        // Skip detail-body when inline terminal is active (it's already live)
        var tid = e.detail.target.id;
        if (tid === 'drone-log' || tid === 'task-list') {
            e.detail.target.scrollTop = e.detail.target.scrollHeight;
        }
        if (tid === 'detail-body' && !inlineTerm) {
            e.detail.target.scrollTop = e.detail.target.scrollHeight;
        }
    });

    // --- Terminal attach ---
    let termWs = null;
    let term = null;
    let fitAddon = null;

    // Track whether inline terminal was active before opening modal
    let inlinePausedForModal = null;

    window.attachTerminal = function() {
        if (typeof Terminal === 'undefined') {
            showToast('Terminal library still loading, try again', true);
            return;
        }

        // Detach inline terminal first so the pane unzooms for full-session view
        if (inlineTerm && inlineTermPaneId) {
            inlinePausedForModal = inlineTermPaneId;
            detachInlineTerminal();
        } else {
            inlinePausedForModal = null;
        }

        const modal = document.getElementById('terminal-modal');
        const container = document.getElementById('terminal-container');
        document.getElementById('terminal-title').textContent = 'tmux session';
        document.getElementById('terminal-status').textContent = 'connecting...';
        document.getElementById('terminal-status').style.color = 'var(--muted)';
        modal.style.display = 'flex';
        container.innerHTML = '';

        term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
            theme: {
                background: '#2A1B0E',
                foreground: '#E6D2B5',
                cursor: '#D8A03D',
                selectionBackground: 'rgba(216,160,61,0.3)',
                black: '#2A1B0E',
                red: '#D15D4C',
                green: '#8CB369',
                yellow: '#D8A03D',
                blue: '#A88FD9',
                magenta: '#A88FD9',
                cyan: '#7EC8C8',
                white: '#E6D2B5',
            }
        });

        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(container);

        // Enable drag-and-drop on the modal terminal
        container.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            container.style.outline = '2px solid var(--honey)';
        });
        container.addEventListener('dragleave', function() {
            container.style.outline = '';
        });
        container.addEventListener('drop', function(e) {
            e.preventDefault();
            container.style.outline = '';
            if (e.dataTransfer.files.length > 0) {
                uploadAndPasteModal(e.dataTransfer.files[0]);
            }
        });

        // Small delay so container has layout dimensions
        setTimeout(function() {
            fitAddon.fit();
            connectTerminalWs();
            term.focus();
        }, 50);
    }

    function uploadAndPasteModal(file) {
        if (!termWs || termWs.readyState !== WebSocket.OPEN) {
            showToast('Terminal not connected', true);
            return;
        }
        showToast('Uploading ' + file.name + '...');
        var fd = new FormData();
        fd.append('file', file);
        fetch('/action/upload', { method: 'POST', body: fd })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.path) {
                    // Use bracketed paste mode so Claude Code
                    // recognizes the path as a pasted image attachment
                    var encoder = new TextEncoder();
                    var bp = '\x1b[200~' + data.path + '\x1b[201~';
                    termWs.send(encoder.encode(bp));
                    showToast('Dropped: ' + file.name);
                } else {
                    showToast('Upload failed: ' + (data.error || 'unknown'), true);
                }
            })
            .catch(function() { showToast('Upload failed', true); });
    }

    function connectTerminalWs() {
        let path = '/ws/terminal';
        // If a worker is selected, pass its pane_id to pre-select that pane
        if (selectedWorker && selectedWorkerPaneId) {
            path += '?pane=' + encodeURIComponent(selectedWorkerPaneId);
        }
        termWs = new WebSocket(wsUrl(path));
        termWs.binaryType = 'arraybuffer';

        termWs.onopen = function() {
            document.getElementById('terminal-status').textContent = 'connected';
            document.getElementById('terminal-status').style.color = 'var(--leaf)';
            // Send initial resize
            if (fitAddon && term) {
                const dims = fitAddon.proposeDimensions();
                if (dims) {
                    termWs.send(JSON.stringify({ cols: dims.cols, rows: dims.rows }));
                }
                term.focus();
            }
        };

        termWs.onmessage = function(e) {
            if (e.data instanceof ArrayBuffer) {
                term.write(new Uint8Array(e.data));
            }
        };

        termWs.onclose = function() {
            document.getElementById('terminal-status').textContent = 'disconnected';
            document.getElementById('terminal-status').style.color = 'var(--poppy)';
        };

        termWs.onerror = function() {
            document.getElementById('terminal-status').textContent = 'error';
            document.getElementById('terminal-status').style.color = 'var(--poppy)';
        };

        // Terminal input → WS
        term.onData(function(data) {
            if (termWs && termWs.readyState === WebSocket.OPEN) {
                const encoder = new TextEncoder();
                termWs.send(encoder.encode(data));
            }
        });
    }

    window.closeTerminal = function() {
        if (termWs) { try { termWs.close(); } catch(e) {} termWs = null; }
        if (term) { try { term.dispose(); } catch(e) {} term = null; }
        fitAddon = null;
        document.getElementById('terminal-modal').style.display = 'none';
        // Reattach inline terminal if it was paused for the modal
        if (inlinePausedForModal) {
            var paneId = inlinePausedForModal;
            inlinePausedForModal = null;
            setTimeout(function() { attachInlineTerminal(paneId); }, 300);
        }
    }

    // Resize handler for modal terminal
    window.addEventListener('resize', function() {
        if (fitAddon && term && termWs && termWs.readyState === WebSocket.OPEN) {
            fitAddon.fit();
            const dims = fitAddon.proposeDimensions();
            if (dims) {
                termWs.send(JSON.stringify({ cols: dims.cols, rows: dims.rows }));
            }
        }
        // Also resize inline terminal
        if (inlineFitAddon && inlineTerm) {
            inlineFitAddon.fit();
            if (inlineTermWs && inlineTermWs.readyState === WebSocket.OPEN) {
                var idims = inlineFitAddon.proposeDimensions();
                if (idims) {
                    inlineTermWs.send(JSON.stringify({ cols: idims.cols, rows: idims.rows }));
                }
            }
        }
    });

    // Escape key closes terminal modal (only when terminal is not focused)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('terminal-modal').style.display !== 'none') {
            if (!term || !term.textarea || document.activeElement !== term.textarea) {
                closeTerminal();
            }
        }
    });

    // --- Resizable split ---
    ;(function() {
        const handle = document.getElementById('resize-handle');
        if (!handle) return;
        const area = handle.parentElement; // .detail-area
        let dragging = false;
        let startY = 0;
        let startTopFr = 0.5;

        // Read saved ratio
        const saved = localStorage.getItem('swarm-split');
        if (saved) {
            const ratio = parseFloat(saved);
            if (ratio > 0.15 && ratio < 0.85) {
                area.style.gridTemplateRows = ratio + 'fr auto ' + (1 - ratio) + 'fr';
            }
        }

        handle.addEventListener('mousedown', function(e) {
            e.preventDefault();
            dragging = true;
            startY = e.clientY;
            const rect = area.getBoundingClientRect();
            startTopFr = (area.children[0].getBoundingClientRect().height) / rect.height;
            handle.classList.add('dragging');
            document.body.style.cursor = 'row-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!dragging) return;
            const rect = area.getBoundingClientRect();
            const dy = e.clientY - rect.top;
            let ratio = dy / rect.height;
            ratio = Math.max(0.15, Math.min(0.85, ratio));
            area.style.gridTemplateRows = ratio + 'fr auto ' + (1 - ratio) + 'fr';
            // Fit inline terminal during drag (visual only, no WS resize flood)
            if (inlineFitAddon && inlineTerm) {
                inlineFitAddon.fit();
            }
        });

        document.addEventListener('mouseup', function() {
            if (!dragging) return;
            dragging = false;
            handle.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            // Persist
            const rect = area.getBoundingClientRect();
            const topH = area.children[0].getBoundingClientRect().height;
            localStorage.setItem('swarm-split', (topH / rect.height).toFixed(3));
            // Send final resize to inline terminal after drag ends
            if (inlineFitAddon && inlineTerm) {
                inlineFitAddon.fit();
                if (inlineTermWs && inlineTermWs.readyState === WebSocket.OPEN) {
                    var dims = inlineFitAddon.proposeDimensions();
                    if (dims) {
                        inlineTermWs.send(JSON.stringify({ cols: dims.cols, rows: dims.rows }));
                    }
                }
            }
        });
    })();
})();
</script>
{% endblock %}
