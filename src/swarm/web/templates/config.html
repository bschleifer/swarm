{% extends "base.html" %}
{% block title %}Bee Hive — Config{% endblock %}

{% block body %}
<div id="unsaved-banner" class="unsaved-banner" style="display:none">
    Unsaved changes *
</div>
<header>
    <h1><img src="/static/bees/cool.svg" class="bee-icon bee-md" alt="" style="margin-right:0.3rem"><a href="/" class="text-honey no-underline">Bee Hive</a> &mdash; Config</h1>
    <div class="flex-center gap-lg">
        <a href="/dashboard" class="btn btn-secondary no-underline">Dashboard</a>
        <button class="btn" id="save-btn" data-action="saveSettings">Save &amp; Apply</button>
    </div>
</header>

<div class="modal-padding">
    <div class="config-tab-nav">
        <button class="tab-btn active" role="tab" aria-selected="true" data-action="switchConfigTab" data-tab="general"">General</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="drones"">Drones</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="queen"">Queen</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="workers"">Workers</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="groups"">Groups</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="integrations"">Integrations</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="logs"">Debug Log</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="test"">Test</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-action="switchConfigTab" data-tab="usage"">Usage</button>
    </div>

    <!-- General tab -->
    <div id="config-tab-general" class="config-tab">
        <div class="config-section">
            <h3>General</h3>
            <div class="config-field">
                <label>session_name <span class="restart-badge">restart</span></label>
                <input class="config-input w-input" id="cfg-session_name" value="{{ config.session_name }}">
            </div>
            <div class="config-field">
                <label>default_group</label>
                <select class="config-input w-input" id="cfg-default_group">
                    <option value="">(none)</option>
                    {% for g in config.groups %}
                    <option value="{{ g.name }}" {{ 'selected' if config.get('default_group','') == g.name else '' }}>{{ g.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="config-field">
                <label>projects_dir <span class="restart-badge">restart</span></label>
                <input class="config-input w-input" id="cfg-projects_dir" value="{{ config.projects_dir }}">
            </div>
            <div class="config-field">
                <label>log_level</label>
                <select class="config-input w-input" id="cfg-log_level">
                    {% for lvl in ['DEBUG','INFO','WARNING','ERROR'] %}
                    <option value="{{ lvl }}" {{ 'selected' if config.log_level == lvl else '' }}>{{ lvl }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="config-field">
                <label>provider <span class="restart-badge">restart</span></label>
                <select class="config-input w-input" id="cfg-provider">
                    {% for p in ['claude', 'gemini', 'codex'] %}
                    <option value="{{ p }}" {{ 'selected' if config.provider == p else '' }}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="config-section">
            <h3>Notifications</h3>
            <div class="config-field">
                <label>terminal_bell</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-notif-terminal_bell" {{ 'checked' if config.notifications.terminal_bell else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>desktop</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-notif-desktop" {{ 'checked' if config.notifications.desktop else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>debounce_seconds</label>
                <input class="config-input" type="number" step="0.5" min="0" id="cfg-notif-debounce_seconds" value="{{ config.notifications.debounce_seconds }}">
            </div>
        </div>
        <div class="config-section">
            <h3>Action Buttons</h3>
            <p class="help-text">Buttons shown in the dashboard action bar. Drag to reorder, toggle mobile/desktop visibility.</p>
            <div id="action-buttons-list">
                {% for btn in config.get('action_buttons', []) %}
                <div class="approval-rule-row" draggable="true" data-action="{{ btn.action }}" data-command="{{ btn.command }}" data-style="{{ btn.style }}" data-show-mobile="{{ btn.show_mobile }}" data-show-desktop="{{ btn.show_desktop }}">
                    <span class="drag-handle" title="Drag to reorder">&#x2630;</span>
                    <input class="config-input text-left field-xs action-btn-label" placeholder="Label" value="{{ btn.label }}">
                    <select class="config-input w-select-sm action-btn-action" data-change-action="toggleActionCmdDirty">
                        <option value="revive" {{ 'selected' if btn.action == 'revive' else '' }}>Revive</option>
                        <option value="refresh" {{ 'selected' if btn.action == 'refresh' else '' }}>Refresh</option>
                        <option value="queen" {{ 'selected' if btn.action == 'queen' else '' }}>Ask Queen</option>
                        <option value="kill" {{ 'selected' if btn.action == 'kill' else '' }}>Kill</option>
                        <option value="" {{ 'selected' if not btn.action else '' }}>Custom</option>
                    </select>
                    <input class="config-input text-left flex-1 action-btn-command" placeholder="Command (blank = continue)" value="{{ btn.command }}" style="{{ '' if not btn.action else 'display:none' }}">
                    <select class="config-input w-select-sm-2 action-btn-style" data-change-action="markDirty">
                        <option value="secondary" {{ 'selected' if btn.style == 'secondary' else '' }}>Default</option>
                        <option value="queen" {{ 'selected' if btn.style == 'queen' else '' }}>Queen</option>
                        <option value="danger" {{ 'selected' if btn.style == 'danger' else '' }}>Danger</option>
                    </select>
                    <label class="vis-pill{{ ' active' if btn.show_mobile else '' }}" title="Show on mobile" data-action="toggleVisPillDirty"><input type="checkbox" class="action-btn-mobile" {{ 'checked' if btn.show_mobile else '' }}>M</label>
                    <label class="vis-pill{{ ' active' if btn.show_desktop else '' }}" title="Show on desktop" data-action="toggleVisPillDirty"><input type="checkbox" class="action-btn-desktop" {{ 'checked' if btn.show_desktop else '' }}>D</label>
                    <button class="btn btn-sm btn-danger" data-action="removeRowDirty">x</button>
                </div>
                {% endfor %}
            </div>
            <div class="flex-center gap-sm mt-sm">
                <button class="btn btn-sm" data-action="addActionButton">+ Add Custom Button</button>
                <button class="btn btn-sm btn-secondary" data-action="resetActionButtons">Reset to Defaults</button>
            </div>
        </div>
        <div class="config-section">
            <h3>Task Buttons</h3>
            <p class="help-text">Buttons shown on each task row. Drag to reorder, toggle mobile/desktop visibility. Status conditions are automatic.</p>
            <div id="task-buttons-list">
                {% for btn in config.get('task_buttons', []) %}
                <div class="approval-rule-row" draggable="true" data-action="{{ btn.action }}" data-show-mobile="{{ btn.show_mobile }}" data-show-desktop="{{ btn.show_desktop }}">
                    <span class="drag-handle" title="Drag to reorder">&#x2630;</span>
                    <input class="config-input text-left field-xs task-btn-label" placeholder="Label" value="{{ btn.label }}">
                    <select class="config-input w-select-sm task-btn-action" data-change-action="markDirty">
                        <option value="edit" {{ 'selected' if btn.action == 'edit' else '' }}>Edit</option>
                        <option value="assign" {{ 'selected' if btn.action == 'assign' else '' }}>Assign</option>
                        <option value="done" {{ 'selected' if btn.action == 'done' else '' }}>Done</option>
                        <option value="unassign" {{ 'selected' if btn.action == 'unassign' else '' }}>Unassign</option>
                        <option value="fail" {{ 'selected' if btn.action == 'fail' else '' }}>Fail</option>
                        <option value="reopen" {{ 'selected' if btn.action == 'reopen' else '' }}>Reopen</option>
                        <option value="log" {{ 'selected' if btn.action == 'log' else '' }}>Log</option>
                        <option value="retry_draft" {{ 'selected' if btn.action == 'retry_draft' else '' }}>Retry Draft</option>
                        <option value="remove" {{ 'selected' if btn.action == 'remove' else '' }}>Remove</option>
                    </select>
                    <label class="vis-pill{{ ' active' if btn.show_mobile else '' }}" title="Show on mobile" data-action="toggleVisPillDirty"><input type="checkbox" class="task-btn-mobile" {{ 'checked' if btn.show_mobile else '' }}>M</label>
                    <label class="vis-pill{{ ' active' if btn.show_desktop else '' }}" title="Show on desktop" data-action="toggleVisPillDirty"><input type="checkbox" class="task-btn-desktop" {{ 'checked' if btn.show_desktop else '' }}>D</label>
                    <button class="btn btn-sm btn-danger" data-action="removeRowDirty">x</button>
                </div>
                {% endfor %}
            </div>
            <div class="flex-center gap-sm mt-sm">
                <button class="btn btn-sm" data-action="addTaskButton">+ Add Button</button>
                <button class="btn btn-sm btn-secondary" data-action="resetTaskButtons">Reset to Defaults</button>
            </div>
        </div>
        <div class="config-section">
            <h3>Updates</h3>
            <div class="config-field">
                <label>Current version</label>
                <span class="text-muted">{{ version }}</span>
            </div>
            <div class="config-field">
                <label>Check for updates</label>
                <div class="flex-center gap-sm">
                    <button class="btn btn-sm" id="cfg-check-update-btn" data-action="checkForUpdate">Check for Updates</button>
                    <button class="btn btn-sm" id="cfg-install-update-btn" style="display:none; background:var(--leaf); color:#000; font-weight:600;" data-action="installUpdate">Update &amp; Restart</button>
                    <span id="cfg-update-status" class="text-muted" style="font-size:12px;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Drones tab -->
    <div id="config-tab-drones" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Workflows</h3>
            <p class="help-text">
                Map each task type to a Claude Code skill (slash command). Leave blank to use inline instructions.
            </p>
            {% set wf = config.get('workflows', {}) if config.get is defined else {} %}
            {% for ttype in ['bug', 'feature', 'verify', 'chore'] %}
            <div class="config-field">
                <label class="text-upper text-sm w-select-sm-2">{{ ttype }}</label>
                <input class="config-input text-left w-input" id="cfg-workflow-{{ ttype }}"
                       value="{{ wf.get(ttype, '') }}"
                       placeholder="{{ {
                           'bug': '/fix-and-ship',
                           'feature': '/feature',
                           'verify': '/verify',
                           'chore': ''
                       }[ttype] }}"
                       >
            </div>
            {% endfor %}
        </div>
        <div class="config-section">
            <h3>Drones</h3>
            <div class="config-field">
                <label>poll_interval</label>
                <input class="config-input" type="number" step="0.5" min="1" id="cfg-drone-poll_interval" value="{{ config.drones.poll_interval }}">
            </div>
            <div class="config-field">
                <label>escalation_threshold</label>
                <input class="config-input" type="number" step="1" min="0" id="cfg-drone-escalation_threshold" value="{{ config.drones.escalation_threshold }}">
            </div>
            <div class="config-field">
                <label>max_idle_interval</label>
                <input class="config-input" type="number" step="1" min="5" id="cfg-drone-max_idle_interval" value="{{ config.drones.max_idle_interval }}">
            </div>
            <div class="config-field">
                <label>max_revive_attempts</label>
                <input class="config-input" type="number" step="1" min="0" id="cfg-drone-max_revive_attempts" value="{{ config.drones.max_revive_attempts }}">
            </div>
            <div class="config-field">
                <label>max_poll_failures</label>
                <input class="config-input" type="number" step="1" min="1" id="cfg-drone-max_poll_failures" value="{{ config.drones.max_poll_failures }}">
            </div>
            <div class="config-field">
                <label>auto_approve_yn</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-drone-auto_approve_yn" {{ 'checked' if config.drones.auto_approve_yn else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>auto_stop_on_complete</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-drone-auto_stop_on_complete" {{ 'checked' if config.drones.auto_stop_on_complete else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="config-section">
            <h3>Built-in Behavior</h3>
            <p class="help-text">These rules are hardcoded and always active. They cannot be overridden.</p>
            <table class="rule-table mb-xs">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>Condition</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-leaf">BUZZING</td>
                        <td>Worker is actively working</td>
                        <td class="text-muted">Do nothing</td>
                    </tr>
                    <tr>
                        <td class="text-poppy">STUNG</td>
                        <td>Worker exited (revives remaining)</td>
                        <td class="text-honey">Revive</td>
                    </tr>
                    <tr>
                        <td class="text-poppy">STUNG</td>
                        <td>Crash loop (max revives exhausted)</td>
                        <td class="text-amber">Escalate to Queen</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Plan approval prompt detected</td>
                        <td class="text-amber">Always escalate (never auto-approve plans)</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Choice menu (numbered options)</td>
                        <td>Check approval rules below &darr;</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Empty prompt (<code>&gt;</code>)</td>
                        <td class="text-leaf">Press Enter (continue)</td>
                    </tr>
                    <tr>
                        <td class="text-lavender">RESTING</td>
                        <td>Idle at input prompt</td>
                        <td class="text-muted">Do nothing (available, may need attention)</td>
                    </tr>
                    <tr>
                        <td class="text-muted">SLEEPING</td>
                        <td>Idle for &gt; 5 minutes</td>
                        <td class="text-muted">Dimmed; ignored by drones &amp; queen</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Unrecognized state for &gt; {{ config.drones.escalation_threshold }}s</td>
                        <td class="text-amber">Escalate to Queen (once)</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="config-section">
            <h3>Approval Rules</h3>
            <p class="help-text">Applied to choice menus. First matching rule wins. No match falls back to auto-approve.</p>
            <div id="approval-rules-list">
                {% for rule in config.drones.approval_rules %}
                <div class="approval-rule-row">
                    <input class="config-input text-left flex-1" placeholder="Pattern (regex)" value="{{ rule.pattern }}">
                    <select class="config-input w-select-sm">
                        <option value="approve" {{ 'selected' if rule.action == 'approve' else '' }}>Approve</option>
                        <option value="escalate" {{ 'selected' if rule.action == 'escalate' else '' }}>Escalate</option>
                    </select>
                    <button class="btn btn-sm btn-danger" data-action="removeRowDirty">x</button>
                </div>
                {% endfor %}
            </div>
            <div class="flex-center gap-sm mt-sm">
                <button class="btn btn-sm" data-action="addApprovalRule">+ Add Rule</button>
                <button class="btn btn-sm btn-secondary" id="load-defaults-btn" style="display:none" data-action="loadDefaultRules">Load Defaults</button>
            </div>
        </div>
    </div>

    <!-- Queen tab -->
    <div id="config-tab-queen" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Queen</h3>
            <div class="config-field">
                <label>cooldown</label>
                <input class="config-input" type="number" step="1" min="0" id="cfg-queen-cooldown" value="{{ config.queen.cooldown }}">
            </div>
            <div class="config-field">
                <label>enabled</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-queen-enabled" {{ 'checked' if config.queen.enabled else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>min_confidence</label>
                <input type="range" min="0" max="100" step="5" id="cfg-queen-min_confidence"
                       value="{{ (config.queen.min_confidence * 100)|int }}"
                       data-input-action="updateConfDisplay"
                       class="flex-1 field-sm">
                <span id="conf-display" class="confidence-display">{{ (config.queen.min_confidence * 100)|int }}%</span>
            </div>
            <div class="config-field config-field-col">
                <label>system_prompt</label>
                <textarea class="config-input textarea-prompt" id="cfg-queen-system_prompt"
                          rows="50"
                          placeholder="Operator instructions for the Queen...">{{ config.queen.system_prompt or '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Workers tab -->
    <div id="config-tab-workers" class="config-tab" style="display:none">
        <div class="panel">
            <div class="panel-header">
                <span>Workers</span>
                <span class="hint">{{ config.workers|length }} total</span>
            </div>
            <div class="panel-body" id="worker-config-list">
                {% for w in config.workers %}
                <div class="worker-entry" data-worker="{{ w.name }}">
                    <div class="worker-entry-top">
                        <strong class="worker-entry-name">{{ w.name }}</strong>
                        <span class="worker-entry-path">{{ w.path }}</span>
                        <span class="flex-spacer"></span>
                        <select class="config-input worker-entry-provider" data-worker-provider="{{ w.name }}">
                            <option value="" {{ 'selected' if not w.provider else '' }}>{{ config.provider }} (default)</option>
                            {% for p in ['claude', 'gemini', 'codex'] %}
                            <option value="{{ p }}" {{ 'selected' if w.provider == p else '' }}>{{ p }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-sm btn-danger no-shrink" data-action="removeWorker" data-name="{{ w.name }}">Remove</button>
                    </div>
                    <textarea class="config-input worker-entry-desc" placeholder="Description (optional)"
                              data-worker-desc="{{ w.name }}" rows="2">{{ w.description or '' }}</textarea>
                </div>
                {% endfor %}
            </div>
            <div class="config-section-footer">
                <div class="worker-entry worker-entry-add">
                    <div class="worker-entry-top">
                        <input id="new-worker-name" placeholder="Name" class="config-input field-sm">
                        <input id="new-worker-path" list="project-paths" placeholder="Path" class="config-input flex-1">
                        <datalist id="project-paths"></datalist>
                        <select id="new-worker-provider" class="config-input worker-entry-provider">
                            <option value="">{{ config.provider }} (default)</option>
                            <option value="claude">claude</option>
                            <option value="gemini">gemini</option>
                            <option value="codex">codex</option>
                        </select>
                        <button class="btn btn-sm" data-action="addWorker">Add</button>
                    </div>
                    <textarea id="new-worker-desc" class="config-input worker-entry-desc"
                              placeholder="Description (optional)" rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Groups tab -->
    <div id="config-tab-groups" class="config-tab" style="display:none">
        <div class="panel config-max-w">
            <div class="panel-header">
                <span>Groups</span>
                <span class="hint">{{ config.groups|length }} total</span>
            </div>
            <div class="panel-body" id="group-config-list">
                {% for g in config.groups %}
                <div class="group-row" data-group="{{ g.name }}">
                    <div>
                        <strong>{{ g.name }}</strong>
                        <div class="help-text mb-0">{{ g.workers|join(', ') }}</div>
                    </div>
                    <div class="flex-center gap-xs">
                        <button class="btn btn-sm btn-secondary" data-action="editGroup" data-name="{{ g.name }}">Edit</button>
                        <button class="btn btn-sm btn-danger" data-action="removeGroup" data-name="{{ g.name }}">Remove</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="config-section-footer">
                <div class="config-add-form">
                    <input id="new-group-name" placeholder="Group name" class="field-md">
                    <button class="btn btn-sm" data-action="addGroup">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrations tab -->
    <div id="config-tab-integrations" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Microsoft Outlook</h3>
            <p class="text-sm text-muted mb-sm">
                Drag-and-drop emails from <strong>New Outlook</strong> into the task board to create tasks from email.
            </p>
            <p class="text-sm text-muted mb-md">
                <strong class="text-beeswax">Without</strong> Graph: the task gets the email subject line only.<br>
                <strong class="text-leaf">With</strong> Graph: the task gets the full email body, inline images, and file attachments.
            </p>
            <div id="graph-status" class="status-box">
                Checking status...
            </div>

            <details id="graph-setup-guide" class="setup-guide">
                <summary>One-time setup: Register an app in Microsoft Entra</summary>
                <div class="setup-guide-body">
                    <p>
                        Swarm reads your email via the <strong>Microsoft Graph API</strong> using delegated permissions &mdash; it can only read mail you explicitly grant access to.
                        No client secret is needed; Swarm uses the PKCE flow (proof key for code exchange).
                    </p>

                    <p class="text-honey setup-step">Step 1 &mdash; Create the app registration</p>
                    <ol>
                        <li>Open <a href="https://entra.microsoft.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" rel="noopener" class="text-honey">entra.microsoft.com &rarr; App registrations</a></li>
                        <li>Click <strong>+ New registration</strong></li>
                        <li>Name: <code class="text-honey">Swarm</code> (anything you like)</li>
                        <li>Leave &ldquo;Redirect URI&rdquo; blank for now</li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <p class="text-honey setup-step">Step 2 &mdash; Add the redirect URI (important: correct platform)</p>
                    <ol start="6">
                        <li>In your new app, go to <strong>Authentication</strong> in the left sidebar</li>
                        <li>Click <strong>+ Add a platform</strong></li>
                        <li>Choose <strong class="text-honey">Mobile and desktop applications</strong></li>
                        <li>Scroll to <strong>Custom redirect URIs</strong> at the bottom and enter:<br>
                            <code class="text-honey">http://localhost:9090/auth/graph/callback</code>
                            <span class="text-muted text-xs"> &mdash; change 9090 if you use a different port</span>
                        </li>
                        <li>Click <strong>Configure</strong></li>
                    </ol>

                    <p class="text-honey setup-step">Step 3 &mdash; Grant Mail.Read permission</p>
                    <ol start="11">
                        <li>Go to <strong>API permissions</strong> in the left sidebar</li>
                        <li>Click <strong>+ Add a permission</strong> &rarr; <strong>Microsoft Graph</strong> &rarr; <strong>Delegated permissions</strong></li>
                        <li>Search for <code class="text-honey">Mail.Read</code>, check it, and click <strong>Add permissions</strong></li>
                    </ol>

                    <p class="text-honey setup-step">Step 4 &mdash; Copy your IDs</p>
                    <ol start="14">
                        <li>Go to <strong>Overview</strong> in the left sidebar</li>
                        <li>Copy <strong>Application (client) ID</strong> &rarr; paste into the <em>Client ID</em> field below</li>
                        <li>Copy <strong>Directory (tenant) ID</strong> &rarr; paste into the <em>Tenant ID</em> field below</li>
                        <li>Click <strong>Save &amp; Apply</strong> at the top, then click <strong>Connect Microsoft Account</strong></li>
                    </ol>

                    <div class="setup-callout">
                        <strong>Why &ldquo;Mobile and desktop&rdquo;?</strong>
                        Entra offers three platform types. <em>Web</em> requires a client secret.
                        <em>SPA</em> only allows browser-side token exchange.
                        <em>Mobile and desktop</em> supports PKCE with a server-side callback, which is what Swarm uses.
                        If you accidentally picked the wrong one, go to Authentication, delete it, and add the correct platform.
                    </div>
                </div>
            </details>

            <div class="config-field">
                <label>Client ID <span class="hint">(Application ID from Entra Overview)</span></label>
                <input class="config-input text-left w-input-lg" id="cfg-graph-client_id"
                       value="{{ config.get('integrations', {}).get('graph', {}).get('client_id', '') }}"
                       placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
            </div>
            <div class="config-field">
                <label>Tenant ID <span class="hint">(Directory ID from Entra Overview &mdash; or &ldquo;common&rdquo; for personal accounts)</span></label>
                <input class="config-input text-left w-input-lg" id="cfg-graph-tenant_id"
                       value="{{ config.get('integrations', {}).get('graph', {}).get('tenant_id', 'common') }}"
                       placeholder="common">
            </div>
            <div class="flex-center gap-sm mt-md">
                <a id="graph-connect-btn" class="btn no-underline" href="/auth/graph/login">Connect Microsoft Account</a>
                <button id="graph-disconnect-btn" class="btn btn-danger" style="display:none" data-action="disconnectGraph">Disconnect</button>
            </div>
            <p id="graph-help-hint" class="text-xs text-muted mt-sm" style="display:none">
                Tokens are stored locally in <code>~/.swarm/graph_tokens.json</code>.
                Access tokens expire after ~1 hour and refresh automatically.
                Click Disconnect to revoke and delete all stored tokens.
            </p>
        </div>
    </div>

    <!-- Test tab -->
    <div id="config-tab-test" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Test Mode</h3>
            <p class="help-text">Settings for <code>swarm test</code> — the self-contained test runner with auto-shutdown.</p>
            <div class="config-field">
                <label>port <span class="restart-badge">restart</span></label>
                <input class="config-input" type="number" step="1" min="1024" max="65535" id="cfg-test-port" value="{{ config.test.port }}">
            </div>
            <div class="config-field">
                <label>auto_resolve_delay</label>
                <input class="config-input" type="number" step="0.5" min="0" id="cfg-test-auto_resolve_delay" value="{{ config.test.auto_resolve_delay }}">
            </div>
            <div class="config-field">
                <label>auto_complete_min_idle</label>
                <input class="config-input" type="number" step="1" min="1" id="cfg-test-auto_complete_min_idle" value="{{ config.test.auto_complete_min_idle }}">
            </div>
            <div class="config-field">
                <label>report_dir</label>
                <input class="config-input text-left w-input" id="cfg-test-report_dir" value="{{ config.test.report_dir }}">
            </div>
        </div>
        <div class="config-section">
            <h3>Test Modals</h3>
            <p class="help-text">Render mock queen modals locally to preview their appearance.</p>
            <div class="flex-center gap-sm flex-wrap">
                <button class="btn btn-sm" style="background:var(--amber)" data-action="fireTestModal" data-type="escalation"">Escalation</button>
                <button class="btn btn-sm btn-approve" data-action="fireTestModal" data-type="completion"">Completion</button>
                <button class="btn btn-sm" style="background:var(--lavender);color:var(--hive-bg)" data-action="fireTestModal" data-type="assignment"">Assignment</button>
            </div>
            <div id="test-modal-result" class="help-text mt-sm"></div>
        </div>
        <div class="config-section">
            <h3>Test Toasts</h3>
            <p class="help-text">Fire mock toast notifications locally to preview each style.</p>
            <div class="flex-center gap-sm flex-wrap">
                <button class="btn btn-sm btn-secondary" data-action="fireTestToast" data-type="info"">Info Toast</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestToast" data-type="warning"">Warning Toast</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestToast" data-type="worker_down"">Worker Down</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestToast" data-type="task_failed"">Task Failed</button>
                <button class="btn btn-sm" style="background:var(--honey);color:var(--hive-bg)" data-action="fireTestToast" data-type="queen_auto"">Queen Auto-Action</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestToast" data-type="draft_failed"">Draft Failed</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestToast" data-type="send_failed"">Task Send Failed</button>
            </div>
        </div>
        <div class="config-section">
            <h3>Test Desktop Notifications</h3>
            <p class="help-text">Send browser notifications to verify they work. Tab must be hidden (switch tabs after clicking) or use the 5-second delay button. Requires notification permission.</p>
            <div class="flex-center gap-sm flex-wrap mb-sm">
                <button class="btn btn-sm btn-secondary" id="notif-perm-test-btn" data-action="requestTestNotifPermission">&#x1f514; Enable Notifications</button>
            </div>
            <div class="flex-center gap-sm flex-wrap">
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestNotif" data-type="worker_down"">Worker Down</button>
                <button class="btn btn-sm" style="background:var(--amber)" data-action="fireTestNotif" data-type="escalation"">Escalation</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestNotif" data-type="task_failed"">Task Failed</button>
                <button class="btn btn-sm" style="background:var(--lavender);color:var(--hive-bg)" data-action="fireTestNotif" data-type="queen_proposal"">Queen Proposal</button>
                <button class="btn btn-sm" style="background:var(--honey);color:var(--hive-bg)" data-action="fireTestNotif" data-type="queen_auto"">Queen Auto-Action</button>
                <button class="btn btn-sm" style="background:var(--amber)" data-action="fireTestNotif" data-type="queen_input"">Queen Needs Input</button>
                <button class="btn btn-sm btn-approve" data-action="fireTestNotif" data-type="task_complete"">Task Complete</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestNotif" data-type="draft_failed"">Draft Failed</button>
                <button class="btn btn-sm" style="background:var(--poppy)" data-action="fireTestNotif" data-type="send_failed"">Task Send Failed</button>
            </div>
            <div class="flex-center gap-sm flex-wrap mt-sm">
                <button class="btn btn-sm btn-secondary" data-action="fireDelayedTestNotif">Send All (5s delay)</button>
                <span class="help-text mb-0">Switch to another tab within 5 seconds to see the notifications</span>
            </div>
        </div>
    </div>

    <!-- Usage tab -->
    <div id="config-tab-usage" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Token Usage Summary</h3>
            <div id="usage-summary" class="flex-center gap-lg flex-wrap" style="margin-bottom:1rem">
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Total Cost</label>
                    <div id="usage-total-cost" class="text-honey" style="font-size:1.4rem;font-weight:700">$0.00</div>
                </div>
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Input Tokens</label>
                    <div id="usage-total-input" style="font-size:1.1rem;font-weight:600">0</div>
                </div>
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Output Tokens</label>
                    <div id="usage-total-output" style="font-size:1.1rem;font-weight:600">0</div>
                </div>
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Total Tokens</label>
                    <div id="usage-total-tokens" style="font-size:1.1rem;font-weight:600">0</div>
                </div>
            </div>
        </div>
        <div class="config-section">
            <h3>Per-Worker Breakdown</h3>
            <div style="overflow-x:auto">
                <table class="usage-table" style="width:100%;border-collapse:collapse;font-size:0.85rem">
                    <thead>
                        <tr style="border-bottom:1px solid var(--border)">
                            <th style="text-align:left;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="0"">Worker</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="1"">Input</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="2"">Output</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="3"">Cache Read</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="4"">Cache Create</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="5"">Cost</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" data-action="sortUsageTable" data-col="6"">% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="usage-table-body"></tbody>
                </table>
            </div>
            <p class="help-text" style="margin-top:0.5rem">Worker costs are estimated from token counts. Queen cost is exact (from CLI envelope). Auto-refreshes every 30s.</p>
        </div>
    </div>

    <!-- Logs tab -->
    <div id="config-tab-logs" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Debug Log</h3>
            <div class="flex-center gap-sm mb-md">
                <label class="text-muted text-sm">Level:</label>
                <select id="log-level-filter" class="config-input w-select-md" data-change-action="refreshLogs">
                    <option value="">All</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO" selected>INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <label class="text-muted text-sm">Lines:</label>
                <select id="log-lines" class="config-input w-select-sm-2" data-change-action="refreshLogs">
                    <option value="100">100</option>
                    <option value="250">250</option>
                    <option value="500" selected>500</option>
                    <option value="1000">1000</option>
                </select>
                <button class="btn btn-sm" data-action="refreshLogs">Refresh</button>
                <label class="text-muted text-sm ml-xs">
                    <input type="checkbox" id="log-auto-refresh" checked> Auto-refresh
                </label>
                <button class="btn btn-sm btn-danger ml-auto" data-action="clearLogs">Clear Log</button>
            </div>
            <pre id="log-output" class="log-output"></pre>
        </div>
    </div>
</div>

<!-- Group edit modal (hidden) -->
<div id="group-edit-modal" class="modal-overlay" style="display:none" data-modal-dismiss="hideGroupEdit">
    <div class="modal-box modal-sm" role="dialog" aria-modal="true">
        <div class="panel-header">
            <span>Edit Group</span>
            <button class="btn btn-sm btn-secondary" data-action="hideGroupEdit">Close</button>
        </div>
        <div class="group-edit-body">
            <div class="mb-xs">
                <label>Group Name</label>
                <input class="config-input text-left modal-input" id="group-edit-name-input">
            </div>
            <div id="group-edit-body"></div>
        </div>
        <div class="modal-actions config-section-footer justify-end">
            <button class="btn btn-secondary" data-action="hideGroupEdit">Cancel</button>
            <button class="btn" data-action="saveGroupEdit">Save</button>
        </div>
    </div>
</div>


<!-- Test modal overlay (hidden) -->
<div id="queen-modal" class="modal-overlay" style="display:none" data-modal-dismiss="hideQueen">
    <div class="modal-box modal-lg" role="dialog" aria-modal="true">
        <div class="panel-header btn-queen">
            <span><img src="/static/bees/queen.svg" class="bee-icon bee-md" alt="" style="margin-right:0.3rem">Queen — Hive Conductor</span>
            <button class="btn btn-sm btn-close" data-action="hideQueen">Close</button>
        </div>
        <div id="queen-result" class="modal-body modal-body-scroll">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-action="hideQueen">Close</button>
        </div>
    </div>
</div>

<!-- File changed banner (hidden) -->
<div id="file-changed-banner" class="file-changed-banner" style="display:none">
    <span class="text-honey">Config file changed on disk</span>
    <button class="btn btn-sm" data-action="reload">Reload</button>
    <button class="btn btn-sm btn-secondary" data-action="dismissBanner">Dismiss</button>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
(function() {
    let apiPassword = sessionStorage.getItem('swarm_api_password') || '';
    let ws = null;

    function authHeaders() {
        const h = { 'Content-Type': 'application/json', 'X-Requested-With': 'SwarmWeb' };
        if (apiPassword) h['Authorization'] = 'Bearer ' + apiPassword;
        return h;
    }

    function requireAuth() {
        if (!apiPassword) {
            const pw = prompt('API password required:');
            if (!pw) return false;
            apiPassword = pw;
            sessionStorage.setItem('swarm_api_password', pw);
        }
        return true;
    }

    async function authFetch(url, opts) {
        opts = opts || {};
        opts.headers = authHeaders();
        const resp = await fetch(url, opts);
        if (resp.status === 401) {
            sessionStorage.removeItem('swarm_api_password');
            apiPassword = '';
            showToast('Authentication failed — try again', true);
            return null;
        }
        return resp;
    }

    // Toast
    function escapeHtmlToast(str) {
        var d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }
    function showToast(msg, warning) {
        const container = document.getElementById('toasts');
        const toast = document.createElement('div');
        toast.className = 'toast' + (warning ? ' toast-warning' : '');
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        var bee = warning ? '/static/bees/angry.svg' : '/static/bees/happy.svg';
        toast.innerHTML = '<img src="' + bee + '" class="bee-icon bee-md toast-bee" alt="">' + escapeHtmlToast(msg);
        container.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3500);
    }

    // Load project paths for dropdown
    fetch('/api/config/projects')
        .then(r => r.json())
        .then(data => {
            const dl = document.getElementById('project-paths');
            for (const p of data.projects || []) {
                const opt = document.createElement('option');
                opt.value = p.path;
                opt.textContent = p.name;
                dl.appendChild(opt);
            }
        });

    // --- Tab switching ---
    window.switchConfigTab = function(name) {
        document.querySelectorAll('.config-tab').forEach(function(t) { t.style.display = 'none'; });
        document.querySelectorAll('.config-tab-nav .tab-btn').forEach(function(b) { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
        var tab = document.getElementById('config-tab-' + name);
        if (tab) tab.style.display = 'block';
        // Mark the clicked button active
        var btns = document.querySelectorAll('.config-tab-nav .tab-btn');
        for (var i = 0; i < btns.length; i++) {
            if (btns[i].textContent.trim().toLowerCase() === name) { btns[i].classList.add('active'); btns[i].setAttribute('aria-selected', 'true'); }
        }
    };

    // --- Approval Rules ---
    function updateDefaultsBtn() {
        var list = document.getElementById('approval-rules-list');
        var btn = document.getElementById('load-defaults-btn');
        if (btn) btn.style.display = (list && list.children.length === 0) ? 'inline-block' : 'none';
    }
    updateDefaultsBtn();

    window.loadDefaultRules = function() {
        var defaults = [
            {pattern: '\\bplan\\b', action: 'escalate'},
            {pattern: '^(Yes|Allow|Continue|Accept)', action: 'approve'},
            {pattern: 'delete|remove|drop|destroy', action: 'escalate'},
            {pattern: '.*', action: 'approve'},
        ];
        for (var i = 0; i < defaults.length; i++) {
            addApprovalRule(defaults[i].pattern, defaults[i].action);
        }
        markDirty();
        updateDefaultsBtn();
    };

    window.addApprovalRule = function(defaultPattern, defaultAction) {
        var list = document.getElementById('approval-rules-list');
        var row = document.createElement('div');
        row.className = 'approval-rule-row';
        var escAction = (defaultAction === 'escalate') ? 'escalate' : 'approve';
        var approveSelected = escAction === 'approve' ? ' selected' : '';
        var escalateSelected = escAction === 'escalate' ? ' selected' : '';
        row.innerHTML = '<input class="config-input text-left flex-1" placeholder="Pattern (regex)" value="' + (defaultPattern || '') + '">'
            + '<select class="config-input w-select-sm"><option value="approve"' + approveSelected + '>Approve</option><option value="escalate"' + escalateSelected + '>Escalate</option></select>'
            + '<button class="btn btn-sm btn-danger" data-action="removeRuleDirty">x</button>';
        list.appendChild(row);
        markDirty();
        updateDefaultsBtn();
    };

    function collectApprovalRules() {
        var rules = [];
        document.querySelectorAll('#approval-rules-list .approval-rule-row').forEach(function(row) {
            var pattern = row.querySelector('input').value.trim();
            var action = row.querySelector('select').value;
            if (pattern) rules.push({pattern: pattern, action: action});
        });
        return rules;
    }

    // --- Drag-and-drop reorder for button lists ---
    function initDragReorder(listEl) {
        var dragRow = null;
        listEl.addEventListener('dragstart', function(e) {
            var row = e.target.closest('.approval-rule-row');
            if (!row) return;
            dragRow = row;
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        listEl.addEventListener('dragend', function(e) {
            var row = e.target.closest('.approval-rule-row');
            if (row) row.classList.remove('dragging');
            listEl.querySelectorAll('.drag-over').forEach(function(el) { el.classList.remove('drag-over'); });
            dragRow = null;
        });
        listEl.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            var target = e.target.closest('.approval-rule-row');
            if (!target || target === dragRow) return;
            listEl.querySelectorAll('.drag-over').forEach(function(el) { el.classList.remove('drag-over'); });
            target.classList.add('drag-over');
        });
        listEl.addEventListener('dragleave', function(e) {
            var target = e.target.closest('.approval-rule-row');
            if (target) target.classList.remove('drag-over');
        });
        listEl.addEventListener('drop', function(e) {
            e.preventDefault();
            var target = e.target.closest('.approval-rule-row');
            if (!target || !dragRow || target === dragRow) return;
            target.classList.remove('drag-over');
            // Insert before or after based on position
            var rect = target.getBoundingClientRect();
            var mid = rect.top + rect.height / 2;
            if (e.clientY < mid) {
                listEl.insertBefore(dragRow, target);
            } else {
                listEl.insertBefore(dragRow, target.nextSibling);
            }
            markDirty();
        });
    }

    // Initialize drag-and-drop on button lists
    var actionList = document.getElementById('action-buttons-list');
    var taskList = document.getElementById('task-buttons-list');
    if (actionList) initDragReorder(actionList);
    if (taskList) initDragReorder(taskList);

    // Toggle visibility pill (M/D buttons)
    window.toggleVisPill = function(label) {
        var cb = label.querySelector('input[type="checkbox"]');
        cb.checked = !cb.checked;
        label.classList.toggle('active', cb.checked);
    };

    // --- Action Buttons ---
    function buildActionBtnRow(label, action, command, style, showMobile, showDesktop) {
        var row = document.createElement('div');
        row.className = 'approval-rule-row';
        row.draggable = true;
        var actions = ['revive','refresh','queen','kill',''];
        var actionLabels = ['Revive','Refresh','Ask Queen','Kill','Custom'];
        var styles = ['secondary','queen','danger'];
        var styleLabels = ['Default','Queen','Danger'];
        var selAction = '';
        for (var i = 0; i < actions.length; i++) {
            selAction += '<option value="' + actions[i] + '"' + (actions[i] === action ? ' selected' : '') + '>' + actionLabels[i] + '</option>';
        }
        var selStyle = '';
        for (var j = 0; j < styles.length; j++) {
            selStyle += '<option value="' + styles[j] + '"' + (styles[j] === style ? ' selected' : '') + '>' + styleLabels[j] + '</option>';
        }
        var cmdDisplay = action ? 'display:none' : '';
        row.innerHTML = '<span class="drag-handle" title="Drag to reorder">&#x2630;</span>'
            + '<input class="config-input text-left field-xs action-btn-label" placeholder="Label" value="' + (label || '') + '">'
            + '<select class="config-input w-select-sm action-btn-action" data-change-action="toggleActionCmdDirty">' + selAction + '</select>'
            + '<input class="config-input text-left flex-1 action-btn-command" placeholder="Command (blank = continue)" value="' + (command || '') + '" style="' + cmdDisplay + '">'
            + '<select class="config-input w-select-sm-2 action-btn-style" data-change-action="markDirty">' + selStyle + '</select>'
            + '<label class="vis-pill' + (showMobile !== false ? ' active' : '') + '" title="Show on mobile" data-action="toggleVisPillDirty"><input type="checkbox" class="action-btn-mobile"' + (showMobile !== false ? ' checked' : '') + '>M</label>'
            + '<label class="vis-pill' + (showDesktop !== false ? ' active' : '') + '" title="Show on desktop" data-action="toggleVisPillDirty"><input type="checkbox" class="action-btn-desktop"' + (showDesktop !== false ? ' checked' : '') + '>D</label>'
            + '<button class="btn btn-sm btn-danger" data-action="removeRowDirty">x</button>';
        return row;
    }

    window.addActionButton = function() {
        var list = document.getElementById('action-buttons-list');
        list.appendChild(buildActionBtnRow('', '', '', 'secondary', true, true));
        markDirty();
    };

    window.resetActionButtons = function() {
        var list = document.getElementById('action-buttons-list');
        list.innerHTML = '';
        var defaults = [
            {label:'Revive', action:'revive', style:'secondary'},
            {label:'Refresh', action:'refresh', style:'secondary'},
            {label:'Ask Queen', action:'queen', style:'queen'},
            {label:'Kill', action:'kill', style:'danger'},
        ];
        for (var i = 0; i < defaults.length; i++) {
            var d = defaults[i];
            list.appendChild(buildActionBtnRow(d.label, d.action, '', d.style, true, true));
        }
        markDirty();
    };

    window.toggleActionCmd = function(row) {
        var sel = row.querySelector('.action-btn-action');
        var cmd = row.querySelector('.action-btn-command');
        cmd.style.display = sel.value ? 'none' : '';
    };

    // --- Task Buttons ---
    function buildTaskBtnRow(label, action, showMobile, showDesktop) {
        var row = document.createElement('div');
        row.className = 'approval-rule-row';
        row.draggable = true;
        var actions = ['edit','assign','done','unassign','fail','reopen','log','retry_draft','remove'];
        var actionLabels = ['Edit','Assign','Done','Unassign','Fail','Reopen','Log','Retry Draft','Remove'];
        var selAction = '';
        for (var i = 0; i < actions.length; i++) {
            selAction += '<option value="' + actions[i] + '"' + (actions[i] === action ? ' selected' : '') + '>' + actionLabels[i] + '</option>';
        }
        row.innerHTML = '<span class="drag-handle" title="Drag to reorder">&#x2630;</span>'
            + '<input class="config-input text-left field-xs task-btn-label" placeholder="Label" value="' + (label || '') + '">'
            + '<select class="config-input w-select-sm task-btn-action" data-change-action="markDirty">' + selAction + '</select>'
            + '<label class="vis-pill' + (showMobile !== false ? ' active' : '') + '" title="Show on mobile" data-action="toggleVisPillDirty"><input type="checkbox" class="task-btn-mobile"' + (showMobile !== false ? ' checked' : '') + '>M</label>'
            + '<label class="vis-pill' + (showDesktop !== false ? ' active' : '') + '" title="Show on desktop" data-action="toggleVisPillDirty"><input type="checkbox" class="task-btn-desktop"' + (showDesktop !== false ? ' checked' : '') + '>D</label>'
            + '<button class="btn btn-sm btn-danger" data-action="removeRowDirty">x</button>';
        return row;
    }

    window.addTaskButton = function() {
        var list = document.getElementById('task-buttons-list');
        list.appendChild(buildTaskBtnRow('', 'edit', true, true));
        markDirty();
    };

    window.resetTaskButtons = function() {
        var list = document.getElementById('task-buttons-list');
        list.innerHTML = '';
        var defaults = [
            {label:'Edit', action:'edit'},
            {label:'Assign', action:'assign'},
            {label:'Done', action:'done'},
            {label:'Unassign', action:'unassign'},
            {label:'Fail', action:'fail'},
            {label:'Reopen', action:'reopen'},
            {label:'Log', action:'log'},
            {label:'Retry Draft', action:'retry_draft'},
            {label:'\u00d7', action:'remove'},
        ];
        for (var i = 0; i < defaults.length; i++) {
            var d = defaults[i];
            list.appendChild(buildTaskBtnRow(d.label, d.action, true, true));
        }
        markDirty();
    };

    function collectTaskButtons() {
        var buttons = [];
        document.querySelectorAll('#task-buttons-list .approval-rule-row').forEach(function(row) {
            var label = row.querySelector('.task-btn-label').value.trim();
            if (!label) return;
            var action = row.querySelector('.task-btn-action').value;
            if (!action) return;
            var showMobile = row.querySelector('.task-btn-mobile').checked;
            var showDesktop = row.querySelector('.task-btn-desktop').checked;
            buttons.push({label: label, action: action, show_mobile: showMobile, show_desktop: showDesktop});
        });
        return buttons;
    }

    function collectActionButtons() {
        var buttons = [];
        document.querySelectorAll('#action-buttons-list .approval-rule-row').forEach(function(row) {
            var label = row.querySelector('.action-btn-label').value.trim();
            if (!label) return;
            var action = row.querySelector('.action-btn-action').value;
            var command = row.querySelector('.action-btn-command').value.trim();
            var style = row.querySelector('.action-btn-style').value;
            var showMobile = row.querySelector('.action-btn-mobile').checked;
            var showDesktop = row.querySelector('.action-btn-desktop').checked;
            buttons.push({label: label, action: action, command: command, style: style, show_mobile: showMobile, show_desktop: showDesktop});
        });
        return buttons;
    }

    // Save & Apply
    window.saveSettings = function() {
        if (!requireAuth()) return;
        // Collect worker descriptions and providers
        const workerData = {};
        document.querySelectorAll('[data-worker-desc]').forEach(function(el) {
            var name = el.dataset.workerDesc;
            workerData[name] = { description: el.value };
        });
        document.querySelectorAll('[data-worker-provider]').forEach(function(el) {
            var name = el.dataset.workerProvider;
            if (workerData[name]) {
                workerData[name].provider = el.value;
            }
        });
        const body = {
            workers: workerData,
            provider: document.getElementById('cfg-provider').value,
            session_name: document.getElementById('cfg-session_name').value,
            default_group: document.getElementById('cfg-default_group').value,
            projects_dir: document.getElementById('cfg-projects_dir').value,
            log_level: document.getElementById('cfg-log_level').value,
            drones: {
                poll_interval: parseFloat(document.getElementById('cfg-drone-poll_interval').value),
                escalation_threshold: parseFloat(document.getElementById('cfg-drone-escalation_threshold').value),
                max_idle_interval: parseFloat(document.getElementById('cfg-drone-max_idle_interval').value),
                max_revive_attempts: parseInt(document.getElementById('cfg-drone-max_revive_attempts').value),
                max_poll_failures: parseInt(document.getElementById('cfg-drone-max_poll_failures').value),
                auto_approve_yn: document.getElementById('cfg-drone-auto_approve_yn').checked,
                auto_stop_on_complete: document.getElementById('cfg-drone-auto_stop_on_complete').checked,
                approval_rules: collectApprovalRules(),
            },
            queen: {
                cooldown: parseFloat(document.getElementById('cfg-queen-cooldown').value),
                enabled: document.getElementById('cfg-queen-enabled').checked,
                system_prompt: document.getElementById('cfg-queen-system_prompt').value,
                min_confidence: parseInt(document.getElementById('cfg-queen-min_confidence').value) / 100.0,
            },
            notifications: {
                terminal_bell: document.getElementById('cfg-notif-terminal_bell').checked,
                desktop: document.getElementById('cfg-notif-desktop').checked,
                debounce_seconds: parseFloat(document.getElementById('cfg-notif-debounce_seconds').value),
            },
            graph_client_id: (document.getElementById('cfg-graph-client_id') || {}).value || '',
            graph_tenant_id: (document.getElementById('cfg-graph-tenant_id') || {}).value || 'common',
            workflows: (function() {
                var wf = {};
                ['bug','feature','verify','chore'].forEach(function(t) {
                    var el = document.getElementById('cfg-workflow-' + t);
                    if (el && el.value.trim()) wf[t] = el.value.trim();
                });
                return wf;
            })(),
            action_buttons: collectActionButtons(),
            task_buttons: collectTaskButtons(),
            test: {
                port: parseInt(document.getElementById('cfg-test-port').value),
                auto_resolve_delay: parseFloat(document.getElementById('cfg-test-auto_resolve_delay').value),
                auto_complete_min_idle: parseFloat(document.getElementById('cfg-test-auto_complete_min_idle').value),
                report_dir: document.getElementById('cfg-test-report_dir').value,
            },
        };
        authFetch('/api/config', { method: 'PUT', body: JSON.stringify(body) })
            .then(r => { if (r && r.ok) showToast('Config saved & applied'); else if (r) r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true)); });
    }

    // Worker CRUD
    window.addWorker = function() {
        if (!requireAuth()) return;
        const name = document.getElementById('new-worker-name').value.trim();
        const path = document.getElementById('new-worker-path').value.trim();
        const provider = document.getElementById('new-worker-provider').value;
        const desc = document.getElementById('new-worker-desc').value.trim();
        if (!name || !path) { showToast('Name and path required', true); return; }
        authFetch('/api/config/workers', {
            method: 'POST',
            body: JSON.stringify({ name: name, path: path, provider: provider, description: desc }),
        }).then(r => {
            if (!r) return;
            if (r.ok) {
                showToast('Worker "' + name + '" added');
                setTimeout(() => location.reload(), 500);
            } else {
                r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
            }
        });
    }

    window.removeWorker = function(name) {
        if (!requireAuth()) return;
        if (!confirm('Remove worker "' + name + '"? Active tasks will return to PENDING.')) return;
        authFetch('/api/config/workers/' + encodeURIComponent(name), { method: 'DELETE' })
            .then(r => {
                if (!r) return;
                if (r.ok) {
                    showToast('Worker "' + name + '" removed');
                    const row = document.querySelector('[data-worker="' + name + '"]');
                    if (row) row.remove();
                } else {
                    r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
                }
            });
    }

    // Group CRUD
    window.addGroup = function() {
        if (!requireAuth()) return;
        const name = document.getElementById('new-group-name').value.trim();
        if (!name) { showToast('Group name required', true); return; }
        authFetch('/api/config/groups', {
            method: 'POST',
            body: JSON.stringify({ name: name, workers: [] }),
        }).then(r => {
            if (!r) return;
            if (r.ok) {
                showToast('Group "' + name + '" added');
                setTimeout(() => location.reload(), 500);
            } else {
                r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
            }
        });
    }

    let editingGroupName = null;

    window.editGroup = function(name) {
        if (!requireAuth()) return;
        editingGroupName = name;
        document.getElementById('group-edit-name-input').value = name;

        // Build checkboxes for all known workers
        var allWorkers = {{ config.workers|map(attribute='name')|list|tojson }};
        // Find current group members
        var currentMembers = [];
        {% for g in config.groups %}
        if ({{ g.name|tojson }} === name) currentMembers = {{ g.workers|tojson }};
        {% endfor %}
        var memberSet = new Set(currentMembers.map(function(s) { return s.toLowerCase(); }));

        var html = '';
        for (var i = 0; i < allWorkers.length; i++) {
            var wn = allWorkers[i];
            var checked = memberSet.has(wn.toLowerCase()) ? ' checked' : '';
            html += '<label class="group-member-label">';
            html += '<input type="checkbox" class="group-member-cb cb-spaced" value="' + wn + '"' + checked + '>';
            html += wn + '</label>';
        }
        document.getElementById('group-edit-body').innerHTML = html;
        document.getElementById('group-edit-modal').style.display = 'flex';
    };

    window.hideGroupEdit = function() {
        document.getElementById('group-edit-modal').style.display = 'none';
        editingGroupName = null;
    };

    window.saveGroupEdit = function() {
        if (!editingGroupName) return;
        var newName = document.getElementById('group-edit-name-input').value.trim();
        var workers = [];
        document.querySelectorAll('.group-member-cb:checked').forEach(function(cb) {
            workers.push(cb.value);
        });
        var payload = { workers: workers };
        if (newName && newName !== editingGroupName) payload.name = newName;
        authFetch('/api/config/groups/' + encodeURIComponent(editingGroupName), {
            method: 'PUT',
            body: JSON.stringify(payload),
        }).then(r => {
            if (!r) return;
            if (r.ok) {
                showToast('Group "' + editingGroupName + '" updated');
                hideGroupEdit();
                setTimeout(() => location.reload(), 500);
            } else {
                r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
            }
        });
    };

    window.removeGroup = function(name) {
        if (!requireAuth()) return;
        authFetch('/api/config/groups/' + encodeURIComponent(name), { method: 'DELETE' })
            .then(r => {
                if (!r) return;
                if (r.ok) {
                    showToast('Group "' + name + '" removed');
                    const row = document.querySelector('[data-group="' + name + '"]');
                    if (row) row.remove();
                } else {
                    r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
                }
            });
    }

    // --- Unsaved changes tracking ---
    let configDirty = false;

    window.markDirty = function() {
        if (!configDirty) {
            configDirty = true;
            document.getElementById('unsaved-banner').style.display = 'block';
        }
    }

    function clearDirty() {
        configDirty = false;
        document.getElementById('unsaved-banner').style.display = 'none';
    }

    // Track changes on all config inputs (including worker descriptions)
    document.querySelectorAll('.config-input, .toggle-switch input, [data-worker-desc], input[type="range"]').forEach(function(el) {
        el.addEventListener('change', markDirty);
        el.addEventListener('input', markDirty);
    });

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (configDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Clear dirty flag after successful save
    var origSave = window.saveSettings;
    window.saveSettings = function() {
        origSave();
        // Clear dirty after a short delay (assuming save succeeds)
        setTimeout(clearDirty, 500);
    };

    // --- Client-side validation ---
    function validateNumericField(id, min, label) {
        var el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('blur', function() {
            var val = parseFloat(el.value);
            if (isNaN(val) || val < min) {
                el.style.borderColor = 'var(--poppy)';
                el.title = label + ' must be >= ' + min;
            } else {
                el.style.borderColor = '';
                el.title = '';
            }
        });
    }

    validateNumericField('cfg-drone-poll_interval', 1, 'poll_interval');
    validateNumericField('cfg-drone-escalation_threshold', 0, 'escalation_threshold');
    validateNumericField('cfg-drone-max_idle_interval', 5, 'max_idle_interval');
    validateNumericField('cfg-drone-max_revive_attempts', 0, 'max_revive_attempts');
    validateNumericField('cfg-drone-max_poll_failures', 1, 'max_poll_failures');
    validateNumericField('cfg-queen-cooldown', 0, 'cooldown');
    validateNumericField('cfg-notif-debounce_seconds', 0, 'debounce_seconds');
    validateNumericField('cfg-test-port', 1024, 'test.port');
    validateNumericField('cfg-test-auto_resolve_delay', 0, 'test.auto_resolve_delay');
    validateNumericField('cfg-test-auto_complete_min_idle', 1, 'test.auto_complete_min_idle');

    // Esc closes modals
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var qm = document.getElementById('queen-modal');
            if (qm && qm.style.display !== 'none') { hideQueen(); return; }
            var modal = document.getElementById('group-edit-modal');
            if (modal && modal.style.display !== 'none') hideGroupEdit();
        }
    });

    // --- Test Modals (rendered locally) ---
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function queenSummaryLine(type, data) {
        var w = escapeHtml(data.worker || data.worker_name || '?');
        if (type === 'completion') {
            var t = escapeHtml(data.task_title || 'task');
            return 'Mark \u201c' + t + '\u201d complete for <strong class="text-lavender">' + w + '</strong>';
        }
        if (type === 'assignment') {
            var t = escapeHtml(data.task_title || 'task');
            return 'Assign \u201c' + t + '\u201d to <strong class="text-lavender">' + w + '</strong>';
        }
        var a = data.action || 'wait';
        var labels = {
            send_message: 'Send command to <strong class="text-lavender">' + w + '</strong>',
            continue: 'Continue execution for <strong class="text-lavender">' + w + '</strong>',
            restart: 'Restart <strong class="text-lavender">' + w + '</strong>',
            complete_task: 'Complete task for <strong class="text-lavender">' + w + '</strong>',
            wait: 'No action needed for <strong class="text-lavender">' + w + '</strong>'
        };
        return labels[a] || escapeHtml(a) + ' \u2014 <strong class="text-lavender">' + w + '</strong>';
    }

    window.hideQueen = function() {
        document.getElementById('queen-modal').style.display = 'none';
    };

    function showTestEscalation() {
        var data = {
            worker: 'test-worker',
            assessment: 'Worker appears stuck in a retry loop \u2014 build fails with a missing dependency, retried 3 times.',
            reasoning: 'Idle for 120s after three consecutive failed builds. Manual intervention needed.',
            action: 'send_message',
            message: 'npm install missing-package@latest',
            confidence: 0.78
        };
        var confPct = Math.round(data.confidence * 100);
        var confClass = confPct >= 70 ? 'conf-high' : confPct >= 40 ? 'conf-mid' : 'conf-low';
        var actionLabels = {send_message: 'Send message', continue: 'Continue execution', restart: 'Restart worker', complete_task: 'Complete task', wait: 'Wait'};
        var html = '<div class="queen-card queen-card-escalation">';
        html += '<div class="queen-card-header">';
        html += '<span class="conf-badge conf-mid"><img src="/static/bees/surprised.svg" class="bee-icon bee-xs" alt="" style="margin-right:0.2rem">ESCALATION</span>';
        html += '<span class="conf-badge ' + confClass + '">Confidence: ' + confPct + '%</span>';
        html += '</div>';
        html += '<div class="queen-summary">' + queenSummaryLine('escalation', data) + '</div>';
        html += '<div class="mb-sm queen-text-block"><strong class="text-honey">Analysis</strong><br>' + escapeHtml(data.assessment) + ' ' + escapeHtml(data.reasoning) + '</div>';
        var label = actionLabels[data.action] || data.action;
        html += '<div class="queen-recommends-callout"><img src="/static/bees/queen.svg" class="bee-icon bee-sm" alt=""><span><strong class="text-honey">Queen recommends</strong>: <span class="text-lavender">' + escapeHtml(label) + '</span></span></div>';
        html += '<div class="queen-code-block mb-sm">' + escapeHtml(data.message) + '</div>';
        html += '</div>';
        html += '<div class="modal-footer">';
        html += '<button class="btn btn-approve" data-action="queenTestApprove">Approve</button>';
        html += '<button class="btn btn-reject-ghost" data-action="queenTestReject">Reject</button>';
        html += '</div>';
        document.getElementById('queen-result').innerHTML = html;
        document.getElementById('queen-modal').style.display = 'flex';
    }

    function showTestCompletion() {
        var data = {
            worker: 'test-worker',
            task_title: 'Fix login page validation bug',
            assessment: 'All form validation errors now display inline. Added unit tests for empty email and short password.',
            reasoning: 'Committed changes to auth/login.tsx and tests/login.test.ts. CI passed on branch.',
            confidence: 0.92,
            has_source_email: true
        };
        var confPct = Math.round(data.confidence * 100);
        var confClass = confPct >= 70 ? 'conf-high' : confPct >= 40 ? 'conf-mid' : 'conf-low';
        var html = '<div class="queen-card queen-card-complete">';
        html += '<div class="queen-card-header">';
        html += '<span class="conf-badge conf-high"><img src="/static/bees/honey-jar.svg" class="bee-icon bee-xs" alt="" style="margin-right:0.2rem">TASK COMPLETE</span>';
        html += '<span class="conf-badge ' + confClass + '">Confidence: ' + confPct + '%</span>';
        html += '</div>';
        html += '<div class="queen-summary">' + queenSummaryLine('completion', data) + '</div>';
        html += '<div class="resolution-block queen-text-block"><strong class="text-leaf text-base">Resolution</strong><br><span class="ws-pre-wrap">' + escapeHtml(data.assessment) + ' ' + escapeHtml(data.reasoning) + '</span></div>';
        html += '<label class="flex-center gap-xs text-base text-beeswax draft-label">';
        html += '<input type="checkbox" checked class="checkbox-leaf">';
        html += 'Draft Response &mdash; reply-all to source email</label>';
        html += '</div>';
        html += '<div class="modal-footer">';
        html += '<button class="btn btn-approve" data-action="queenTestApprove">Approve &amp; Complete</button>';
        html += '<button class="btn btn-reject-ghost" data-action="queenTestReject">Reject</button>';
        html += '</div>';
        document.getElementById('queen-result').innerHTML = html;
        document.getElementById('queen-modal').style.display = 'flex';
    }

    function showTestAssignment() {
        var data = {
            worker_name: 'test-worker',
            task_title: 'Add dark mode toggle',
            reasoning: 'Lightest load and familiar with the settings module from a previous task.',
            message: 'Implement a theme toggle in the settings panel using CSS variables.',
            confidence: 0.85
        };
        var confPct = Math.round(data.confidence * 100);
        var confClass = confPct >= 70 ? 'conf-high' : confPct >= 40 ? 'conf-mid' : 'conf-low';
        var html = '<div class="queen-card queen-card-assign">';
        html += '<div class="queen-card-header">';
        html += '<span class="conf-badge conf-badge-assign"><img src="/static/bees/flying-right.svg" class="bee-icon bee-xs" alt="" style="margin-right:0.2rem">ASSIGN</span>';
        html += '<span class="conf-badge ' + confClass + '">Confidence: ' + confPct + '%</span>';
        html += '</div>';
        html += '<div class="queen-summary">' + queenSummaryLine('assignment', data) + '</div>';
        html += '<div class="mb-sm queen-text-block"><strong class="text-honey">Reasoning</strong><br>' + escapeHtml(data.reasoning) + '</div>';
        html += '<div class="mb-sm"><strong class="text-honey">Message to worker</strong></div>';
        html += '<div class="queen-code-block">' + escapeHtml(data.message) + '</div>';
        html += '</div>';
        html += '<div class="modal-footer">';
        html += '<button class="btn btn-approve" data-action="queenTestApprove">Approve</button>';
        html += '<button class="btn btn-reject-ghost" data-action="queenTestReject">Reject</button>';
        html += '</div>';
        document.getElementById('queen-result').innerHTML = html;
        document.getElementById('queen-modal').style.display = 'flex';
    }

    window.fireTestModal = function(type) {
        if (type === 'escalation') showTestEscalation();
        else if (type === 'completion') showTestCompletion();
        else if (type === 'assignment') showTestAssignment();
    };

    // --- Test Toasts ---
    window.fireTestToast = function(type) {
        var beeMap = {
            info: '/static/bees/happy.svg',
            warning: '/static/bees/angry.svg',
            worker_down: '/static/bees/sleeping.svg',
            task_failed: '/static/bees/angry.svg',
            queen_auto: '/static/bees/queen.svg',
            draft_failed: '/static/bees/angry.svg',
            send_failed: '/static/bees/angry.svg',
        };
        var msgs = {
            info: 'Mock notification \u2014 this is a test toast message',
            warning: 'Mock warning \u2014 something needs attention',
            worker_down: 'test-worker exited (STUNG)',
            task_failed: 'Fix login bug \u2014 marked as failed',
            queen_auto: 'Queen auto-acted on test-worker: continue (85% confidence)',
            draft_failed: 'Draft reply FAILED: Graph token expired',
            send_failed: 'Task send FAILED to test-worker: Add dark mode \u2014 returned to pending',
        };
        var warns = { info: false, warning: true, worker_down: true, task_failed: true, queen_auto: false, draft_failed: true, send_failed: true };
        var bee = beeMap[type] || '/static/bees/happy.svg';
        var container = document.getElementById('toasts');
        var toast = document.createElement('div');
        toast.className = 'toast' + (warns[type] ? ' toast-warning' : '');
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.innerHTML = '<img src="' + bee + '" class="bee-icon bee-md toast-bee" alt="">' + escapeHtml(msgs[type] || 'Test toast');
        container.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3500);
    };

    // --- Test Desktop Notifications ---
    var NOTIF_TEST_ICON_MAP = {
        'Worker Down': '/static/bees/png/sleeping.png',
        'Escalation': '/static/bees/png/surprised.png',
        'Task Failed': '/static/bees/png/angry.png',
        'Queen Proposal': '/static/bees/png/queen.png',
        'Queen Auto-Action': '/static/bees/png/queen.png',
        'Queen needs your input': '/static/bees/png/thinking.png',
        'Task complete': '/static/bees/png/honey-jar.png',
        'Draft Failed': '/static/bees/png/angry.png',
        'Task Send Failed': '/static/bees/png/angry.png',
    };

    function updateTestNotifButton() {
        var btn = document.getElementById('notif-perm-test-btn');
        if (!btn) return;
        if (!('Notification' in window)) {
            btn.textContent = 'Not supported';
            btn.disabled = true;
            return;
        }
        if (Notification.permission === 'granted') {
            btn.textContent = '\u2705 Notifications enabled';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-active');
        } else if (Notification.permission === 'denied') {
            btn.textContent = '\u26d4 Blocked in browser settings';
            btn.disabled = true;
            btn.style.opacity = '0.4';
        }
    }
    updateTestNotifButton();

    window.requestTestNotifPermission = function() {
        if (!('Notification' in window)) {
            showToast('Browser does not support notifications', true);
            return;
        }
        if (Notification.permission === 'granted') {
            showToast('Notifications already enabled');
            return;
        }
        if (Notification.permission === 'denied') {
            showToast('Notifications blocked \u2014 allow in browser settings', true);
            return;
        }
        Notification.requestPermission().then(function(perm) {
            if (perm === 'granted') showToast('Browser notifications enabled');
            else showToast('Notification permission denied', true);
            updateTestNotifButton();
        });
    };

    function sendTestNotification(title, body, vibrate) {
        if (!('Notification' in window)) { showToast('Browser does not support notifications', true); return; }
        if (Notification.permission !== 'granted') { showToast('Enable notifications first', true); return; }
        var opts = {
            body: body,
            icon: NOTIF_TEST_ICON_MAP[title] || '/static/bees/png/happy.png',
            badge: '/static/icon-192.png',
            tag: 'swarm-test-' + title.replace(/\s+/g, '-').toLowerCase(),
            vibrate: vibrate ? [200, 100, 200] : undefined
        };
        try {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(reg) { reg.showNotification(title, opts); });
            } else {
                new Notification(title, opts);
            }
            showToast('Sent: ' + title);
        } catch(e) { showToast('Notification failed: ' + e.message, true); }
    }

    var NOTIF_TEST_DATA = {
        worker_down:    { title: 'Worker Down',              body: 'test-worker exited (STUNG)' },
        escalation:     { title: 'Escalation',               body: 'test-worker: Worker stuck in retry loop for 120s' },
        task_failed:    { title: 'Task Failed',              body: 'Fix login page validation bug' },
        queen_proposal: { title: 'Queen Proposal',           body: 'test-worker \u2190 Add dark mode toggle', vibrate: true },
        queen_auto:     { title: 'Queen Auto-Action',        body: 'test-worker: continue (85% confidence)' },
        queen_input:    { title: 'Queen needs your input',   body: 'test-worker: Crash loop requires manual review', vibrate: true },
        task_complete:  { title: 'Task complete',            body: 'Fix login bug \u2014 test-worker' },
        draft_failed:   { title: 'Draft Failed',             body: 'Fix login bug: Graph token expired' },
        send_failed:    { title: 'Task Send Failed',         body: 'Add dark mode could not be sent to test-worker' },
    };

    window.fireTestNotif = function(type) {
        var d = NOTIF_TEST_DATA[type];
        if (!d) return;
        sendTestNotification(d.title, d.body, d.vibrate);
    };

    window.fireDelayedTestNotif = function() {
        if (!('Notification' in window) || Notification.permission !== 'granted') {
            showToast('Enable notifications first', true);
            return;
        }
        showToast('Sending all notifications in 5 seconds \u2014 switch tabs now!');
        setTimeout(function() {
            var keys = Object.keys(NOTIF_TEST_DATA);
            keys.forEach(function(key, i) {
                setTimeout(function() {
                    var d = NOTIF_TEST_DATA[key];
                    sendTestNotification(d.title, d.body, d.vibrate);
                }, i * 800);
            });
        }, 5000);
    };

    // --- Updates ---
    window.checkForUpdate = function() {
        var btn = document.getElementById('cfg-check-update-btn');
        var status = document.getElementById('cfg-update-status');
        var installBtn = document.getElementById('cfg-install-update-btn');
        btn.disabled = true;
        if (installBtn) installBtn.style.display = 'none';
        status.textContent = 'Checking...';
        status.style.color = '';
        fetch('/action/check-update', { method: 'POST', headers: { 'X-Requested-With': 'SwarmWeb' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.style.color = 'var(--poppy)';
                } else if (data.available) {
                    if (data.is_dev) {
                        status.innerHTML = '<span style="color:var(--honey)">Update available: <strong>' + escapeHtml(data.remote_version) + '</strong> (dev mode — use <code>git pull</code>)</span>';
                    } else {
                        status.innerHTML = '<span style="color:var(--leaf)">Update available: <strong>' + escapeHtml(data.remote_version) + '</strong></span>';
                        if (installBtn) installBtn.style.display = 'inline-block';
                    }
                } else {
                    status.textContent = 'Up to date (' + data.current_version + ')';
                    status.style.color = 'var(--leaf)';
                }
            })
            .catch(function() {
                btn.disabled = false;
                status.textContent = 'Check failed';
                status.style.color = 'var(--poppy)';
            });
    };

    window.installUpdate = function() {
        if (!confirm('Install update and restart swarm? Workers will keep running.')) return;
        var btn = document.getElementById('cfg-install-update-btn');
        var status = document.getElementById('cfg-update-status');
        btn.disabled = true;
        status.innerHTML = '<span class="update-spinner"></span> Installing...';
        status.style.color = 'var(--honey)';
        fetch('/action/update-and-restart', { method: 'POST', headers: { 'X-Requested-With': 'SwarmWeb' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.restarting) {
                    status.innerHTML = '<span class="update-spinner"></span> Restarting...';
                    status.style.color = 'var(--leaf)';
                    btn.style.display = 'none';
                    showToast('Update installed — restarting server...');
                    waitForRestart();
                } else {
                    btn.disabled = false;
                    status.textContent = 'Update failed: ' + (data.output || 'unknown error').substring(0, 200);
                    status.style.color = 'var(--poppy)';
                }
            })
            .catch(function() {
                // Server may have already shut down — start polling for restart
                status.innerHTML = '<span class="update-spinner"></span> Restarting...';
                status.style.color = 'var(--honey)';
                waitForRestart();
            });
    };

    window.showUpdateProgress = function(line) {
        var status = document.getElementById('cfg-update-status');
        if (status) {
            status.innerHTML = '<span class="update-spinner"></span> ' + escapeHtml(line);
            status.style.color = 'var(--honey)';
        }
    };

    function waitForRestart() {
        var attempts = 0;
        var maxAttempts = 60;
        var interval = setInterval(function() {
            attempts++;
            fetch('/api/health', { method: 'GET' })
                .then(function(r) {
                    if (r.ok) {
                        clearInterval(interval);
                        location.reload();
                    }
                })
                .catch(function() {});
            if (attempts >= maxAttempts) {
                clearInterval(interval);
                var status = document.getElementById('cfg-update-status');
                if (status) {
                    status.textContent = 'Server did not come back — check terminal';
                    status.style.color = 'var(--poppy)';
                }
            }
        }, 2000);
    }

    // --- Integrations: Microsoft Graph ---
    function checkGraphStatus() {
        fetch('/auth/graph/status')
            .then(r => r.json())
            .then(data => {
                var el = document.getElementById('graph-status');
                var connectBtn = document.getElementById('graph-connect-btn');
                var disconnectBtn = document.getElementById('graph-disconnect-btn');
                var guide = document.getElementById('graph-setup-guide');
                var hint = document.getElementById('graph-help-hint');
                if (data.connected) {
                    el.style.borderColor = 'var(--leaf)';
                    el.innerHTML = '<span class="status-connected">&#10003; Connected</span> — email drag-and-drop will import full body + attachments';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                    if (guide) guide.removeAttribute('open');
                    if (hint) hint.style.display = 'block';
                } else if (data.configured) {
                    el.style.borderColor = 'var(--honey)';
                    el.innerHTML = '<span class="text-honey">&#9679; Not connected</span> — click <strong>Connect Microsoft Account</strong> below to sign in';
                    if (connectBtn) connectBtn.style.display = 'inline-block';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                    if (hint) hint.style.display = 'none';
                } else {
                    el.style.borderColor = 'var(--border)';
                    el.innerHTML = '<span class="status-muted">&#9675; Not configured</span> — follow the setup guide below, paste your IDs, click <strong>Save &amp; Apply</strong>, then Connect';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                    if (guide) guide.setAttribute('open', '');
                    if (hint) hint.style.display = 'none';
                }
            })
            .catch(function() {
                var el = document.getElementById('graph-status');
                if (el) el.innerHTML = '<span class="status-muted">Could not check status</span>';
            });
    }

    window.disconnectGraph = function() {
        if (!confirm('Disconnect Microsoft account? Email drag-and-drop will fall back to subject-only.')) return;
        authFetch('/auth/graph/disconnect', { method: 'POST' })
            .then(function(r) {
                if (r && r.ok) {
                    showToast('Microsoft Graph disconnected');
                    checkGraphStatus();
                }
            });
    };

    // Check status when integrations tab is first shown
    var origSwitchTab = window.switchConfigTab;
    window.switchConfigTab = function(name) {
        origSwitchTab(name);
        if (name === 'integrations') checkGraphStatus();
    };

    // --- Logs tab ---
    let logRefreshTimer = null;

    window.refreshLogs = function() {
        var level = document.getElementById('log-level-filter').value;
        var lines = document.getElementById('log-lines').value;
        var url = '/partials/logs?lines=' + lines;
        if (level) url += '&level=' + level;
        fetch(url)
            .then(function(r) { return r.text(); })
            .then(function(text) {
                var el = document.getElementById('log-output');
                el.textContent = text;
                el.scrollTop = el.scrollHeight;
            })
            .catch(function() {});
    };

    window.clearLogs = function() {
        if (!confirm('Clear the log file?')) return;
        authFetch('/action/clear-logs', { method: 'POST' })
            .then(function(r) {
                if (r && r.ok) {
                    showToast('Log cleared');
                    refreshLogs();
                }
            });
    };

    function startLogAutoRefresh() {
        if (logRefreshTimer) return;
        logRefreshTimer = setInterval(function() {
            if (document.getElementById('log-auto-refresh').checked) {
                refreshLogs();
            }
        }, 5000);
    }

    function stopLogAutoRefresh() {
        if (logRefreshTimer) { clearInterval(logRefreshTimer); logRefreshTimer = null; }
    }

    // Extend tab switcher to start/stop log auto-refresh
    var origSwitchTabForLogs = window.switchConfigTab;
    window.switchConfigTab = function(name) {
        origSwitchTabForLogs(name);
        if (name === 'logs') { refreshLogs(); startLogAutoRefresh(); }
        else { stopLogAutoRefresh(); }
    };

    // --- Usage tab ---
    let usageRefreshTimer = null;
    let usageSortCol = 5;  // default sort by cost
    let usageSortAsc = false;

    function fmtNum(n) { return n.toLocaleString(); }
    function fmtCost(n) { return '$' + n.toFixed(4); }

    window.refreshUsage = function() {
        fetch('/api/usage')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var total = data.total || {};
                document.getElementById('usage-total-cost').textContent = fmtCost(total.cost_usd || 0);
                document.getElementById('usage-total-input').textContent = fmtNum(total.input_tokens || 0);
                document.getElementById('usage-total-output').textContent = fmtNum(total.output_tokens || 0);
                document.getElementById('usage-total-tokens').textContent = fmtNum(total.total_tokens || 0);

                var totalCost = total.cost_usd || 0;
                var rows = [];
                var workers = data.workers || {};
                for (var name in workers) {
                    var w = workers[name];
                    rows.push({name: name, type: 'worker', u: w});
                }
                var queen = data.queen || {};
                rows.push({name: 'Queen', type: 'queen', u: queen});

                // Sort
                rows.sort(function(a, b) {
                    var av, bv;
                    switch (usageSortCol) {
                        case 0: av = a.name.toLowerCase(); bv = b.name.toLowerCase(); return usageSortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
                        case 1: av = a.u.input_tokens; bv = b.u.input_tokens; break;
                        case 2: av = a.u.output_tokens; bv = b.u.output_tokens; break;
                        case 3: av = a.u.cache_read_tokens; bv = b.u.cache_read_tokens; break;
                        case 4: av = a.u.cache_creation_tokens; bv = b.u.cache_creation_tokens; break;
                        case 5: av = a.u.cost_usd; bv = b.u.cost_usd; break;
                        case 6: av = totalCost ? a.u.cost_usd / totalCost : 0; bv = totalCost ? b.u.cost_usd / totalCost : 0; break;
                        default: av = 0; bv = 0;
                    }
                    return usageSortAsc ? av - bv : bv - av;
                });

                // Find max cost for highlighting
                var maxCost = 0;
                rows.forEach(function(r) { if (r.u.cost_usd > maxCost) maxCost = r.u.cost_usd; });

                var tbody = document.getElementById('usage-table-body');
                tbody.innerHTML = '';
                rows.forEach(function(r) {
                    var pct = totalCost > 0 ? ((r.u.cost_usd / totalCost) * 100).toFixed(1) : '0.0';
                    var isMax = maxCost > 0 && r.u.cost_usd === maxCost;
                    var nameStyle = r.type === 'queen' ? 'color:var(--honey);font-weight:600' : '';
                    var rowStyle = isMax ? 'background:rgba(255,200,50,0.08)' : '';
                    var tr = document.createElement('tr');
                    tr.style.cssText = rowStyle + ';border-bottom:1px solid var(--border)';
                    tr.innerHTML = '<td style="padding:0.4rem 0.6rem;' + nameStyle + '">' + r.name + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.input_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.output_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.cache_read_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.cache_creation_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem;font-weight:600">' + fmtCost(r.u.cost_usd || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + pct + '%</td>';
                    tbody.appendChild(tr);
                });
            })
            .catch(function() {});
    };

    window.sortUsageTable = function(col) {
        if (usageSortCol === col) usageSortAsc = !usageSortAsc;
        else { usageSortCol = col; usageSortAsc = false; }
        refreshUsage();
    };

    function startUsageAutoRefresh() {
        if (usageRefreshTimer) return;
        usageRefreshTimer = setInterval(refreshUsage, 30000);
    }

    function stopUsageAutoRefresh() {
        if (usageRefreshTimer) { clearInterval(usageRefreshTimer); usageRefreshTimer = null; }
    }

    // Extend tab switcher for usage tab
    var origSwitchTabForUsage = window.switchConfigTab;
    window.switchConfigTab = function(name) {
        origSwitchTabForUsage(name);
        if (name === 'usage') { refreshUsage(); startUsageAutoRefresh(); }
        else { stopUsageAutoRefresh(); }
    };

    // File changed banner
    window.dismissBanner = function() {
        document.getElementById('file-changed-banner').style.display = 'none';
    }

    // --- Delegated event handlers (replacing inline onclick/onchange/oninput) ---
    document.body.addEventListener('click', function(e) {
        // Modal backdrop dismiss
        var backdrop = e.target.closest('[data-modal-dismiss]');
        if (backdrop && e.target === backdrop) {
            var fn = backdrop.dataset.modalDismiss;
            if (fn === 'hideGroupEdit') hideGroupEdit();
            else if (fn === 'hideQueen') hideQueen();
            return;
        }
        var el = e.target.closest('[data-action]');
        if (!el) return;
        var action = el.dataset.action;
        var _actions = {
            saveSettings: function() { saveSettings(); },
            switchConfigTab: function() { switchConfigTab(el.dataset.tab); },
            addActionButton: function() { addActionButton(); },
            resetActionButtons: function() { resetActionButtons(); },
            addTaskButton: function() { addTaskButton(); },
            resetTaskButtons: function() { resetTaskButtons(); },
            checkForUpdate: function() { checkForUpdate(); },
            installUpdate: function() { installUpdate(); },
            addApprovalRule: function() { addApprovalRule(); },
            loadDefaultRules: function() { loadDefaultRules(); },
            removeWorker: function() { removeWorker(el.dataset.name); },
            addWorker: function() { addWorker(); },
            editGroup: function() { editGroup(el.dataset.name); },
            removeGroup: function() { removeGroup(el.dataset.name); },
            addGroup: function() { addGroup(); },
            disconnectGraph: function() { disconnectGraph(); },
            refreshLogs: function() { refreshLogs(); },
            clearLogs: function() { clearLogs(); },
            hideGroupEdit: function() { hideGroupEdit(); },
            saveGroupEdit: function() { saveGroupEdit(); },
            hideQueen: function() { hideQueen(); },
            dismissBanner: function() { dismissBanner(); },
            reload: function() { location.reload(); },
            fireTestModal: function() { fireTestModal(el.dataset.type); },
            fireTestToast: function() { fireTestToast(el.dataset.type); },
            requestTestNotifPermission: function() { requestTestNotifPermission(); },
            fireTestNotif: function() { fireTestNotif(el.dataset.type); },
            fireDelayedTestNotif: function() { fireDelayedTestNotif(); },
            sortUsageTable: function() { sortUsageTable(parseInt(el.dataset.col)); },
            removeRowDirty: function() { el.closest('.approval-rule-row').remove(); markDirty(); },
            removeRuleDirty: function() { el.closest('.approval-rule-row').remove(); markDirty(); updateDefaultsBtn(); },
            toggleVisPillDirty: function() {
                var label = el.closest('label.vis-pill') || el;
                toggleVisPill(label);
                markDirty();
            },
            queenTestApprove: function() { showToast('Approve clicked'); hideQueen(); },
            queenTestReject: function() { showToast('Reject clicked'); hideQueen(); },
        };
        if (_actions[action]) _actions[action]();
    });

    document.body.addEventListener('change', function(e) {
        var el = e.target.closest('[data-change-action]');
        if (!el) return;
        var action = el.dataset.changeAction;
        if (action === 'toggleActionCmdDirty') { toggleActionCmd(el.closest('.approval-rule-row')); markDirty(); }
        else if (action === 'markDirty') { markDirty(); }
        else if (action === 'refreshLogs') { refreshLogs(); }
    });

    document.body.addEventListener('input', function(e) {
        var el = e.target.closest('[data-input-action]');
        if (!el) return;
        if (el.dataset.inputAction === 'updateConfDisplay') {
            document.getElementById('conf-display').textContent = el.value + '%';
        }
    });

    // WebSocket for file change notifications
    function connectWs() {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(proto + '//' + location.host + '/ws');
        ws.onopen = function() {
            ws.send(JSON.stringify({type: 'auth', token: apiPassword}));
        };
        ws.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'config_file_changed') {
                    document.getElementById('file-changed-banner').style.display = 'flex';
                } else if (data.type === 'update_progress') {
                    showUpdateProgress(data.line || '');
                } else if (data.type === 'update_failed') {
                    var status = document.getElementById('cfg-update-status');
                    var btn = document.getElementById('cfg-install-update-btn');
                    if (status) { status.textContent = 'Update failed'; status.style.color = 'var(--poppy)'; }
                    if (btn) btn.disabled = false;
                }
            } catch(err) {}
        };
        ws.onclose = function() { setTimeout(connectWs, 3000); };
    }
    connectWs();
})();
</script>
{% endblock %}
