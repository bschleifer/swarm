{% extends "base.html" %}
{% block title %}Bee Hive — Config{% endblock %}

{% block body %}
<div id="unsaved-banner" class="unsaved-banner" style="display:none">
    Unsaved changes *
</div>
<header>
    <h1><img src="/static/bees/cool.svg" class="bee-icon bee-md" alt="" style="margin-right:0.3rem"><a href="/" class="text-honey no-underline">Bee Hive</a> &mdash; Config</h1>
    <div class="flex-center gap-lg">
        <a href="/dashboard" class="btn btn-secondary no-underline">Dashboard</a>
        <button class="btn" id="save-btn" onclick="saveSettings()">Save &amp; Apply</button>
    </div>
</header>

<div class="modal-padding">
    <div class="config-tab-nav">
        <button class="tab-btn active" onclick="switchConfigTab('general')">General</button>
        <button class="tab-btn" onclick="switchConfigTab('drones')">Drones</button>
        <button class="tab-btn" onclick="switchConfigTab('queen')">Queen</button>
        <button class="tab-btn" onclick="switchConfigTab('workers')">Workers</button>
        <button class="tab-btn" onclick="switchConfigTab('groups')">Groups</button>
        <button class="tab-btn" onclick="switchConfigTab('integrations')">Integrations</button>
        <button class="tab-btn" onclick="switchConfigTab('logs')">Debug Log</button>
        <button class="tab-btn" onclick="switchConfigTab('test')">Test</button>
        <button class="tab-btn" onclick="switchConfigTab('usage')">Usage</button>
    </div>

    <!-- General tab -->
    <div id="config-tab-general" class="config-tab">
        <div class="config-section">
            <h3>General</h3>
            <div class="config-field">
                <label>session_name <span class="restart-badge">restart</span></label>
                <input class="config-input w-input" id="cfg-session_name" value="{{ config.session_name }}">
            </div>
            <div class="config-field">
                <label>default_group</label>
                <select class="config-input w-input" id="cfg-default_group">
                    <option value="">(none)</option>
                    {% for g in config.groups %}
                    <option value="{{ g.name }}" {{ 'selected' if config.get('default_group','') == g.name else '' }}>{{ g.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="config-field">
                <label>projects_dir <span class="restart-badge">restart</span></label>
                <input class="config-input w-input" id="cfg-projects_dir" value="{{ config.projects_dir }}">
            </div>
            <div class="config-field">
                <label>log_level</label>
                <select class="config-input w-input" id="cfg-log_level">
                    {% for lvl in ['DEBUG','INFO','WARNING','ERROR'] %}
                    <option value="{{ lvl }}" {{ 'selected' if config.log_level == lvl else '' }}>{{ lvl }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="config-section">
            <h3>Notifications</h3>
            <div class="config-field">
                <label>terminal_bell</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-notif-terminal_bell" {{ 'checked' if config.notifications.terminal_bell else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>desktop</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-notif-desktop" {{ 'checked' if config.notifications.desktop else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>debounce_seconds</label>
                <input class="config-input" type="number" step="0.5" min="0" id="cfg-notif-debounce_seconds" value="{{ config.notifications.debounce_seconds }}">
            </div>
        </div>
        <div class="config-section">
            <h3>Tool Buttons</h3>
            <p class="help-text">Custom buttons shown in the dashboard action bar. Leave command blank for Continue.</p>
            <div id="tool-buttons-list">
                {% for btn in config.get('tool_buttons', []) %}
                <div class="approval-rule-row">
                    <input class="config-input text-left field-xs" placeholder="Label" value="{{ btn.label }}">
                    <input class="config-input text-left flex-1" placeholder="Command (blank = continue)" value="{{ btn.command }}">
                    <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();markDirty();">x</button>
                </div>
                {% endfor %}
            </div>
            <div class="flex-center gap-sm mt-sm">
                <button class="btn btn-sm" onclick="addToolButton()">+ Add Button</button>
            </div>
        </div>
    </div>

    <!-- Drones tab -->
    <div id="config-tab-drones" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Workflows</h3>
            <p class="help-text">
                Map each task type to a Claude Code skill (slash command). Leave blank to use inline instructions.
            </p>
            {% set wf = config.get('workflows', {}) if config.get is defined else {} %}
            {% for ttype in ['bug', 'feature', 'verify', 'chore'] %}
            <div class="config-field">
                <label class="text-upper text-sm w-select-sm-2">{{ ttype }}</label>
                <input class="config-input text-left w-input" id="cfg-workflow-{{ ttype }}"
                       value="{{ wf.get(ttype, '') }}"
                       placeholder="{{ {
                           'bug': '/fix-and-ship',
                           'feature': '/feature',
                           'verify': '/verify',
                           'chore': ''
                       }[ttype] }}"
                       >
            </div>
            {% endfor %}
        </div>
        <div class="config-section">
            <h3>Drones</h3>
            <div class="config-field">
                <label>poll_interval</label>
                <input class="config-input" type="number" step="0.5" min="1" id="cfg-drone-poll_interval" value="{{ config.drones.poll_interval }}">
            </div>
            <div class="config-field">
                <label>escalation_threshold</label>
                <input class="config-input" type="number" step="1" min="0" id="cfg-drone-escalation_threshold" value="{{ config.drones.escalation_threshold }}">
            </div>
            <div class="config-field">
                <label>max_idle_interval</label>
                <input class="config-input" type="number" step="1" min="5" id="cfg-drone-max_idle_interval" value="{{ config.drones.max_idle_interval }}">
            </div>
            <div class="config-field">
                <label>max_revive_attempts</label>
                <input class="config-input" type="number" step="1" min="0" id="cfg-drone-max_revive_attempts" value="{{ config.drones.max_revive_attempts }}">
            </div>
            <div class="config-field">
                <label>max_poll_failures</label>
                <input class="config-input" type="number" step="1" min="1" id="cfg-drone-max_poll_failures" value="{{ config.drones.max_poll_failures }}">
            </div>
            <div class="config-field">
                <label>auto_approve_yn</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-drone-auto_approve_yn" {{ 'checked' if config.drones.auto_approve_yn else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>auto_stop_on_complete</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-drone-auto_stop_on_complete" {{ 'checked' if config.drones.auto_stop_on_complete else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="config-section">
            <h3>Built-in Behavior</h3>
            <p class="help-text">These rules are hardcoded and always active. They cannot be overridden.</p>
            <table class="rule-table mb-xs">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>Condition</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-leaf">BUZZING</td>
                        <td>Worker is actively working</td>
                        <td class="text-muted">Do nothing</td>
                    </tr>
                    <tr>
                        <td class="text-poppy">STUNG</td>
                        <td>Worker exited (revives remaining)</td>
                        <td class="text-honey">Revive</td>
                    </tr>
                    <tr>
                        <td class="text-poppy">STUNG</td>
                        <td>Crash loop (max revives exhausted)</td>
                        <td class="text-amber">Escalate to Queen</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Plan approval prompt detected</td>
                        <td class="text-amber">Always escalate (never auto-approve plans)</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Choice menu (numbered options)</td>
                        <td>Check approval rules below &darr;</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Empty prompt (<code>&gt;</code>)</td>
                        <td class="text-leaf">Press Enter (continue)</td>
                    </tr>
                    <tr>
                        <td class="text-lavender">RESTING</td>
                        <td>Idle at input prompt</td>
                        <td class="text-muted">Do nothing (available, may need attention)</td>
                    </tr>
                    <tr>
                        <td class="text-muted">SLEEPING</td>
                        <td>Idle for &gt; 5 minutes</td>
                        <td class="text-muted">Dimmed; ignored by drones &amp; queen</td>
                    </tr>
                    <tr>
                        <td class="text-honey">WAITING</td>
                        <td>Unrecognized state for &gt; {{ config.drones.escalation_threshold }}s</td>
                        <td class="text-amber">Escalate to Queen (once)</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="config-section">
            <h3>Approval Rules</h3>
            <p class="help-text">Applied to choice menus. First matching rule wins. No match falls back to auto-approve.</p>
            <div id="approval-rules-list">
                {% for rule in config.drones.approval_rules %}
                <div class="approval-rule-row">
                    <input class="config-input text-left flex-1" placeholder="Pattern (regex)" value="{{ rule.pattern }}">
                    <select class="config-input w-select-sm">
                        <option value="approve" {{ 'selected' if rule.action == 'approve' else '' }}>Approve</option>
                        <option value="escalate" {{ 'selected' if rule.action == 'escalate' else '' }}>Escalate</option>
                    </select>
                    <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();markDirty();">x</button>
                </div>
                {% endfor %}
            </div>
            <div class="flex-center gap-sm mt-sm">
                <button class="btn btn-sm" onclick="addApprovalRule()">+ Add Rule</button>
                <button class="btn btn-sm btn-secondary" id="load-defaults-btn" style="display:none" onclick="loadDefaultRules()">Load Defaults</button>
            </div>
        </div>
    </div>

    <!-- Queen tab -->
    <div id="config-tab-queen" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Queen</h3>
            <div class="config-field">
                <label>cooldown</label>
                <input class="config-input" type="number" step="1" min="0" id="cfg-queen-cooldown" value="{{ config.queen.cooldown }}">
            </div>
            <div class="config-field">
                <label>enabled</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cfg-queen-enabled" {{ 'checked' if config.queen.enabled else '' }}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="config-field">
                <label>min_confidence</label>
                <input type="range" min="0" max="100" step="5" id="cfg-queen-min_confidence"
                       value="{{ (config.queen.min_confidence * 100)|int }}"
                       oninput="document.getElementById('conf-display').textContent=this.value+'%'"
                       class="flex-1 field-sm">
                <span id="conf-display" class="confidence-display">{{ (config.queen.min_confidence * 100)|int }}%</span>
            </div>
            <div class="config-field config-field-col">
                <label>system_prompt</label>
                <textarea class="config-input textarea-prompt" id="cfg-queen-system_prompt"
                          rows="50"
                          placeholder="Operator instructions for the Queen...">{{ config.queen.system_prompt or '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Workers tab -->
    <div id="config-tab-workers" class="config-tab" style="display:none">
        <div class="panel config-max-w">
            <div class="panel-header">
                <span>Workers</span>
                <span class="hint">{{ config.workers|length }} total</span>
            </div>
            <div class="panel-body" id="worker-config-list">
                {% for w in config.workers %}
                <div class="worker-row" data-worker="{{ w.name }}">
                    <div class="flex-1">
                        <strong>{{ w.name }}</strong>
                        <div class="help-text mb-0">{{ w.path }}</div>
                        <textarea class="config-input text-left field-caption" placeholder="Description (optional)"
                               data-worker-desc="{{ w.name }}"
                               rows="2">{{ w.description or '' }}</textarea>
                    </div>
                    <button class="btn btn-sm btn-danger no-shrink" onclick='removeWorker({{ w.name|tojson }})'>Remove</button>
                </div>
                {% endfor %}
            </div>
            <div class="config-section-footer">
                <div class="config-add-form">
                    <input id="new-worker-name" placeholder="Name" class="field-xs">
                    <input id="new-worker-path" list="project-paths" placeholder="Path" class="flex-1 min-w-field">
                    <datalist id="project-paths"></datalist>
                    <button class="btn btn-sm" onclick="addWorker()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Groups tab -->
    <div id="config-tab-groups" class="config-tab" style="display:none">
        <div class="panel config-max-w">
            <div class="panel-header">
                <span>Groups</span>
                <span class="hint">{{ config.groups|length }} total</span>
            </div>
            <div class="panel-body" id="group-config-list">
                {% for g in config.groups %}
                <div class="group-row" data-group="{{ g.name }}">
                    <div>
                        <strong>{{ g.name }}</strong>
                        <div class="help-text mb-0">{{ g.workers|join(', ') }}</div>
                    </div>
                    <div class="flex-center gap-xs">
                        <button class="btn btn-sm btn-secondary" onclick='editGroup({{ g.name|tojson }})'>Edit</button>
                        <button class="btn btn-sm btn-danger" onclick='removeGroup({{ g.name|tojson }})'>Remove</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="config-section-footer">
                <div class="config-add-form">
                    <input id="new-group-name" placeholder="Group name" class="field-md">
                    <button class="btn btn-sm" onclick="addGroup()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrations tab -->
    <div id="config-tab-integrations" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Microsoft Outlook</h3>
            <p class="text-sm text-muted mb-sm">
                Drag-and-drop emails from <strong>New Outlook</strong> into the task board to create tasks from email.
            </p>
            <p class="text-sm text-muted mb-md">
                <strong class="text-beeswax">Without</strong> Graph: the task gets the email subject line only.<br>
                <strong class="text-leaf">With</strong> Graph: the task gets the full email body, inline images, and file attachments.
            </p>
            <div id="graph-status" class="status-box">
                Checking status...
            </div>

            <details id="graph-setup-guide" class="setup-guide">
                <summary>One-time setup: Register an app in Microsoft Entra</summary>
                <div class="setup-guide-body">
                    <p>
                        Swarm reads your email via the <strong>Microsoft Graph API</strong> using delegated permissions &mdash; it can only read mail you explicitly grant access to.
                        No client secret is needed; Swarm uses the PKCE flow (proof key for code exchange).
                    </p>

                    <p class="text-honey setup-step">Step 1 &mdash; Create the app registration</p>
                    <ol>
                        <li>Open <a href="https://entra.microsoft.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" rel="noopener" class="text-honey">entra.microsoft.com &rarr; App registrations</a></li>
                        <li>Click <strong>+ New registration</strong></li>
                        <li>Name: <code class="text-honey">Swarm</code> (anything you like)</li>
                        <li>Leave &ldquo;Redirect URI&rdquo; blank for now</li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <p class="text-honey setup-step">Step 2 &mdash; Add the redirect URI (important: correct platform)</p>
                    <ol start="6">
                        <li>In your new app, go to <strong>Authentication</strong> in the left sidebar</li>
                        <li>Click <strong>+ Add a platform</strong></li>
                        <li>Choose <strong class="text-honey">Mobile and desktop applications</strong></li>
                        <li>Scroll to <strong>Custom redirect URIs</strong> at the bottom and enter:<br>
                            <code class="text-honey">http://localhost:9090/auth/graph/callback</code>
                            <span class="text-muted text-xs"> &mdash; change 9090 if you use a different port</span>
                        </li>
                        <li>Click <strong>Configure</strong></li>
                    </ol>

                    <p class="text-honey setup-step">Step 3 &mdash; Grant Mail.Read permission</p>
                    <ol start="11">
                        <li>Go to <strong>API permissions</strong> in the left sidebar</li>
                        <li>Click <strong>+ Add a permission</strong> &rarr; <strong>Microsoft Graph</strong> &rarr; <strong>Delegated permissions</strong></li>
                        <li>Search for <code class="text-honey">Mail.Read</code>, check it, and click <strong>Add permissions</strong></li>
                    </ol>

                    <p class="text-honey setup-step">Step 4 &mdash; Copy your IDs</p>
                    <ol start="14">
                        <li>Go to <strong>Overview</strong> in the left sidebar</li>
                        <li>Copy <strong>Application (client) ID</strong> &rarr; paste into the <em>Client ID</em> field below</li>
                        <li>Copy <strong>Directory (tenant) ID</strong> &rarr; paste into the <em>Tenant ID</em> field below</li>
                        <li>Click <strong>Save &amp; Apply</strong> at the top, then click <strong>Connect Microsoft Account</strong></li>
                    </ol>

                    <div class="setup-callout">
                        <strong>Why &ldquo;Mobile and desktop&rdquo;?</strong>
                        Entra offers three platform types. <em>Web</em> requires a client secret.
                        <em>SPA</em> only allows browser-side token exchange.
                        <em>Mobile and desktop</em> supports PKCE with a server-side callback, which is what Swarm uses.
                        If you accidentally picked the wrong one, go to Authentication, delete it, and add the correct platform.
                    </div>
                </div>
            </details>

            <div class="config-field">
                <label>Client ID <span class="hint">(Application ID from Entra Overview)</span></label>
                <input class="config-input text-left w-input-lg" id="cfg-graph-client_id"
                       value="{{ config.get('integrations', {}).get('graph', {}).get('client_id', '') }}"
                       placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
            </div>
            <div class="config-field">
                <label>Tenant ID <span class="hint">(Directory ID from Entra Overview &mdash; or &ldquo;common&rdquo; for personal accounts)</span></label>
                <input class="config-input text-left w-input-lg" id="cfg-graph-tenant_id"
                       value="{{ config.get('integrations', {}).get('graph', {}).get('tenant_id', 'common') }}"
                       placeholder="common">
            </div>
            <div class="flex-center gap-sm mt-md">
                <a id="graph-connect-btn" class="btn no-underline" href="/auth/graph/login">Connect Microsoft Account</a>
                <button id="graph-disconnect-btn" class="btn btn-danger" style="display:none" onclick="disconnectGraph()">Disconnect</button>
            </div>
            <p id="graph-help-hint" class="text-xs text-muted mt-sm" style="display:none">
                Tokens are stored locally in <code>~/.swarm/graph_tokens.json</code>.
                Access tokens expire after ~1 hour and refresh automatically.
                Click Disconnect to revoke and delete all stored tokens.
            </p>
        </div>
    </div>

    <!-- Test tab -->
    <div id="config-tab-test" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Test Mode</h3>
            <p class="help-text">Settings for <code>swarm test</code> — the self-contained test runner with auto-shutdown.</p>
            <div class="config-field">
                <label>port <span class="restart-badge">restart</span></label>
                <input class="config-input" type="number" step="1" min="1024" max="65535" id="cfg-test-port" value="{{ config.test.port }}">
            </div>
            <div class="config-field">
                <label>auto_resolve_delay</label>
                <input class="config-input" type="number" step="0.5" min="0" id="cfg-test-auto_resolve_delay" value="{{ config.test.auto_resolve_delay }}">
            </div>
            <div class="config-field">
                <label>auto_complete_min_idle</label>
                <input class="config-input" type="number" step="1" min="1" id="cfg-test-auto_complete_min_idle" value="{{ config.test.auto_complete_min_idle }}">
            </div>
            <div class="config-field">
                <label>report_dir</label>
                <input class="config-input text-left w-input" id="cfg-test-report_dir" value="{{ config.test.report_dir }}">
            </div>
        </div>
        <div class="config-section">
            <h3>Test Modals</h3>
            <p class="help-text">Broadcast mock WebSocket events to all connected dashboards. Open the dashboard in another tab first.</p>
            <div class="flex-center gap-sm flex-wrap">
                <button class="btn btn-sm" style="background:var(--amber)" onclick="fireTestModal('escalation')">Escalation</button>
                <button class="btn btn-sm btn-approve" onclick="fireTestModal('completion')">Completion</button>
                <button class="btn btn-sm" style="background:var(--lavender);color:var(--hive-bg)" onclick="fireTestModal('assignment')">Assignment</button>
                <button class="btn btn-sm btn-secondary" onclick="fireTestModal('toast')">Toast / Notification</button>
            </div>
            <div id="test-modal-result" class="help-text mt-sm"></div>
        </div>
    </div>

    <!-- Usage tab -->
    <div id="config-tab-usage" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Token Usage Summary</h3>
            <div id="usage-summary" class="flex-center gap-lg flex-wrap" style="margin-bottom:1rem">
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Total Cost</label>
                    <div id="usage-total-cost" class="text-honey" style="font-size:1.4rem;font-weight:700">$0.00</div>
                </div>
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Input Tokens</label>
                    <div id="usage-total-input" style="font-size:1.1rem;font-weight:600">0</div>
                </div>
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Output Tokens</label>
                    <div id="usage-total-output" style="font-size:1.1rem;font-weight:600">0</div>
                </div>
                <div class="config-field" style="flex:1;min-width:120px;text-align:center">
                    <label class="text-muted text-sm">Total Tokens</label>
                    <div id="usage-total-tokens" style="font-size:1.1rem;font-weight:600">0</div>
                </div>
            </div>
        </div>
        <div class="config-section">
            <h3>Per-Worker Breakdown</h3>
            <div style="overflow-x:auto">
                <table class="usage-table" style="width:100%;border-collapse:collapse;font-size:0.85rem">
                    <thead>
                        <tr style="border-bottom:1px solid var(--border)">
                            <th style="text-align:left;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(0)">Worker</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(1)">Input</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(2)">Output</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(3)">Cache Read</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(4)">Cache Create</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(5)">Cost</th>
                            <th style="text-align:right;padding:0.4rem 0.6rem;cursor:pointer" onclick="sortUsageTable(6)">% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="usage-table-body"></tbody>
                </table>
            </div>
            <p class="help-text" style="margin-top:0.5rem">Worker costs are estimated from token counts. Queen cost is exact (from CLI envelope). Auto-refreshes every 30s.</p>
        </div>
    </div>

    <!-- Logs tab -->
    <div id="config-tab-logs" class="config-tab" style="display:none">
        <div class="config-section">
            <h3>Debug Log</h3>
            <div class="flex-center gap-sm mb-md">
                <label class="text-muted text-sm">Level:</label>
                <select id="log-level-filter" class="config-input w-select-md" onchange="refreshLogs()">
                    <option value="">All</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO" selected>INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <label class="text-muted text-sm">Lines:</label>
                <select id="log-lines" class="config-input w-select-sm-2" onchange="refreshLogs()">
                    <option value="100">100</option>
                    <option value="250">250</option>
                    <option value="500" selected>500</option>
                    <option value="1000">1000</option>
                </select>
                <button class="btn btn-sm" onclick="refreshLogs()">Refresh</button>
                <label class="text-muted text-sm ml-xs">
                    <input type="checkbox" id="log-auto-refresh" checked> Auto-refresh
                </label>
                <button class="btn btn-sm btn-danger ml-auto" onclick="clearLogs()">Clear Log</button>
            </div>
            <pre id="log-output" class="log-output"></pre>
        </div>
    </div>
</div>

<!-- Group edit modal (hidden) -->
<div id="group-edit-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)hideGroupEdit()">
    <div class="modal-box modal-sm">
        <div class="panel-header">
            <span>Edit Group</span>
            <button class="btn btn-sm btn-secondary" onclick="hideGroupEdit()">Close</button>
        </div>
        <div class="group-edit-body">
            <div class="mb-xs">
                <label>Group Name</label>
                <input class="config-input text-left modal-input" id="group-edit-name-input">
            </div>
            <div id="group-edit-body"></div>
        </div>
        <div class="modal-actions config-section-footer justify-end">
            <button class="btn btn-secondary" onclick="hideGroupEdit()">Cancel</button>
            <button class="btn" onclick="saveGroupEdit()">Save</button>
        </div>
    </div>
</div>


<!-- Test modal overlay (hidden) -->
<div id="queen-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)hideQueen()">
    <div class="modal-box modal-lg">
        <div class="panel-header btn-queen">
            <span><img src="/static/bees/queen.svg" class="bee-icon bee-md" alt="" style="margin-right:0.3rem">Queen — Hive Conductor</span>
            <button class="btn btn-sm btn-close" onclick="hideQueen()">Close</button>
        </div>
        <div id="queen-result" class="modal-body modal-body-scroll">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideQueen()">Close</button>
        </div>
    </div>
</div>

<!-- File changed banner (hidden) -->
<div id="file-changed-banner" class="file-changed-banner" style="display:none">
    <span class="text-honey">Config file changed on disk</span>
    <button class="btn btn-sm" onclick="location.reload()">Reload</button>
    <button class="btn btn-sm btn-secondary" onclick="dismissBanner()">Dismiss</button>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let apiPassword = sessionStorage.getItem('swarm_api_password') || '';
    let ws = null;

    function authHeaders() {
        const h = { 'Content-Type': 'application/json', 'X-Requested-With': 'SwarmWeb' };
        if (apiPassword) h['Authorization'] = 'Bearer ' + apiPassword;
        return h;
    }

    function requireAuth() {
        if (!apiPassword) {
            const pw = prompt('API password required:');
            if (!pw) return false;
            apiPassword = pw;
            sessionStorage.setItem('swarm_api_password', pw);
        }
        return true;
    }

    async function authFetch(url, opts) {
        opts = opts || {};
        opts.headers = authHeaders();
        const resp = await fetch(url, opts);
        if (resp.status === 401) {
            sessionStorage.removeItem('swarm_api_password');
            apiPassword = '';
            showToast('Authentication failed — try again', true);
            return null;
        }
        return resp;
    }

    // Toast
    function escapeHtmlToast(str) {
        var d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }
    function showToast(msg, warning) {
        const container = document.getElementById('toasts');
        const toast = document.createElement('div');
        toast.className = 'toast' + (warning ? ' toast-warning' : '');
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        var bee = warning ? '/static/bees/angry.svg' : '/static/bees/happy.svg';
        toast.innerHTML = '<img src="' + bee + '" class="bee-icon bee-md toast-bee" alt="">' + escapeHtmlToast(msg);
        container.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3500);
    }

    // Load project paths for dropdown
    fetch('/api/config/projects')
        .then(r => r.json())
        .then(data => {
            const dl = document.getElementById('project-paths');
            for (const p of data.projects || []) {
                const opt = document.createElement('option');
                opt.value = p.path;
                opt.textContent = p.name;
                dl.appendChild(opt);
            }
        });

    // --- Tab switching ---
    window.switchConfigTab = function(name) {
        document.querySelectorAll('.config-tab').forEach(function(t) { t.style.display = 'none'; });
        document.querySelectorAll('.config-tab-nav .tab-btn').forEach(function(b) { b.classList.remove('active'); });
        var tab = document.getElementById('config-tab-' + name);
        if (tab) tab.style.display = 'block';
        // Mark the clicked button active
        var btns = document.querySelectorAll('.config-tab-nav .tab-btn');
        for (var i = 0; i < btns.length; i++) {
            if (btns[i].textContent.trim().toLowerCase() === name) btns[i].classList.add('active');
        }
    };

    // --- Approval Rules ---
    function updateDefaultsBtn() {
        var list = document.getElementById('approval-rules-list');
        var btn = document.getElementById('load-defaults-btn');
        if (btn) btn.style.display = (list && list.children.length === 0) ? 'inline-block' : 'none';
    }
    updateDefaultsBtn();

    window.loadDefaultRules = function() {
        var defaults = [
            {pattern: '\\bplan\\b', action: 'escalate'},
            {pattern: '^(Yes|Allow|Continue|Accept)', action: 'approve'},
            {pattern: 'delete|remove|drop|destroy', action: 'escalate'},
            {pattern: '.*', action: 'approve'},
        ];
        for (var i = 0; i < defaults.length; i++) {
            addApprovalRule(defaults[i].pattern, defaults[i].action);
        }
        markDirty();
        updateDefaultsBtn();
    };

    window.addApprovalRule = function(defaultPattern, defaultAction) {
        var list = document.getElementById('approval-rules-list');
        var row = document.createElement('div');
        row.className = 'approval-rule-row';
        var escAction = (defaultAction === 'escalate') ? 'escalate' : 'approve';
        var approveSelected = escAction === 'approve' ? ' selected' : '';
        var escalateSelected = escAction === 'escalate' ? ' selected' : '';
        row.innerHTML = '<input class="config-input text-left flex-1" placeholder="Pattern (regex)" value="' + (defaultPattern || '') + '">'
            + '<select class="config-input w-select-sm"><option value="approve"' + approveSelected + '>Approve</option><option value="escalate"' + escalateSelected + '>Escalate</option></select>'
            + '<button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();markDirty();updateDefaultsBtn();">x</button>';
        list.appendChild(row);
        markDirty();
        updateDefaultsBtn();
    };

    function collectApprovalRules() {
        var rules = [];
        document.querySelectorAll('#approval-rules-list .approval-rule-row').forEach(function(row) {
            var pattern = row.querySelector('input').value.trim();
            var action = row.querySelector('select').value;
            if (pattern) rules.push({pattern: pattern, action: action});
        });
        return rules;
    }

    // --- Tool Buttons ---
    window.addToolButton = function() {
        var list = document.getElementById('tool-buttons-list');
        var row = document.createElement('div');
        row.className = 'approval-rule-row';
        row.innerHTML = '<input class="config-input text-left field-xs" placeholder="Label">'
            + '<input class="config-input text-left flex-1" placeholder="Command (blank = continue)">'
            + '<button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();markDirty();">x</button>';
        list.appendChild(row);
        markDirty();
    };

    function collectToolButtons() {
        var buttons = [];
        document.querySelectorAll('#tool-buttons-list .approval-rule-row').forEach(function(row) {
            var inputs = row.querySelectorAll('input');
            var label = inputs[0].value.trim();
            var command = inputs[1].value.trim();
            if (label) buttons.push({label: label, command: command});
        });
        return buttons;
    }

    // Save & Apply
    window.saveSettings = function() {
        if (!requireAuth()) return;
        // Collect worker descriptions
        const workerDescs = {};
        document.querySelectorAll('[data-worker-desc]').forEach(function(el) {
            workerDescs[el.dataset.workerDesc] = el.value;
        });
        const body = {
            workers: workerDescs,
            session_name: document.getElementById('cfg-session_name').value,
            default_group: document.getElementById('cfg-default_group').value,
            projects_dir: document.getElementById('cfg-projects_dir').value,
            log_level: document.getElementById('cfg-log_level').value,
            drones: {
                poll_interval: parseFloat(document.getElementById('cfg-drone-poll_interval').value),
                escalation_threshold: parseFloat(document.getElementById('cfg-drone-escalation_threshold').value),
                max_idle_interval: parseFloat(document.getElementById('cfg-drone-max_idle_interval').value),
                max_revive_attempts: parseInt(document.getElementById('cfg-drone-max_revive_attempts').value),
                max_poll_failures: parseInt(document.getElementById('cfg-drone-max_poll_failures').value),
                auto_approve_yn: document.getElementById('cfg-drone-auto_approve_yn').checked,
                auto_stop_on_complete: document.getElementById('cfg-drone-auto_stop_on_complete').checked,
                approval_rules: collectApprovalRules(),
            },
            queen: {
                cooldown: parseFloat(document.getElementById('cfg-queen-cooldown').value),
                enabled: document.getElementById('cfg-queen-enabled').checked,
                system_prompt: document.getElementById('cfg-queen-system_prompt').value,
                min_confidence: parseInt(document.getElementById('cfg-queen-min_confidence').value) / 100.0,
            },
            notifications: {
                terminal_bell: document.getElementById('cfg-notif-terminal_bell').checked,
                desktop: document.getElementById('cfg-notif-desktop').checked,
                debounce_seconds: parseFloat(document.getElementById('cfg-notif-debounce_seconds').value),
            },
            graph_client_id: (document.getElementById('cfg-graph-client_id') || {}).value || '',
            graph_tenant_id: (document.getElementById('cfg-graph-tenant_id') || {}).value || 'common',
            workflows: (function() {
                var wf = {};
                ['bug','feature','verify','chore'].forEach(function(t) {
                    var el = document.getElementById('cfg-workflow-' + t);
                    if (el && el.value.trim()) wf[t] = el.value.trim();
                });
                return wf;
            })(),
            tool_buttons: collectToolButtons(),
            test: {
                port: parseInt(document.getElementById('cfg-test-port').value),
                auto_resolve_delay: parseFloat(document.getElementById('cfg-test-auto_resolve_delay').value),
                auto_complete_min_idle: parseFloat(document.getElementById('cfg-test-auto_complete_min_idle').value),
                report_dir: document.getElementById('cfg-test-report_dir').value,
            },
        };
        authFetch('/api/config', { method: 'PUT', body: JSON.stringify(body) })
            .then(r => { if (r && r.ok) showToast('Config saved & applied'); else if (r) r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true)); });
    }

    // Worker CRUD
    window.addWorker = function() {
        if (!requireAuth()) return;
        const name = document.getElementById('new-worker-name').value.trim();
        const path = document.getElementById('new-worker-path').value.trim();
        if (!name || !path) { showToast('Name and path required', true); return; }
        authFetch('/api/config/workers', {
            method: 'POST',
            body: JSON.stringify({ name: name, path: path }),
        }).then(r => {
            if (!r) return;
            if (r.ok) {
                showToast('Worker "' + name + '" added');
                setTimeout(() => location.reload(), 500);
            } else {
                r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
            }
        });
    }

    window.removeWorker = function(name) {
        if (!requireAuth()) return;
        if (!confirm('Remove worker "' + name + '"? Active tasks will return to PENDING.')) return;
        authFetch('/api/config/workers/' + encodeURIComponent(name), { method: 'DELETE' })
            .then(r => {
                if (!r) return;
                if (r.ok) {
                    showToast('Worker "' + name + '" removed');
                    const row = document.querySelector('[data-worker="' + name + '"]');
                    if (row) row.remove();
                } else {
                    r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
                }
            });
    }

    // Group CRUD
    window.addGroup = function() {
        if (!requireAuth()) return;
        const name = document.getElementById('new-group-name').value.trim();
        if (!name) { showToast('Group name required', true); return; }
        authFetch('/api/config/groups', {
            method: 'POST',
            body: JSON.stringify({ name: name, workers: [] }),
        }).then(r => {
            if (!r) return;
            if (r.ok) {
                showToast('Group "' + name + '" added');
                setTimeout(() => location.reload(), 500);
            } else {
                r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
            }
        });
    }

    let editingGroupName = null;

    window.editGroup = function(name) {
        if (!requireAuth()) return;
        editingGroupName = name;
        document.getElementById('group-edit-name-input').value = name;

        // Build checkboxes for all known workers
        var allWorkers = {{ config.workers|map(attribute='name')|list|tojson }};
        // Find current group members
        var currentMembers = [];
        {% for g in config.groups %}
        if ({{ g.name|tojson }} === name) currentMembers = {{ g.workers|tojson }};
        {% endfor %}
        var memberSet = new Set(currentMembers.map(function(s) { return s.toLowerCase(); }));

        var html = '';
        for (var i = 0; i < allWorkers.length; i++) {
            var wn = allWorkers[i];
            var checked = memberSet.has(wn.toLowerCase()) ? ' checked' : '';
            html += '<label class="group-member-label">';
            html += '<input type="checkbox" class="group-member-cb cb-spaced" value="' + wn + '"' + checked + '>';
            html += wn + '</label>';
        }
        document.getElementById('group-edit-body').innerHTML = html;
        document.getElementById('group-edit-modal').style.display = 'flex';
    };

    window.hideGroupEdit = function() {
        document.getElementById('group-edit-modal').style.display = 'none';
        editingGroupName = null;
    };

    window.saveGroupEdit = function() {
        if (!editingGroupName) return;
        var newName = document.getElementById('group-edit-name-input').value.trim();
        var workers = [];
        document.querySelectorAll('.group-member-cb:checked').forEach(function(cb) {
            workers.push(cb.value);
        });
        var payload = { workers: workers };
        if (newName && newName !== editingGroupName) payload.name = newName;
        authFetch('/api/config/groups/' + encodeURIComponent(editingGroupName), {
            method: 'PUT',
            body: JSON.stringify(payload),
        }).then(r => {
            if (!r) return;
            if (r.ok) {
                showToast('Group "' + editingGroupName + '" updated');
                hideGroupEdit();
                setTimeout(() => location.reload(), 500);
            } else {
                r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
            }
        });
    };

    window.removeGroup = function(name) {
        if (!requireAuth()) return;
        authFetch('/api/config/groups/' + encodeURIComponent(name), { method: 'DELETE' })
            .then(r => {
                if (!r) return;
                if (r.ok) {
                    showToast('Group "' + name + '" removed');
                    const row = document.querySelector('[data-group="' + name + '"]');
                    if (row) row.remove();
                } else {
                    r.json().then(d => showToast('Error: ' + (d.error || 'unknown'), true));
                }
            });
    }

    // --- Unsaved changes tracking ---
    let configDirty = false;

    window.markDirty = function() {
        if (!configDirty) {
            configDirty = true;
            document.getElementById('unsaved-banner').style.display = 'block';
        }
    }

    function clearDirty() {
        configDirty = false;
        document.getElementById('unsaved-banner').style.display = 'none';
    }

    // Track changes on all config inputs (including worker descriptions)
    document.querySelectorAll('.config-input, .toggle-switch input, [data-worker-desc], input[type="range"]').forEach(function(el) {
        el.addEventListener('change', markDirty);
        el.addEventListener('input', markDirty);
    });

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (configDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Clear dirty flag after successful save
    var origSave = window.saveSettings;
    window.saveSettings = function() {
        origSave();
        // Clear dirty after a short delay (assuming save succeeds)
        setTimeout(clearDirty, 500);
    };

    // --- Client-side validation ---
    function validateNumericField(id, min, label) {
        var el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('blur', function() {
            var val = parseFloat(el.value);
            if (isNaN(val) || val < min) {
                el.style.borderColor = 'var(--poppy)';
                el.title = label + ' must be >= ' + min;
            } else {
                el.style.borderColor = '';
                el.title = '';
            }
        });
    }

    validateNumericField('cfg-drone-poll_interval', 1, 'poll_interval');
    validateNumericField('cfg-drone-escalation_threshold', 0, 'escalation_threshold');
    validateNumericField('cfg-drone-max_idle_interval', 5, 'max_idle_interval');
    validateNumericField('cfg-drone-max_revive_attempts', 0, 'max_revive_attempts');
    validateNumericField('cfg-drone-max_poll_failures', 1, 'max_poll_failures');
    validateNumericField('cfg-queen-cooldown', 0, 'cooldown');
    validateNumericField('cfg-notif-debounce_seconds', 0, 'debounce_seconds');
    validateNumericField('cfg-test-port', 1024, 'test.port');
    validateNumericField('cfg-test-auto_resolve_delay', 0, 'test.auto_resolve_delay');
    validateNumericField('cfg-test-auto_complete_min_idle', 1, 'test.auto_complete_min_idle');

    // Esc closes modals
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var qm = document.getElementById('queen-modal');
            if (qm && qm.style.display !== 'none') { hideQueen(); return; }
            var modal = document.getElementById('group-edit-modal');
            if (modal && modal.style.display !== 'none') hideGroupEdit();
        }
    });

    // --- Test Modals (rendered locally) ---
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function queenSummaryLine(type, data) {
        var w = escapeHtml(data.worker || data.worker_name || '?');
        if (type === 'completion') {
            var t = escapeHtml(data.task_title || 'task');
            return 'Mark \u201c' + t + '\u201d complete for <strong class="text-lavender">' + w + '</strong>';
        }
        if (type === 'assignment') {
            var t = escapeHtml(data.task_title || 'task');
            return 'Assign \u201c' + t + '\u201d to <strong class="text-lavender">' + w + '</strong>';
        }
        var a = data.action || 'wait';
        var labels = {
            send_message: 'Send command to <strong class="text-lavender">' + w + '</strong>',
            continue: 'Continue execution for <strong class="text-lavender">' + w + '</strong>',
            restart: 'Restart <strong class="text-lavender">' + w + '</strong>',
            complete_task: 'Complete task for <strong class="text-lavender">' + w + '</strong>',
            wait: 'No action needed for <strong class="text-lavender">' + w + '</strong>'
        };
        return labels[a] || escapeHtml(a) + ' \u2014 <strong class="text-lavender">' + w + '</strong>';
    }

    window.hideQueen = function() {
        document.getElementById('queen-modal').style.display = 'none';
    };

    function showTestEscalation() {
        var data = {
            worker: 'test-worker',
            assessment: 'Worker appears stuck in a retry loop \u2014 build fails with a missing dependency, retried 3 times.',
            reasoning: 'Idle for 120s after three consecutive failed builds. Manual intervention needed.',
            action: 'send_message',
            message: 'npm install missing-package@latest',
            confidence: 0.78
        };
        var confPct = Math.round(data.confidence * 100);
        var confClass = confPct >= 70 ? 'conf-high' : confPct >= 40 ? 'conf-mid' : 'conf-low';
        var actionLabels = {send_message: 'Send message', continue: 'Continue execution', restart: 'Restart worker', complete_task: 'Complete task', wait: 'Wait'};
        var html = '<div class="queen-card queen-card-escalation">';
        html += '<div class="queen-card-header">';
        html += '<span class="conf-badge conf-mid"><img src="/static/bees/surprised.svg" class="bee-icon bee-xs" alt="" style="margin-right:0.2rem">ESCALATION</span>';
        html += '<span class="conf-badge ' + confClass + '">Confidence: ' + confPct + '%</span>';
        html += '</div>';
        html += '<div class="queen-summary">' + queenSummaryLine('escalation', data) + '</div>';
        html += '<div class="mb-sm queen-text-block"><strong class="text-honey">Analysis</strong><br>' + escapeHtml(data.assessment) + ' ' + escapeHtml(data.reasoning) + '</div>';
        var label = actionLabels[data.action] || data.action;
        html += '<div class="queen-recommends-callout"><img src="/static/bees/queen.svg" class="bee-icon bee-sm" alt=""><span><strong class="text-honey">Queen recommends</strong>: <span class="text-lavender">' + escapeHtml(label) + '</span></span></div>';
        html += '<div class="queen-code-block mb-sm">' + escapeHtml(data.message) + '</div>';
        html += '</div>';
        html += '<div class="modal-footer">';
        html += '<button class="btn btn-approve" onclick="showToast(\'Approve clicked\');hideQueen();">Approve</button>';
        html += '<button class="btn btn-reject-ghost" onclick="showToast(\'Reject clicked\');hideQueen();">Reject</button>';
        html += '</div>';
        document.getElementById('queen-result').innerHTML = html;
        document.getElementById('queen-modal').style.display = 'flex';
    }

    function showTestCompletion() {
        var data = {
            worker: 'test-worker',
            task_title: 'Fix login page validation bug',
            assessment: 'All form validation errors now display inline. Added unit tests for empty email and short password.',
            reasoning: 'Committed changes to auth/login.tsx and tests/login.test.ts. CI passed on branch.',
            confidence: 0.92,
            has_source_email: true
        };
        var confPct = Math.round(data.confidence * 100);
        var confClass = confPct >= 70 ? 'conf-high' : confPct >= 40 ? 'conf-mid' : 'conf-low';
        var html = '<div class="queen-card queen-card-complete">';
        html += '<div class="queen-card-header">';
        html += '<span class="conf-badge conf-high"><img src="/static/bees/honey-jar.svg" class="bee-icon bee-xs" alt="" style="margin-right:0.2rem">TASK COMPLETE</span>';
        html += '<span class="conf-badge ' + confClass + '">Confidence: ' + confPct + '%</span>';
        html += '</div>';
        html += '<div class="queen-summary">' + queenSummaryLine('completion', data) + '</div>';
        html += '<div class="resolution-block queen-text-block"><strong class="text-leaf text-base">Resolution</strong><br><span class="ws-pre-wrap">' + escapeHtml(data.assessment) + ' ' + escapeHtml(data.reasoning) + '</span></div>';
        html += '<label class="flex-center gap-xs text-base text-beeswax draft-label">';
        html += '<input type="checkbox" checked class="checkbox-leaf">';
        html += 'Draft Response &mdash; reply-all to source email</label>';
        html += '</div>';
        html += '<div class="modal-footer">';
        html += '<button class="btn btn-approve" onclick="showToast(\'Approve clicked\');hideQueen();">Approve &amp; Complete</button>';
        html += '<button class="btn btn-reject-ghost" onclick="showToast(\'Reject clicked\');hideQueen();">Reject</button>';
        html += '</div>';
        document.getElementById('queen-result').innerHTML = html;
        document.getElementById('queen-modal').style.display = 'flex';
    }

    function showTestAssignment() {
        var data = {
            worker_name: 'test-worker',
            task_title: 'Add dark mode toggle',
            reasoning: 'Lightest load and familiar with the settings module from a previous task.',
            message: 'Implement a theme toggle in the settings panel using CSS variables.',
            confidence: 0.85
        };
        var confPct = Math.round(data.confidence * 100);
        var confClass = confPct >= 70 ? 'conf-high' : confPct >= 40 ? 'conf-mid' : 'conf-low';
        var html = '<div class="queen-card queen-card-assign">';
        html += '<div class="queen-card-header">';
        html += '<span class="conf-badge conf-badge-assign"><img src="/static/bees/flying-right.svg" class="bee-icon bee-xs" alt="" style="margin-right:0.2rem">ASSIGN</span>';
        html += '<span class="conf-badge ' + confClass + '">Confidence: ' + confPct + '%</span>';
        html += '</div>';
        html += '<div class="queen-summary">' + queenSummaryLine('assignment', data) + '</div>';
        html += '<div class="mb-sm queen-text-block"><strong class="text-honey">Reasoning</strong><br>' + escapeHtml(data.reasoning) + '</div>';
        html += '<div class="mb-sm"><strong class="text-honey">Message to worker</strong></div>';
        html += '<div class="queen-code-block">' + escapeHtml(data.message) + '</div>';
        html += '</div>';
        html += '<div class="modal-footer">';
        html += '<button class="btn btn-approve" onclick="showToast(\'Approve clicked\');hideQueen();">Approve</button>';
        html += '<button class="btn btn-reject-ghost" onclick="showToast(\'Reject clicked\');hideQueen();">Reject</button>';
        html += '</div>';
        document.getElementById('queen-result').innerHTML = html;
        document.getElementById('queen-modal').style.display = 'flex';
    }

    window.fireTestModal = function(type) {
        if (type === 'escalation') showTestEscalation();
        else if (type === 'completion') showTestCompletion();
        else if (type === 'assignment') showTestAssignment();
        else if (type === 'toast') showToast('Mock notification \u2014 this is a test toast message');
    };

    // --- Integrations: Microsoft Graph ---
    function checkGraphStatus() {
        fetch('/auth/graph/status')
            .then(r => r.json())
            .then(data => {
                var el = document.getElementById('graph-status');
                var connectBtn = document.getElementById('graph-connect-btn');
                var disconnectBtn = document.getElementById('graph-disconnect-btn');
                var guide = document.getElementById('graph-setup-guide');
                var hint = document.getElementById('graph-help-hint');
                if (data.connected) {
                    el.style.borderColor = 'var(--leaf)';
                    el.innerHTML = '<span class="status-connected">&#10003; Connected</span> — email drag-and-drop will import full body + attachments';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                    if (guide) guide.removeAttribute('open');
                    if (hint) hint.style.display = 'block';
                } else if (data.configured) {
                    el.style.borderColor = 'var(--honey)';
                    el.innerHTML = '<span class="text-honey">&#9679; Not connected</span> — click <strong>Connect Microsoft Account</strong> below to sign in';
                    if (connectBtn) connectBtn.style.display = 'inline-block';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                    if (hint) hint.style.display = 'none';
                } else {
                    el.style.borderColor = 'var(--border)';
                    el.innerHTML = '<span class="status-muted">&#9675; Not configured</span> — follow the setup guide below, paste your IDs, click <strong>Save &amp; Apply</strong>, then Connect';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                    if (guide) guide.setAttribute('open', '');
                    if (hint) hint.style.display = 'none';
                }
            })
            .catch(function() {
                var el = document.getElementById('graph-status');
                if (el) el.innerHTML = '<span class="status-muted">Could not check status</span>';
            });
    }

    window.disconnectGraph = function() {
        if (!confirm('Disconnect Microsoft account? Email drag-and-drop will fall back to subject-only.')) return;
        authFetch('/auth/graph/disconnect', { method: 'POST' })
            .then(function(r) {
                if (r && r.ok) {
                    showToast('Microsoft Graph disconnected');
                    checkGraphStatus();
                }
            });
    };

    // Check status when integrations tab is first shown
    var origSwitchTab = window.switchConfigTab;
    window.switchConfigTab = function(name) {
        origSwitchTab(name);
        if (name === 'integrations') checkGraphStatus();
    };

    // --- Logs tab ---
    let logRefreshTimer = null;

    window.refreshLogs = function() {
        var level = document.getElementById('log-level-filter').value;
        var lines = document.getElementById('log-lines').value;
        var url = '/partials/logs?lines=' + lines;
        if (level) url += '&level=' + level;
        fetch(url)
            .then(function(r) { return r.text(); })
            .then(function(text) {
                var el = document.getElementById('log-output');
                el.textContent = text;
                el.scrollTop = el.scrollHeight;
            })
            .catch(function() {});
    };

    window.clearLogs = function() {
        if (!confirm('Clear the log file?')) return;
        authFetch('/action/clear-logs', { method: 'POST' })
            .then(function(r) {
                if (r && r.ok) {
                    showToast('Log cleared');
                    refreshLogs();
                }
            });
    };

    function startLogAutoRefresh() {
        if (logRefreshTimer) return;
        logRefreshTimer = setInterval(function() {
            if (document.getElementById('log-auto-refresh').checked) {
                refreshLogs();
            }
        }, 5000);
    }

    function stopLogAutoRefresh() {
        if (logRefreshTimer) { clearInterval(logRefreshTimer); logRefreshTimer = null; }
    }

    // Extend tab switcher to start/stop log auto-refresh
    var origSwitchTabForLogs = window.switchConfigTab;
    window.switchConfigTab = function(name) {
        origSwitchTabForLogs(name);
        if (name === 'logs') { refreshLogs(); startLogAutoRefresh(); }
        else { stopLogAutoRefresh(); }
    };

    // --- Usage tab ---
    let usageRefreshTimer = null;
    let usageSortCol = 5;  // default sort by cost
    let usageSortAsc = false;

    function fmtNum(n) { return n.toLocaleString(); }
    function fmtCost(n) { return '$' + n.toFixed(4); }

    window.refreshUsage = function() {
        fetch('/api/usage')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var total = data.total || {};
                document.getElementById('usage-total-cost').textContent = fmtCost(total.cost_usd || 0);
                document.getElementById('usage-total-input').textContent = fmtNum(total.input_tokens || 0);
                document.getElementById('usage-total-output').textContent = fmtNum(total.output_tokens || 0);
                document.getElementById('usage-total-tokens').textContent = fmtNum(total.total_tokens || 0);

                var totalCost = total.cost_usd || 0;
                var rows = [];
                var workers = data.workers || {};
                for (var name in workers) {
                    var w = workers[name];
                    rows.push({name: name, type: 'worker', u: w});
                }
                var queen = data.queen || {};
                rows.push({name: 'Queen', type: 'queen', u: queen});

                // Sort
                rows.sort(function(a, b) {
                    var av, bv;
                    switch (usageSortCol) {
                        case 0: av = a.name.toLowerCase(); bv = b.name.toLowerCase(); return usageSortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
                        case 1: av = a.u.input_tokens; bv = b.u.input_tokens; break;
                        case 2: av = a.u.output_tokens; bv = b.u.output_tokens; break;
                        case 3: av = a.u.cache_read_tokens; bv = b.u.cache_read_tokens; break;
                        case 4: av = a.u.cache_creation_tokens; bv = b.u.cache_creation_tokens; break;
                        case 5: av = a.u.cost_usd; bv = b.u.cost_usd; break;
                        case 6: av = totalCost ? a.u.cost_usd / totalCost : 0; bv = totalCost ? b.u.cost_usd / totalCost : 0; break;
                        default: av = 0; bv = 0;
                    }
                    return usageSortAsc ? av - bv : bv - av;
                });

                // Find max cost for highlighting
                var maxCost = 0;
                rows.forEach(function(r) { if (r.u.cost_usd > maxCost) maxCost = r.u.cost_usd; });

                var tbody = document.getElementById('usage-table-body');
                tbody.innerHTML = '';
                rows.forEach(function(r) {
                    var pct = totalCost > 0 ? ((r.u.cost_usd / totalCost) * 100).toFixed(1) : '0.0';
                    var isMax = maxCost > 0 && r.u.cost_usd === maxCost;
                    var nameStyle = r.type === 'queen' ? 'color:var(--honey);font-weight:600' : '';
                    var rowStyle = isMax ? 'background:rgba(255,200,50,0.08)' : '';
                    var tr = document.createElement('tr');
                    tr.style.cssText = rowStyle + ';border-bottom:1px solid var(--border)';
                    tr.innerHTML = '<td style="padding:0.4rem 0.6rem;' + nameStyle + '">' + r.name + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.input_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.output_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.cache_read_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + fmtNum(r.u.cache_creation_tokens || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem;font-weight:600">' + fmtCost(r.u.cost_usd || 0) + '</td>'
                        + '<td style="text-align:right;padding:0.4rem 0.6rem">' + pct + '%</td>';
                    tbody.appendChild(tr);
                });
            })
            .catch(function() {});
    };

    window.sortUsageTable = function(col) {
        if (usageSortCol === col) usageSortAsc = !usageSortAsc;
        else { usageSortCol = col; usageSortAsc = false; }
        refreshUsage();
    };

    function startUsageAutoRefresh() {
        if (usageRefreshTimer) return;
        usageRefreshTimer = setInterval(refreshUsage, 30000);
    }

    function stopUsageAutoRefresh() {
        if (usageRefreshTimer) { clearInterval(usageRefreshTimer); usageRefreshTimer = null; }
    }

    // Extend tab switcher for usage tab
    var origSwitchTabForUsage = window.switchConfigTab;
    window.switchConfigTab = function(name) {
        origSwitchTabForUsage(name);
        if (name === 'usage') { refreshUsage(); startUsageAutoRefresh(); }
        else { stopUsageAutoRefresh(); }
    };

    // File changed banner
    window.dismissBanner = function() {
        document.getElementById('file-changed-banner').style.display = 'none';
    }

    // WebSocket for file change notifications
    function connectWs() {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(proto + '//' + location.host + '/ws');
        ws.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'config_file_changed') {
                    document.getElementById('file-changed-banner').style.display = 'flex';
                }
            } catch(err) {}
        };
        ws.onclose = function() { setTimeout(connectWs, 3000); };
    }
    connectWs();
})();
</script>
{% endblock %}
