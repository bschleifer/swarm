{% for t in tasks %}
<div class="task-item" data-status="{{ t.status }}" data-worker="{{ t.assigned_worker or '' }}">
    <div class="flex-center gap-sm">
        <span class="task-status">{% if t.status == 'pending' %}<img src="/static/bees/flower.svg" class="bee-icon bee-xs" alt="" title="pending">{% elif t.status in ('assigned', 'in_progress') %}<img src="/static/bees/typing.svg" class="bee-icon bee-xs" alt="" title="{{ t.status }}">{% elif t.status == 'completed' %}<img src="/static/bees/honey-jar.svg" class="bee-icon bee-xs" alt="" title="completed">{% elif t.status == 'failed' %}<img src="/static/bees/angry.svg" class="bee-icon bee-xs" alt="" title="failed">{% else %}{{ t.status_icon }}{% endif %}</span>
        <span class="task-number">#{{ t.number }}</span>
        <span class="task-priority-{{ t.priority }}">{{ t.priority_label }}</span>
        {% if t.task_type == 'bug' %}
        <span class="type-badge type-bug">BUG</span>
        {% elif t.task_type == 'verify' %}
        <span class="type-badge type-verify">VERIFY</span>
        {% elif t.task_type == 'feature' %}
        <span class="type-badge type-feature">FEATURE</span>
        {% endif %}
        <span class="task-title">{{ t.title }}</span>
        {% if t.assigned_worker %}
        <span class="task-worker">&rarr; {{ t.assigned_worker }}</span>
        {% endif %}
        <span class="task-age">{{ t.created_age }}</span>
        {% if t.blocked %}<span title="Blocked by: {{ t.depends_on|join(', ') }}" class="task-blocked">&#x29B8;</span>{% endif %}
        {% for btn in task_buttons|default([]) %}
        {# Status-conditional visibility per action #}
        {% set show = true %}
        {% if btn.action == 'assign' and t.status != 'pending' %}{% set show = false %}{% endif %}
        {% if btn.action == 'done' and t.status not in ('assigned', 'in_progress') %}{% set show = false %}{% endif %}
        {% if btn.action == 'unassign' and t.status not in ('assigned', 'in_progress') %}{% set show = false %}{% endif %}
        {% if btn.action == 'fail' and t.status not in ('assigned', 'in_progress') %}{% set show = false %}{% endif %}
        {% if btn.action == 'reopen' and t.status not in ('completed', 'failed') %}{% set show = false %}{% endif %}
        {% if btn.action == 'retry_draft' and not (t.status == 'completed' and t.source_email_id) %}{% set show = false %}{% endif %}
        {% if show %}
        {# Mobile/desktop visibility classes #}
        {% set vis_cls = '' %}
        {% if not btn.show_mobile %}{% set vis_cls = vis_cls + ' hide-mobile' %}{% endif %}
        {% if not btn.show_desktop %}{% set vis_cls = vis_cls + ' hide-desktop' %}{% endif %}
        {# Per-action button rendering #}
        {% if btn.action == 'edit' %}
        <button class="btn btn-sm btn-secondary edit-task-btn{{ vis_cls }}"
                data-task-id="{{ t.id }}" data-task-title="{{ t.title }}"
                data-task-desc="{{ t.description }}" data-task-priority="{{ t.priority }}"
                data-task-type="{{ t.task_type }}"
                data-task-tags="{{ t.tags|join(', ') }}"
                data-task-deps="{{ t.depends_on|join(', ') }}"
                data-task-resolution="{{ t.resolution }}"
                data-task-status="{{ t.status }}"
                title="Edit task">{{ btn.label }}</button>
        {% elif btn.action == 'assign' %}
        <button class="btn btn-sm btn-secondary assign-task-btn{{ vis_cls }}" data-task-id="{{ t.id }}" data-task-title="{{ t.title }}" title="Assign to selected worker">{{ btn.label }}</button>
        {% elif btn.action == 'done' %}
        <button class="btn btn-sm btn-secondary complete-task-btn{{ vis_cls }}" data-task-id="{{ t.id }}" title="Mark complete">{{ btn.label }}</button>
        {% elif btn.action == 'unassign' %}
        <button class="btn btn-sm btn-secondary unassign-task-btn{{ vis_cls }}" data-task-id="{{ t.id }}" title="Return to pending">{{ btn.label }}</button>
        {% elif btn.action == 'fail' %}
        <button class="btn btn-sm btn-secondary fail-task-btn text-poppy{{ vis_cls }}" data-task-id="{{ t.id }}" title="Mark failed">{{ btn.label }}</button>
        {% elif btn.action == 'reopen' %}
        <button class="btn btn-sm btn-secondary reopen-task-btn{{ vis_cls }}" data-task-id="{{ t.id }}" title="Reopen task">{{ btn.label }}</button>
        {% elif btn.action == 'log' %}
        <button class="btn btn-sm btn-secondary btn-log history-task-btn{{ vis_cls }}" data-task-id="{{ t.id }}" title="Show history">{{ btn.label }}</button>
        {% elif btn.action == 'retry_draft' %}
        <button class="btn btn-sm btn-secondary btn-retry retry-draft-btn{{ vis_cls }}" data-task-id="{{ t.id }}" title="Retry creating email draft reply">{{ btn.label }}</button>
        {% elif btn.action == 'remove' %}
        <button class="btn btn-sm btn-secondary btn-remove remove-task-btn{{ vis_cls }}" data-task-id="{{ t.id }}" title="Remove task">{{ btn.label }}</button>
        {% endif %}
        {% endif %}
        {% endfor %}
    </div>
    <div class="task-history-panel" id="task-history-{{ t.id }}" style="display:none"></div>
    {% if t.resolution and t.status == 'completed' %}
    <div class="task-resolution" title="{{ t.resolution }}">{{ t.resolution }}</div>
    {% elif t.description %}
    <div class="task-desc-preview" title="{{ t.description }}">{{ t.description }}</div>
    {% endif %}
    {% if t.tags %}
    <div class="task-tags">
        {% for tag in t.tags %}
        <span class="type-badge type-tag">{{ tag }}</span>
        {% endfor %}
    </div>
    {% endif %}
    {% if t.attachments %}
    <div class="task-attachments">
        {% for a in t.attachments %}
        {% set fname = a|basename %}
        {% if fname.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.bmp', '.ico')) %}
        <a href="/uploads/{{ fname }}" target="_blank">
            <img src="/uploads/{{ fname }}" class="task-attachment-img" alt="{{ fname }}">
        </a>
        {% else %}
        <a href="/uploads/{{ fname }}" target="_blank" class="task-attachment-file">{{ fname }}</a>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endfor %}
{% if not tasks %}
<div class="empty-state"><img src="/static/bees/honeycomb.svg" class="bee-icon bee-hero" alt=""><div class="mt-sm">No tasks</div></div>
{% endif %}
{% if task_summary %}
<div data-summary="{{ task_summary }}" class="hidden"></div>
{% endif %}
